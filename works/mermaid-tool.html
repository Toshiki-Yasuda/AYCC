<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="業務フロー分析ツール - 業務フローの可視化・課題発見・AI改善提案を一気通貫で。39種のテンプレート付き。AYCCが提供する無料オンラインツール。">
    <title>業務フロー分析ツール | AYCC</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link rel="apple-touch-icon" href="../images/favicon.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- LZ-String (URL圧縮) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rose': {
                            50: '#fdf2f4',
                            100: '#fce7eb',
                            200: '#f9d0d9',
                            300: '#f4a9ba',
                            400: '#ec7a95',
                            500: '#d4a5a5',
                            600: '#b8848f',
                            700: '#9a6b75',
                            800: '#7d5660',
                            900: '#5c4048',
                        },
                        'navy': {
                            50: '#f5f7fa',
                            100: '#eaeef4',
                            200: '#d0dbe8',
                            300: '#a7bdd4',
                            400: '#7899bc',
                            500: '#5a7ea5',
                            600: '#47658a',
                            700: '#3a5270',
                            800: '#2d3e54',
                            900: '#1e2a3a',
                        },
                        'warm-gray': {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        'serif': ['Noto Serif JP', 'serif'],
                        'sans': ['Noto Sans JP', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            color: #44403c;
            letter-spacing: 0.02em;
        }

        .font-elegant {
            font-family: 'Noto Serif JP', serif;
        }

        .divider {
            width: 60px;
            height: 1px;
            background: linear-gradient(90deg, #d4a5a5, #a7bdd4);
            margin: 0 auto;
        }

        /* Elevation system */
        .elevation-0 {
            border: 1px solid rgba(168, 162, 158, 0.2);
        }

        .elevation-1 {
            border: 1px solid rgba(168, 162, 158, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .elevation-2 {
            border: 1px solid rgba(168, 162, 158, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .link-underline {
            position: relative;
        }

        .link-underline::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 1px;
            background: currentColor;
            transition: width 0.3s ease;
        }

        .link-underline:hover::after {
            width: 100%;
        }

        #mobile-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: max-height 0.6s ease-out, opacity 0.6s ease-out;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            margin-top: 0;
        }

        #mobile-menu.menu-open {
            max-height: 500px;
            opacity: 1;
        }

        #editor, #asis-editor, #tobe-editor {
            font-family: 'Courier New', Courier, monospace;
            min-height: 400px;
            background-color: #292524;
            color: #e7e5e4;
            border: 1px solid #44403c;
            padding-left: 3rem;
            line-height: 1.7;
        }

        #editor:focus, #asis-editor:focus, #tobe-editor:focus {
            border-color: #5a7ea5;
            box-shadow: 0 0 0 3px rgba(90, 126, 165, 0.15);
            outline: none;
        }

        #editor::placeholder, #asis-editor::placeholder, #tobe-editor::placeholder {
            color: #78716c;
        }

        #preview-area {
            min-height: 400px;
            overflow: auto;
        }

        #preview-area svg {
            max-width: 100%;
            height: auto;
        }

        .template-card,
        .project-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover,
        .project-card:hover {
            transform: translateY(-3px);
            border-color: rgba(168, 162, 158, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: white;
            border: 1px solid rgba(168, 162, 158, 0.2);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .accordion-header:hover {
            background: #fdf2f8;
            border-color: rgba(190, 18, 60, 0.2);
        }

        .accordion-header.active {
            background: #fdf2f8;
            border-color: rgba(190, 18, 60, 0.3);
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .accordion-chevron {
            transition: transform 0.3s ease;
            color: #78716c;
        }

        .accordion-header.active .accordion-chevron {
            transform: rotate(180deg);
            color: #be123c;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            border: 1px solid rgba(168, 162, 158, 0.2);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            background: #fafaf9;
        }

        .accordion-content.open {
            max-height: 3000px;
            opacity: 1;
        }

        .accordion-content .grid {
            padding: 1.25rem;
        }

        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        #modal.modal-open {
            display: flex;
        }

        .mode-tab {
            padding: 0.5rem 1.5rem;
            font-size: 0.8rem;
            border: 1px solid rgba(168, 162, 158, 0.3);
            color: #78716c;
            transition: all 0.3s;
            letter-spacing: 0.05em;
            border-radius: 0.375rem;
            background: white;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mode-tab:hover, .mode-tab.active {
            background-color: #292524;
            color: #fff;
            border-color: #292524;
        }

        #asis-preview svg, #tobe-preview svg {
            max-width: 100%;
            height: auto;
        }

        .phase-tab {
            padding: 0.625rem 1rem;
            font-size: 0.8rem;
            color: #78716c;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .phase-tab:hover {
            color: #44403c;
        }

        .phase-tab.active {
            color: #3a5270;
            border-bottom-color: #3a5270;
        }

        .phase-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e7e5e4;
            color: #78716c;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .phase-tab.active .phase-num {
            background: #3a5270;
            color: #fff;
        }

        /* アノテーション関連 */
        .annotation-mode .node {
            cursor: crosshair !important;
        }

        .annotation-mode .node:hover rect,
        .annotation-mode .node:hover polygon,
        .annotation-mode .node:hover circle,
        .annotation-mode .node:hover ellipse {
            stroke: #f59e0b !important;
            stroke-width: 3px !important;
            stroke-dasharray: 5 !important;
        }

        .annotation-mode .node rect,
        .annotation-mode .node polygon,
        .annotation-mode .node circle {
            animation: node-pulse 2s ease-in-out infinite;
        }

        @keyframes node-pulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.1); }
        }

        .annotated-problem rect,
        .annotated-problem polygon,
        .annotated-problem circle,
        .annotated-problem ellipse {
            stroke: #ef4444 !important;
            stroke-width: 3px !important;
        }

        .annotated-improvement rect,
        .annotated-improvement polygon,
        .annotated-improvement circle,
        .annotated-improvement ellipse {
            stroke: #3b82f6 !important;
            stroke-width: 3px !important;
        }

        .annotated-question rect,
        .annotated-question polygon,
        .annotated-question circle,
        .annotated-question ellipse {
            stroke: #f59e0b !important;
            stroke-width: 3px !important;
        }

        .annotated-memo rect,
        .annotated-memo polygon,
        .annotated-memo circle,
        .annotated-memo ellipse {
            stroke: #6b7280 !important;
            stroke-width: 3px !important;
        }

        .annotation-popup {
            position: fixed;
            z-index: 200;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e7e5e4;
            padding: 1rem;
            width: 20rem;
            max-width: 90vw;
        }

        .annotation-category-btn {
            transition: all 0.2s;
            opacity: 0.6;
        }

        .annotation-category-btn:hover {
            opacity: 0.85;
        }

        .annotation-category-btn.selected {
            opacity: 1;
            font-weight: 600;
            transform: scale(1.08);
            box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
        }

        .category-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid;
        }

        .category-badge.problem {
            background: #fef2f2;
            color: #ef4444;
            border-color: #fecaca;
        }

        .category-badge.improvement {
            background: #eff6ff;
            color: #3b82f6;
            border-color: #bfdbfe;
        }

        .category-badge.question {
            background: #fffbeb;
            color: #d97706;
            border-color: #fde68a;
        }

        .category-badge.memo {
            background: #f9fafb;
            color: #6b7280;
            border-color: #e5e7eb;
        }

        /* Annotation category buttons */
        .annotation-cat-problem { border-color: #fecaca; color: #ef4444; background: #fef2f2; }
        .annotation-cat-improvement { border-color: #bfdbfe; color: #3b82f6; background: #eff6ff; }
        .annotation-cat-question { border-color: #fde68a; color: #d97706; background: #fffbeb; }
        .annotation-cat-memo { border-color: #e5e7eb; color: #6b7280; background: #f9fafb; }

        /* Custom select */
        .select-styled {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='%2378716c' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        .select-styled:focus-visible {
            outline: 2px solid #5a7ea5;
            outline-offset: 2px;
        }

        /* Button system */
        .btn {
            font-size: 0.875rem;
            padding: 0.625rem 1.25rem;
            letter-spacing: 0.05em;
            transition: all 0.25s ease;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:focus-visible {
            outline: 2px solid #5a7ea5;
            outline-offset: 2px;
        }

        .btn-ghost {
            border: 1px solid rgba(168, 162, 158, 0.4);
            color: #57534e;
        }

        .btn-ghost:hover {
            background: #292524;
            color: #fff;
            border-color: #292524;
        }

        .btn-navy {
            border: 1px solid #7899bc;
            color: #47658a;
        }

        .btn-navy:hover {
            background: #3a5270;
            color: #fff;
            border-color: #3a5270;
        }

        .btn-rose {
            border: 1px solid #ec7a95;
            color: #b8848f;
        }

        .btn-rose:hover {
            background: #9a6b75;
            color: #fff;
            border-color: #9a6b75;
        }

        .btn-primary {
            background: #47658a;
            color: #fff;
            border: 1px solid #47658a;
        }

        .btn-primary:hover {
            background: #3a5270;
            border-color: #3a5270;
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
        }

        .btn-danger {
            border: 1px solid #fca5a5;
            color: #ef4444;
        }

        .btn-danger:hover {
            background: #ef4444;
            color: #fff;
            border-color: #ef4444;
        }

        /* Presentation */
        .pres-slide-transition {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .pres-slide-fade-out {
            opacity: 0;
            transform: scale(0.98);
        }

        .pres-nav-btn {
            backdrop-filter: blur(4px);
        }

        .pres-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pres-dot:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .pres-dot.active {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.3);
        }

        #pres-slide svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* Modal animation */
        .modal-enter {
            animation: modalIn 0.2s ease-out;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Toast animation */
        .toast-enter {
            animation: toastIn 0.3s ease-out;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, 10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        .fade-in-section {
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

    </style>
</head>
<body class="bg-warm-gray-50">

    <!-- ヘッダー -->
    <header class="bg-white/90 backdrop-blur-sm border-b border-warm-gray-200 sticky top-0 z-50">
        <nav class="container mx-auto pl-2 pr-6 py-5 relative">
            <div class="flex justify-between items-center">
                <!-- ロゴ -->
                <a href="../index.html" class="flex items-center space-x-4">
                    <img src="../images/logo.png" alt="AYCC Logo" class="h-10">
                </a>

                <!-- ナビゲーション -->
                <div class="hidden md:flex space-x-10">
                    <a href="../index.html#home" class="text-warm-gray-600 hover:text-warm-gray-900 transition-colors link-underline text-sm tracking-wider">ホーム</a>
                    <a href="../index.html#services" class="text-warm-gray-600 hover:text-warm-gray-900 transition-colors link-underline text-sm tracking-wider">サービス</a>
                    <a href="../index.html#works" class="text-warm-gray-600 hover:text-warm-gray-900 transition-colors link-underline text-sm tracking-wider">実績</a>
                    <a href="../index.html#about" class="text-warm-gray-600 hover:text-warm-gray-900 transition-colors link-underline text-sm tracking-wider">会社概要</a>
                    <a href="digital-environment.html" class="text-warm-gray-600 hover:text-warm-gray-900 transition-colors link-underline text-sm tracking-wider">開発体制</a>
                    <a href="claude-opus-4-6.html" class="text-warm-gray-600 hover:text-warm-gray-900 transition-colors link-underline text-sm tracking-wider">Opus 4.6</a>
                    <a href="../index.html#contact" class="text-warm-gray-600 hover:text-warm-gray-900 transition-colors link-underline text-sm tracking-wider">お問い合わせ</a>
                </div>

                <!-- ハンバーガーメニュー(モバイル) -->
                <button class="md:hidden" id="menu-toggle">
                    <svg class="w-6 h-6 text-warm-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <!-- モバイルメニュー -->
            <div id="mobile-menu" class="md:hidden py-4 space-y-4">
                <a href="../index.html#home" class="block py-2 text-warm-gray-600 hover:text-warm-gray-900 transition-colors text-base tracking-wider">ホーム</a>
                <a href="../index.html#services" class="block py-2 text-warm-gray-600 hover:text-warm-gray-900 transition-colors text-base tracking-wider">サービス</a>
                <a href="../index.html#works" class="block py-2 text-warm-gray-600 hover:text-warm-gray-900 transition-colors text-base tracking-wider">実績</a>
                <a href="../index.html#about" class="block py-2 text-warm-gray-600 hover:text-warm-gray-900 transition-colors text-base tracking-wider">会社概要</a>
                <a href="digital-environment.html" class="block py-2 text-warm-gray-600 hover:text-warm-gray-900 transition-colors text-base tracking-wider">開発体制</a>
                <a href="claude-opus-4-6.html" class="block py-2 text-warm-gray-600 hover:text-warm-gray-900 transition-colors text-base tracking-wider">Opus 4.6</a>
                <a href="../index.html#contact" class="block py-2 text-warm-gray-600 hover:text-warm-gray-900 transition-colors text-base tracking-wider">お問い合わせ</a>
            </div>
        </nav>
    </header>

    <!-- メインコンテンツ -->
    <main class="py-16 md:py-24">
        <div class="container mx-auto px-6">

            <!-- パンくずリスト -->
            <nav class="mb-8 text-sm text-warm-gray-500">
                <a href="../index.html" class="hover:text-warm-gray-700">ホーム</a>
                <span class="mx-2">/</span>
                <a href="../index.html#services" class="hover:text-warm-gray-700">サービス</a>
                <span class="mx-2">/</span>
                <span class="text-warm-gray-700">業務フロー分析ツール</span>
            </nav>

            <!-- タイトル -->
            <div class="text-center mb-16">
                <h1 class="font-elegant text-2xl md:text-3xl text-warm-gray-800 mb-2">
                    業務フロー分析ツール
                </h1>
                <p class="text-sm text-warm-gray-400 tracking-wider mb-6">業務フロー図を簡単に作成・編集</p>
                <div class="divider mb-10"></div>

                <!-- ツール説明 -->
                <div class="max-w-2xl mx-auto text-left mb-12">
                    <p class="text-sm text-warm-gray-600 leading-relaxed mb-4">
                        クライアントの業務フローを可視化し、課題の発見から改善提案までを一貫して行うためのツールです。
                        業種別テンプレートとClaude連携プロンプトを使って、現状（As-Is）の整理から改善後（To-Be）の設計、
                        レポート出力までをこの1ページで完結できます。
                        ぜひご自身の業務の可視化や改善にお役立てください。
                    </p>
                    <div class="flex flex-wrap items-center justify-center gap-3 text-xs text-warm-gray-400">
                        <span class="border border-warm-gray-200 px-3 py-1 rounded-full">39種テンプレート</span>
                        <span class="border border-warm-gray-200 px-3 py-1 rounded-full">As-Is / To-Be 比較</span>
                        <span class="border border-warm-gray-200 px-3 py-1 rounded-full">課題アノテーション</span>
                        <span class="border border-warm-gray-200 px-3 py-1 rounded-full">PDF / プレゼン出力</span>
                        <span class="border border-warm-gray-200 px-3 py-1 rounded-full">QR / URL共有</span>
                    </div>
                    <div class="text-center mt-4">
                        <a href="mermaid-tool-guide.html" class="text-navy-600 hover:text-navy-800 text-sm tracking-wider transition-colors">使い方ガイド →</a>
                    </div>
                </div>

                <!-- モード切替タブ -->
                <div class="flex justify-center gap-4">
                    <button id="mode-single" class="mode-tab active">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                        </svg>
                        通常モード
                    </button>
                    <button id="mode-compare" class="mode-tab">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="8" height="18" rx="1" stroke-width="2"/>
                            <rect x="13" y="3" width="8" height="18" rx="1" stroke-width="2"/>
                        </svg>
                        As-Is / To-Be 比較
                    </button>
                </div>
            </div>

            <!-- 通常モード -->
            <div id="single-mode">
            <!-- メインエリア（2カラム） -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-16">
                <!-- 左: エディタ -->
                <div class="bg-white p-6 elevation-1">
                    <div class="mb-4">
                        <label for="template-select" class="block text-sm font-medium text-warm-gray-700 mb-2">テンプレート選択</label>
                        <select id="template-select" class="w-full border border-warm-gray-300 rounded px-3 py-2 text-sm select-styled focus:outline-none focus:ring-2 focus:ring-navy-400">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <textarea id="editor" class="w-full border border-warm-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-navy-400 resize-y" placeholder="ここにMermaid記法を入力..."></textarea>
                    <div class="flex gap-3 mt-4">
                        <button id="copy-code-btn" class="btn btn-ghost">
                            コードコピー
                        </button>
                        <button id="clear-btn" class="btn btn-ghost">
                            クリア
                        </button>
                    </div>
                </div>

                <!-- 右: プレビュー -->
                <div class="bg-white p-6 elevation-1">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-warm-gray-700">プレビュー</h3>
                        <div class="flex items-center gap-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="annotation-toggle" class="sr-only peer">
                                <div class="relative w-9 h-5 bg-warm-gray-200 rounded-full peer-checked:bg-rose-400 transition-colors after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:bg-white after:rounded-full after:transition-transform peer-checked:after:translate-x-4"></div>
                                <span class="text-xs text-warm-gray-500">アノテーション</span>
                            </label>
                            <select id="theme-select" class="border border-warm-gray-300 rounded px-2 py-1 text-xs select-styled focus:outline-none">
                                <option value="default">テーマ: Default</option>
                                <option value="neutral">テーマ: Neutral</option>
                                <option value="dark">テーマ: Dark</option>
                                <option value="forest">テーマ: Forest</option>
                            </select>
                        </div>
                    </div>
                    <div id="preview-area" class="bg-white border border-warm-gray-200 rounded p-4 flex items-center justify-center min-h-[300px]">
                        <div id="preview-empty-guide" class="text-center py-8 px-4">
                            <p class="text-warm-gray-300 text-xs tracking-widest mb-6">GETTING STARTED</p>
                            <div class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-10">
                                <div class="flex flex-col items-center gap-2 max-w-[140px]">
                                    <div class="w-10 h-10 rounded-full bg-warm-gray-100 flex items-center justify-center text-warm-gray-400">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                                    </div>
                                    <span class="text-warm-gray-800 text-xs font-medium">1. テンプレート選択</span>
                                    <span class="text-warm-gray-400 text-[10px] leading-tight">左のドロップダウンまたは下のカードから選択</span>
                                </div>
                                <div class="hidden md:block text-warm-gray-300">→</div>
                                <div class="flex flex-col items-center gap-2 max-w-[140px]">
                                    <div class="w-10 h-10 rounded-full bg-warm-gray-100 flex items-center justify-center text-warm-gray-400">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                                    </div>
                                    <span class="text-warm-gray-800 text-xs font-medium">2. アノテーション</span>
                                    <span class="text-warm-gray-400 text-[10px] leading-tight">図のノードをクリックして課題を記録</span>
                                </div>
                                <div class="hidden md:block text-warm-gray-300">→</div>
                                <div class="flex flex-col items-center gap-2 max-w-[140px]">
                                    <div class="w-10 h-10 rounded-full bg-warm-gray-100 flex items-center justify-center text-warm-gray-400">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    </div>
                                    <span class="text-warm-gray-800 text-xs font-medium">3. レポート出力</span>
                                    <span class="text-warm-gray-400 text-[10px] leading-tight">PDF・プレゼンで成果をまとめる</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button id="download-png-btn" class="btn btn-ghost">
                            PNGダウンロード
                        </button>
                        <button id="download-svg-btn" class="btn btn-ghost">
                            SVGダウンロード
                        </button>
                    </div>
                    <div id="annotation-panel" class="mt-4 hidden">
                        <div id="annotation-guide-banner" class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-3 flex items-center justify-between text-xs">
                            <div class="flex items-center gap-2 text-rose-700">
                                <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span>図のノード（箱）をクリックしてアノテーションを追加できます</span>
                            </div>
                            <button id="close-annotation-guide" class="text-rose-400 hover:text-rose-600 transition-colors ml-2 shrink-0">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div id="annotation-summary" class="flex gap-2 mb-3 flex-wrap"></div>
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-medium text-warm-gray-700">アノテーション一覧</h4>
                            <div class="flex items-center gap-3">
                                <button id="generate-ai-prompt-btn" class="text-xs text-rose-600 hover:text-rose-800 transition-colors font-medium">AIプロンプト生成</button>
                                <button id="copy-annotations-md-btn" class="text-xs text-navy-600 hover:text-navy-800 transition-colors">MDコピー</button>
                                <button id="export-annotations-btn" class="text-xs text-navy-600 hover:text-navy-800 transition-colors">課題に転送 →</button>
                            </div>
                        </div>
                        <div id="annotation-list" class="space-y-2">
                            <p class="text-warm-gray-400 text-xs">アノテーションはまだありません</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- /通常モード -->

            <!-- 比較モード -->
            <div id="compare-mode" class="hidden mb-16">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- As-Is -->
                    <div class="bg-rose-50/50 rounded-xl p-4">
                        <h3 class="font-elegant text-lg text-rose-700 mb-4 text-center">As-Is（現状）</h3>
                        <div class="bg-white p-6 elevation-1 mb-4">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-warm-gray-700 mb-2">テンプレート選択</label>
                                <select id="asis-template-select" class="w-full border border-warm-gray-300 rounded px-3 py-2 text-sm select-styled focus:outline-none focus:ring-2 focus:ring-navy-400">
                                    <option value="">選択してください</option>
                                </select>
                            </div>
                            <textarea id="asis-editor" class="w-full border border-warm-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-navy-400 resize-y"  placeholder="As-Is（現状）のMermaid記法を入力..."></textarea>
                            <div class="flex gap-3 mt-3">
                                <button id="asis-copy-btn" class="btn btn-sm btn-ghost">コードコピー</button>
                                <button id="asis-clear-btn" class="btn btn-sm btn-ghost">クリア</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 elevation-1">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-medium text-warm-gray-700">プレビュー</h4>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="compare-annotation-toggle" class="sr-only peer">
                                    <div class="relative w-9 h-5 bg-warm-gray-200 rounded-full peer-checked:bg-rose-400 transition-colors after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:bg-white after:rounded-full after:transition-transform peer-checked:after:translate-x-4"></div>
                                    <span class="text-xs text-warm-gray-500">アノテーション</span>
                                </label>
                            </div>
                            <div id="asis-preview" class="bg-white border border-warm-gray-200 rounded p-4 flex items-center justify-center" style="min-height: 250px; overflow: auto;">
                                <p class="text-warm-gray-400 text-sm">As-Is図がここに表示されます</p>
                            </div>
                            <div class="flex gap-3 mt-3">
                                <button id="asis-png-btn" class="btn btn-sm btn-ghost">PNG</button>
                                <button id="asis-svg-btn" class="btn btn-sm btn-ghost">SVG</button>
                            </div>
                            <div id="asis-annotation-panel" class="mt-4 hidden">
                                <div id="asis-annotation-guide-banner" class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-3 flex items-center justify-between text-xs">
                                    <div class="flex items-center gap-2 text-rose-700">
                                        <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span>図のノード（箱）をクリックしてアノテーションを追加できます</span>
                                    </div>
                                    <button id="close-asis-annotation-guide" class="text-rose-400 hover:text-rose-600 transition-colors ml-2 shrink-0">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                <div id="compare-annotation-summary" class="flex gap-2 mb-3 flex-wrap"></div>
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-medium text-warm-gray-700">アノテーション一覧</h4>
                                    <div class="flex items-center gap-3">
                                        <button id="compare-generate-ai-prompt-btn" class="text-xs text-rose-600 hover:text-rose-800 transition-colors font-medium">AIプロンプト生成</button>
                                        <button id="compare-copy-annotations-md-btn" class="text-xs text-navy-600 hover:text-navy-800 transition-colors">MDコピー</button>
                                    </div>
                                </div>
                                <div id="asis-annotation-list" class="space-y-2">
                                    <p class="text-warm-gray-400 text-xs">アノテーションはまだありません</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- To-Be -->
                    <div class="bg-navy-50/50 rounded-xl p-4">
                        <h3 class="font-elegant text-lg text-navy-700 mb-4 text-center">To-Be（改善後）</h3>
                        <div class="bg-white p-6 elevation-1 mb-4">
                            <div class="mb-4">
                                <button id="copy-asis-to-tobe" class="w-full btn btn-navy">
                                    ← As-Isからコピーして編集
                                </button>
                            </div>
                            <textarea id="tobe-editor" class="w-full border border-warm-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-navy-400 resize-y"  placeholder="To-Be（改善後）のMermaid記法を入力..."></textarea>
                            <div class="flex gap-3 mt-3">
                                <button id="tobe-copy-btn" class="btn btn-sm btn-ghost">コードコピー</button>
                                <button id="tobe-clear-btn" class="btn btn-sm btn-ghost">クリア</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 elevation-1">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-medium text-warm-gray-700">プレビュー</h4>
                            </div>
                            <div id="tobe-preview" class="bg-white border border-warm-gray-200 rounded p-4 flex items-center justify-center" style="min-height: 250px; overflow: auto;">
                                <p class="text-warm-gray-400 text-sm">To-Be図がここに表示されます</p>
                            </div>
                            <div class="flex gap-3 mt-3">
                                <button id="tobe-png-btn" class="btn btn-sm btn-ghost">PNG</button>
                                <button id="tobe-svg-btn" class="btn btn-sm btn-ghost">SVG</button>
                            </div>
                            <div id="tobe-annotation-panel" class="mt-4 hidden">
                                <div id="tobe-annotation-guide-banner" class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-3 flex items-center justify-between text-xs">
                                    <div class="flex items-center gap-2 text-rose-700">
                                        <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span>図のノード（箱）をクリックしてアノテーションを追加できます</span>
                                    </div>
                                    <button id="close-tobe-annotation-guide" class="text-rose-400 hover:text-rose-600 transition-colors ml-2 shrink-0">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                <div id="tobe-annotation-summary" class="flex gap-2 mb-3 flex-wrap"></div>
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-medium text-warm-gray-700">アノテーション一覧</h4>
                                    <button id="export-compare-annotations-btn" class="text-xs text-navy-600 hover:text-navy-800 transition-colors">課題に転送 →</button>
                                </div>
                                <div id="tobe-annotation-list" class="space-y-2">
                                    <p class="text-warm-gray-400 text-xs">アノテーションはまだありません</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- テーマ選択（比較モード用、2つの図に共通適用） -->
                <div class="flex justify-center mt-6 gap-4 flex-wrap items-center">
                    <select id="compare-theme-select" class="border border-warm-gray-300 rounded px-3 py-1.5 text-xs select-styled focus:outline-none">
                        <option value="default">テーマ: Default</option>
                        <option value="neutral">テーマ: Neutral</option>
                        <option value="dark">テーマ: Dark</option>
                        <option value="forest">テーマ: Forest</option>
                    </select>
                </div>
            </div>
            <!-- /比較モード -->

            <!-- レポート出力（両モード共通） -->
            <div class="flex justify-center gap-4 flex-wrap items-center mb-16 mt-8">
                <button id="pdf-report-btn" class="btn btn-rose rounded">
                    PDFレポート出力
                </button>
                <button id="presentation-btn" class="btn btn-navy rounded">
                    プレゼンテーション
                </button>
            </div>

            <!-- 保存セクション -->
            <div class="mb-16 pt-16 border-t border-warm-gray-200 fade-in-section">
                <div class="bg-warm-gray-50 p-6 elevation-0 rounded-lg">
                    <div class="flex flex-wrap items-center gap-4">
                        <input id="project-name" type="text" placeholder="プロジェクト名を入力" class="border border-warm-gray-300 rounded px-3 py-2 text-sm flex-1 min-w-[200px] focus:outline-none focus:ring-2 focus:ring-navy-400">
                        <button id="save-btn" class="btn btn-ghost">保存</button>
                        <button id="share-url-btn" class="btn btn-navy">共有</button>
                    </div>
                </div>
            </div>

            <!-- 保存済みプロジェクト一覧 -->
            <div id="saved-projects" class="mb-16 hidden fade-in-section">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-elegant text-lg text-warm-gray-800">
                        保存済みプロジェクト<span id="project-count" class="text-warm-gray-400 text-sm ml-1"></span>
                    </h3>
                    <button id="import-json-btn" class="btn btn-sm btn-ghost">
                        JSONインポート
                    </button>
                </div>
                <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- 隠しファイルインプット -->
            <input type="file" id="import-json-input" accept=".json" class="hidden">

            <!-- テンプレートセクション -->
            <div class="mb-16 fade-in-section -mx-6 px-6 py-16 bg-white border-t border-b border-warm-gray-100">
                <div class="text-center mb-10">
                    <h2 class="font-elegant text-xl md:text-2xl text-warm-gray-800 mb-2">
                        業種別テンプレート
                    </h2>
                    <p class="text-sm text-warm-gray-500 mb-4">カードをクリックしてテンプレートを適用</p>
                    <div class="divider"></div>
                    <!-- Template search -->
                    <div class="max-w-md mx-auto mt-6">
                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-warm-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="text" id="template-search" placeholder="テンプレートを検索（業種名・図の種類...）" class="w-full pl-10 pr-4 py-2.5 border border-warm-gray-300 rounded-lg text-sm text-warm-gray-700 focus:outline-none focus:border-navy-400 focus:ring-1 focus:ring-navy-400 transition-colors">
                        </div>
                    </div>
                    <p id="template-search-empty" class="text-center text-warm-gray-400 text-sm mt-6 hidden">該当するテンプレートがありません</p>
                </div>

                <div id="template-accordion" class="space-y-3"></div>
            </div>

        </div>
    </main>

    <!-- ヒアリングプロンプトモーダル -->
    <div id="modal">
        <div class="bg-white rounded-lg max-w-3xl mx-4 elevation-2 max-h-[85vh] flex flex-col overflow-hidden">
            <!-- ヘッダー -->
            <div class="p-6 pb-0">
                <h3 class="font-elegant text-lg text-warm-gray-800 mb-4" id="modal-title">ヒアリングプロンプト</h3>
                <!-- フェーズタブ -->
                <div class="flex gap-0 border-b border-warm-gray-200">
                    <button class="phase-tab active" data-phase="1">
                        <span class="phase-num">1</span> 現状把握
                    </button>
                    <button class="phase-tab" data-phase="2">
                        <span class="phase-num">2</span> 課題分析
                    </button>
                    <button class="phase-tab" data-phase="3">
                        <span class="phase-num">3</span> 改善提案
                    </button>
                </div>
            </div>

            <!-- コンテンツ -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Phase 1 -->
                <div id="phase1-content" class="phase-content">
                    <p class="text-xs text-navy-600 bg-navy-50 p-3 rounded mb-4">Claudeに投げるとヒアリング質問リストが返ってきます</p>
                    <div id="phase1-text" class="text-sm text-warm-gray-600 leading-relaxed whitespace-pre-wrap"></div>
                </div>
                <!-- Phase 2 -->
                <div id="phase2-content" class="phase-content hidden">
                    <p class="text-xs text-navy-600 bg-navy-50 p-3 rounded mb-4">As-Isエディタの内容が自動で埋め込まれます。Claudeに投げると課題分析が返ってきます</p>
                    <div id="phase2-text" class="text-sm text-warm-gray-600 leading-relaxed whitespace-pre-wrap font-mono text-xs"></div>
                </div>
                <!-- Phase 3 -->
                <div id="phase3-content" class="phase-content hidden">
                    <p class="text-xs text-navy-600 bg-navy-50 p-3 rounded mb-4">課題を入力するとプロンプトに自動反映されます。Claudeに投げるとTo-Be図が返ってきます</p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-warm-gray-700 mb-2">発見された課題（箇条書き）</label>
                        <textarea id="issues-input" class="w-full border border-warm-gray-300 rounded px-3 py-2 text-sm min-h-[100px] focus:outline-none focus:ring-2 focus:ring-navy-400" placeholder="例:&#10;- 予約の二重管理（紙+デジタル）&#10;- キャンセル連絡の遅延&#10;- 承認者不在時の停滞"></textarea>
                    </div>
                    <div id="phase3-text" class="text-sm text-warm-gray-600 leading-relaxed whitespace-pre-wrap font-mono text-xs"></div>
                </div>
            </div>

            <!-- フッター -->
            <div class="flex gap-3 p-6 pt-4 border-t border-warm-gray-200">
                <button id="copy-prompt-btn" class="btn btn-ghost">
                    プロンプトをコピー
                </button>
                <button id="close-modal-btn" class="btn btn-primary">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <!-- プレゼンテーションモード -->
    <div id="presentation-overlay" class="hidden fixed inset-0 z-[300] bg-warm-gray-900 flex flex-col">
        <!-- ヘッダー -->
        <div class="flex items-center justify-between px-4 md:px-8 py-3">
            <span class="text-warm-gray-400 text-sm truncate max-w-[200px]" id="pres-title"></span>
            <div class="flex items-center gap-4">
                <span class="text-warm-gray-500 text-xs" id="pres-page-indicator">1 / 5</span>
                <button id="pres-close" class="text-warm-gray-400 hover:text-white transition-colors p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>

        <!-- スライドコンテンツ -->
        <div class="flex-1 flex items-center justify-center px-4 md:px-8 pb-4 relative min-h-0">
            <!-- 前へボタン -->
            <button id="pres-prev" class="pres-nav-btn absolute left-2 md:left-6 top-1/2 -translate-y-1/2 w-10 h-10 md:w-12 md:h-12 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all z-10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>

            <div id="pres-slide" class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full overflow-auto p-6 md:p-12 pres-slide-transition" style="max-height:calc(100vh - 7rem)">
                <!-- スライド内容がここに動的挿入 -->
            </div>

            <!-- 次へボタン -->
            <button id="pres-next" class="pres-nav-btn absolute right-2 md:right-6 top-1/2 -translate-y-1/2 w-10 h-10 md:w-12 md:h-12 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all z-10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>

        <!-- ドットナビゲーション -->
        <div class="flex justify-center gap-2 pb-4" id="pres-dots"></div>
    </div>

    <!-- アノテーション追加ポップアップ -->
    <div id="annotation-popup" class="hidden">
        <div class="bg-white rounded-lg shadow-xl border border-warm-gray-200 p-4 w-80">
            <h4 class="text-sm font-medium text-warm-gray-800 mb-3">アノテーション追加</h4>
            <p id="annotation-node-name" class="text-xs text-warm-gray-500 mb-3 bg-warm-gray-50 px-2 py-1 rounded"></p>
            <div class="flex gap-2 mb-3 flex-wrap">
                <button class="annotation-category-btn text-xs px-3 py-1.5 rounded-full border annotation-cat-problem" data-category="problem">問題点</button>
                <button class="annotation-category-btn text-xs px-3 py-1.5 rounded-full border annotation-cat-improvement" data-category="improvement">改善案</button>
                <button class="annotation-category-btn text-xs px-3 py-1.5 rounded-full border annotation-cat-question" data-category="question">質問</button>
                <button class="annotation-category-btn text-xs px-3 py-1.5 rounded-full border annotation-cat-memo" data-category="memo">メモ</button>
            </div>
            <textarea id="annotation-comment" class="w-full border border-warm-gray-300 rounded px-3 py-2 text-sm min-h-[80px] focus:outline-none focus:ring-2 focus:ring-navy-400 mb-3" placeholder="コメントを入力..."></textarea>
            <div class="flex gap-2 justify-end">
                <button id="annotation-cancel" class="text-xs text-warm-gray-500 px-3 py-1.5">キャンセル</button>
                <button id="annotation-add" class="btn btn-sm btn-primary rounded">追加</button>
            </div>
        </div>
    </div>

    <!-- 共有モーダル -->
    <div id="share-modal" class="fixed inset-0 z-[200] hidden" style="background: rgba(0,0,0,0.5);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-lg w-full elevation-2 overflow-hidden">
                <div class="p-6 pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-elegant text-lg text-warm-gray-800">プロジェクトを共有</h3>
                        <button id="close-share-modal" class="text-warm-gray-400 hover:text-warm-gray-600 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- URL共有 -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-warm-gray-700 mb-2">URL共有</h4>
                        <p class="text-xs text-warm-gray-400 mb-2">このURLを共有すると、同じ図を開けます</p>
                        <div class="flex gap-2">
                            <input id="share-url-display" type="text" readonly class="flex-1 border border-warm-gray-300 rounded px-3 py-2 text-xs bg-warm-gray-50 text-warm-gray-600 focus:outline-none">
                            <button id="copy-share-url" class="btn btn-sm btn-ghost whitespace-nowrap">コピー</button>
                        </div>
                        <p id="share-url-size" class="text-xs text-warm-gray-300 mt-1"></p>
                    </div>

                    <!-- QRコード -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-warm-gray-700 mb-2">QRコード</h4>
                        <p class="text-xs text-warm-gray-400 mb-2">スマートフォンで読み取って共有できます</p>
                        <div class="flex justify-center">
                            <div id="share-qr-code" class="bg-white p-3 border border-warm-gray-200 rounded inline-block"></div>
                        </div>
                        <div class="flex justify-center mt-2">
                            <button id="download-qr" class="text-xs text-navy-600 hover:text-navy-800 transition-colors">QRコードをダウンロード</button>
                        </div>
                    </div>

                    <!-- JSON共有 -->
                    <div>
                        <h4 class="text-sm font-medium text-warm-gray-700 mb-2">ファイル共有</h4>
                        <p class="text-xs text-warm-gray-400 mb-2">プロジェクト全体（アノテーション含む）をファイルで共有</p>
                        <button id="share-json-export" class="w-full btn btn-navy">
                            JSONファイルをダウンロード
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-warm-gray-800 text-warm-gray-300 py-12">
        <div class="container mx-auto px-6">
            <div class="text-center">
                <p class="text-sm tracking-wider mb-2">
                    &copy; 2026 AYCC
                </p>
                <p class="text-xs text-warm-gray-500">
                    AI YASUDA CREATIVE & CONSULTING
                </p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // プレビュー空状態のHTML
        const PREVIEW_EMPTY_HTML = `
            <div id="preview-empty-guide" class="text-center py-8 px-4">
                <p class="text-warm-gray-300 text-xs tracking-widest mb-6">GETTING STARTED</p>
                <div class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-10">
                    <div class="flex flex-col items-center gap-2 max-w-[140px]">
                        <div class="w-10 h-10 rounded-full bg-warm-gray-100 flex items-center justify-center text-warm-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        </div>
                        <span class="text-warm-gray-800 text-xs font-medium">1. テンプレート選択</span>
                        <span class="text-warm-gray-400 text-[10px] leading-tight">左のドロップダウンまたは下のカードから選択</span>
                    </div>
                    <div class="hidden md:block text-warm-gray-300">→</div>
                    <div class="flex flex-col items-center gap-2 max-w-[140px]">
                        <div class="w-10 h-10 rounded-full bg-warm-gray-100 flex items-center justify-center text-warm-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                        </div>
                        <span class="text-warm-gray-800 text-xs font-medium">2. アノテーション</span>
                        <span class="text-warm-gray-400 text-[10px] leading-tight">図のノードをクリックして課題を記録</span>
                    </div>
                    <div class="hidden md:block text-warm-gray-300">→</div>
                    <div class="flex flex-col items-center gap-2 max-w-[140px]">
                        <div class="w-10 h-10 rounded-full bg-warm-gray-100 flex items-center justify-center text-warm-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <span class="text-warm-gray-800 text-xs font-medium">3. レポート出力</span>
                        <span class="text-warm-gray-400 text-[10px] leading-tight">PDF・プレゼンで成果をまとめる</span>
                    </div>
                </div>
            </div>
        `;

        const PREVIEW_LOADING_HTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-8 w-8 border-2 border-warm-gray-300 border-t-rose-400"></div></div>';

        const templates = [
            {
                name: '飲食業：予約→来店フロー',
                industry: '飲食業',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h18v2H3v-2zm7 4l-4 4h3v3h2v-3h3l-4-4z',
                mermaid: `flowchart TD
    A[予約受付] --> B{予約方法}
    B -->|電話| C[電話対応]
    B -->|Web| D[Web予約フォーム]
    B -->|アプリ| E[アプリ予約]
    C --> F[予約台帳に記録]
    D --> F
    E --> F
    F --> G[前日リマインド]
    G --> H{来店}
    H -->|来店| I[席案内]
    H -->|キャンセル| J[キャンセル処理]
    I --> K[注文・提供]
    K --> L[会計]
    L --> M[アンケート・フォロー]`,
                prompt: {
                    phase1: 'あなたは飲食業の業務フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①予約経路（電話/Web/アプリ/SNS）②キャンセルポリシー ③当日のオペレーション（受付→配席→注文→提供→会計）④リピート施策',
                    phase2: `あなたは飲食業の業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥予約とキャンセルの管理方法の課題
⑦ピーク時のオペレーション負荷

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは飲食業の業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 予約システムの一元化（予約台帳のデジタル化）
- リマインド・キャンセル対応の自動化
- 顧客データベース構築によるリピーター管理
- モバイルオーダー導入による注文効率化
- レビュー収集の自動化

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '音楽教室：入会→レッスン開始フロー',
                industry: '音楽教室',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z',
                mermaid: `flowchart TD
    A[問い合わせ] --> B[体験レッスン予約]
    B --> C[体験レッスン実施]
    C --> D{入会意思}
    D -->|入会| E[入会手続き]
    D -->|検討| F[フォロー連絡]
    D -->|辞退| G[お礼連絡]
    F --> D
    E --> H[月謝設定]
    H --> I[レッスン曜日・時間決定]
    I --> J[初回レッスン]
    J --> K[定期レッスン開始]`,
                prompt: {
                    phase1: 'あなたは音楽教室の運営フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①問い合わせ経路 ②体験レッスンの流れ ③入会手続き ④月謝の支払い方法 ⑤レッスンスケジュール管理 ⑥発表会・イベント運営',
                    phase2: `あなたは音楽教室の業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥体験レッスンからの入会率が低い要因
⑦月謝管理や入金確認の課題

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは音楽教室の業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 予約システムの導入（体験レッスン・通常レッスン）
- 自動リマインド・フォローアップメール
- 月謝のオンライン決済導入
- 生徒管理システムによる進捗記録
- 発表会申込の電子化

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '小売・EC：注文→配送フロー',
                industry: '小売・EC',
                category: 'industry',
                diagramType: 'sequence',
                icon: 'M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z',
                mermaid: `sequenceDiagram
    participant C as 顧客
    participant S as ECサイト
    participant W as 倉庫
    participant D as 配送業者
    C->>S: 商品注文
    S->>S: 在庫確認
    S->>C: 注文確認メール
    S->>W: 出荷指示
    W->>W: ピッキング・梱包
    W->>D: 配送依頼
    D->>C: 配送通知
    D->>C: 商品お届け
    C->>S: 受取確認`,
                prompt: {
                    phase1: 'あなたはEC・小売業の業務フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①注文受付チャネル ②在庫管理方法 ③決済手段 ④出荷・配送フロー ⑤返品・交換対応 ⑥顧客フォロー',
                    phase2: `あなたは小売・ECの業務改善コンサルタントです。以下のMermaidシーケンス図はクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥在庫の精度・リアルタイム性の課題
⑦ピッキングミス・配送遅延の要因

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは小売・ECの業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- リアルタイム在庫連携システム導入
- 倉庫管理システム（WMS）による自動ピッキング指示
- 配送業者API連携による追跡情報の自動通知
- 返品・交換のオンライン受付
- 顧客レビュー自動収集

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '医療・クリニック：患者受付→診察フロー',
                industry: '医療・クリニック',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z',
                mermaid: `flowchart TD
    A[来院・受付] --> B{初診/再診}
    B -->|初診| C[問診票記入]
    B -->|再診| D[診察券確認]
    C --> E[保険証確認]
    D --> E
    E --> F[待合室]
    F --> G[診察]
    G --> H{検査必要}
    H -->|あり| I[検査実施]
    H -->|なし| J[診断・処方]
    I --> J
    J --> K[会計]
    K --> L[薬局案内]
    L --> M[次回予約]`,
                prompt: {
                    phase1: 'あなたは医療機関の業務フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①予約システム ②受付フロー（初診/再診）③問診・診察の流れ ④検査フロー ⑤会計・レセプト ⑥次回予約・フォロー',
                    phase2: `あなたは医療・クリニックの業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥待ち時間が発生する要因
⑦問診票や保険証確認の効率化余地

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは医療・クリニックの業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- Web予約システム・順番管理システム導入
- 問診票のタブレット入力
- 電子カルテとの連携
- 自動精算機の導入
- 検査結果のオンライン閲覧

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '不動産：物件問い合わせ→契約フロー',
                industry: '不動産',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z',
                mermaid: `flowchart TD
    A[物件問い合わせ] --> B[条件ヒアリング]
    B --> C[物件提案]
    C --> D[内見予約]
    D --> E[内見実施]
    E --> F{申込意思}
    F -->|申込| G[入居申込]
    F -->|再検討| C
    G --> H[審査]
    H -->|通過| I[契約手続き]
    H -->|否決| J[再提案]
    I --> K[重要事項説明]
    K --> L[契約締結]
    L --> M[鍵引渡し・入居]`,
                prompt: {
                    phase1: 'あなたは不動産業の業務フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①集客チャネル（ポータル/自社サイト/来店）②条件ヒアリング項目 ③内見フロー ④申込→審査 ⑤契約手続き ⑥入居後フォロー',
                    phase2: `あなたは不動産業の業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥問い合わせから内見までのリードタイム
⑦審査・契約の書類作業の煩雑さ

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは不動産業の業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 顧客管理システム（CRM）導入による条件マッチング自動化
- オンライン内見・VR内見の導入
- 電子申込・電子審査システム
- IT重説・電子契約の導入
- 入居後サポートのチャットボット化

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: 'IT/Web制作：システム開発フロー',
                industry: 'IT/Web制作',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h3l-1 1v2h12v-2l-1-1h3c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 13H4V5h16v11z M9.5 8.5l-2 2 2 2V14l-3-3 3-3zm5 0v1.5l2 2-2 2V14l3-3-3-3z',
                mermaid: `flowchart TD
    A[要件ヒアリング] --> B[要件定義書作成]
    B --> C[見積・提案]
    C --> D{受注}
    D -->|受注| E[設計]
    D -->|失注| F[フィードバック記録]
    E --> G[開発]
    G --> H[テスト]
    H --> I{検収}
    I -->|OK| J[本番リリース]
    I -->|修正| G
    J --> K[運用・保守]`,
                prompt: {
                    phase1: 'あなたはIT/Web制作の業務フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①要件定義の進め方 ②開発体制 ③テスト方針 ④リリースフロー ⑤運用・保守体制 ⑥変更管理',
                    phase2: `あなたはIT/Web制作の業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥要件定義の精度向上余地
⑦テスト・リリースの手戻り要因

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたはIT/Web制作の業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 要件管理ツール（Jira/Notion等）の導入
- アジャイル開発への移行
- CI/CDパイプライン構築による自動テスト・デプロイ
- コードレビュー・ペアプログラミングの導入
- ドキュメント自動生成

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '製造業：受注→出荷フロー',
                industry: '製造業',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M12 2l-5.5 9h11L12 2zm0 3.84L13.93 9h-3.87L12 5.84zM17.5 13c-2.49 0-4.5 2.01-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.01 4.5-4.5-2.01-4.5-4.5-4.5zm0 7c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5zM3 21.5h8v-8H3v8zm2-6h4v4H5v-4z',
                mermaid: `flowchart TD
    A[受注] --> B[生産計画]
    B --> C[資材調達]
    C --> D[製造]
    D --> E[品質検査]
    E --> F{合格}
    F -->|合格| G[梱包]
    F -->|不合格| H[手直し・再検査]
    H --> E
    G --> I[出荷]
    I --> J[納品]
    J --> K[請求]`,
                prompt: {
                    phase1: 'あなたは製造業の業務フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①受注管理方法 ②生産計画の立て方 ③資材調達フロー ④製造工程 ⑤品質管理 ⑥出荷・納品フロー',
                    phase2: `あなたは製造業の業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥生産計画の精度と柔軟性の課題
⑦品質検査の手戻り削減余地

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは製造業の業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 生産管理システム導入による計画最適化
- IoTセンサーによる工程監視・予知保全
- 資材発注の自動化
- AI検査による不良品検出精度向上
- トレーサビリティシステム構築

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '士業（税理士等）：顧問契約→月次対応フロー',
                industry: '士業',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M14 6l-4.22 5.63 1.25 1.67L14 9.33 19 16h-8.46l-4.01-5.37L1 18h22L14 6zM5 16l1.52-2.03L8.04 16H5z',
                mermaid: `flowchart TD
    A[初回相談] --> B[業務範囲確認]
    B --> C[見積提示]
    C --> D{契約}
    D -->|契約| E[顧問契約締結]
    D -->|見送り| F[フォロー]
    E --> G[月次データ受領]
    G --> H[仕訳・記帳]
    H --> I[月次報告]
    I --> J[決算準備]
    J --> K[確定申告・届出]
    K --> L[年次報告]`,
                prompt: {
                    phase1: 'あなたは士業（税理士・会計士等）の業務フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①顧問契約の範囲 ②月次の資料受領方法 ③記帳・仕訳フロー ④月次報告 ⑤決算・申告スケジュール ⑥顧客とのコミュニケーション方法',
                    phase2: `あなたは士業（税理士等）の業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥資料収集の遅延要因
⑦記帳業務の効率化余地

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは士業（税理士等）の業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- クラウド会計システム導入による資料共有自動化
- OCR・AIによる領収書自動読取・仕訳
- 顧問先ポータルによる月次報告の可視化
- 電子申告の完全移行
- チャット・オンラインMTGの活用

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '美容・サロン：予約→施術→フォローフロー',
                industry: '美容・サロン',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M12.87 15.07l-2.54-2.51.03-.03A6.007 6.007 0 0014 7c0-3.31-2.69-6-6-6S2 3.69 2 7s2.69 6 6 6c1.66 0 3.14-.69 4.22-1.78l.03-.03 2.51 2.54c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-.03-.03 3.59 3.59c.39.39.39 1.02 0 1.41-.19.19-.44.29-.71.29s-.51-.1-.71-.29l-3.59-3.59zm-8.95-4.34l-.64-.64 1.41-1.41.64.64c.39.39.39 1.02 0 1.41-.38.4-1.01.4-1.41 0z',
                mermaid: `flowchart TD
    A[予約] --> B{予約方法}
    B -->|電話| C[電話受付]
    B -->|Web| D[Web予約]
    B -->|SNS| E[SNS予約]
    C --> F[来店受付]
    D --> F
    E --> F
    F --> G[カウンセリング]
    G --> H[施術]
    H --> I[仕上がり確認]
    I --> J[会計]
    J --> K[次回予約提案]
    K --> L[アフターフォロー]`,
                prompt: {
                    phase1: 'あなたは美容・サロン業の業務フロー設計の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①予約チャネル ②カウンセリング内容 ③施術メニュー管理 ④会計・決済 ⑤リピート促進策 ⑥SNS活用',
                    phase2: `あなたは美容・サロン業の業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥予約管理の煩雑さ・ダブルブッキングのリスク
⑦顧客情報（施術履歴・好み）の活用不足

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは美容・サロン業の業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 予約システム導入による空き状況リアルタイム管理
- 顧客カルテのデジタル化（施術履歴・アレルギー等）
- キャッシュレス決済・事前決済導入
- LINE公式アカウントによる次回予約促進
- 口コミ・写真投稿の自動収集

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '汎用：承認ワークフロー',
                industry: '汎用',
                category: 'industry',
                diagramType: 'flowchart',
                icon: 'M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z',
                mermaid: `flowchart TD
    A[申請作成] --> B[上長に提出]
    B --> C{一次承認}
    C -->|承認| D[部長に回付]
    C -->|差戻| E[修正・再提出]
    E --> B
    D --> F{最終承認}
    F -->|承認| G[処理実行]
    F -->|差戻| E
    G --> H[完了通知]
    H --> I[記録保存]`,
                prompt: {
                    phase1: 'あなたは業務改善の専門家です。承認ワークフローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①申請の種類 ②承認ステップ数 ③各ステップの承認者 ④差戻し時のフロー ⑤緊急時の対応 ⑥通知方法',
                    phase2: `あなたは業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥承認者不在時の停滞問題
⑦紙ベース・メール承認の非効率性

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- ワークフローシステム導入（kintone/Slack等）
- 代理承認者の設定
- 金額による自動ルーティング
- 承認通知の自動化
- ダッシュボードによる進捗可視化

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '採用フロー',
                industry: '汎用（人事）',
                category: 'general',
                diagramType: 'flowchart',
                icon: 'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z',
                mermaid: `flowchart TD
    A[募集開始] --> B[応募受付]
    B --> C[書類選考]
    C --> D{書類結果}
    D -->|通過| E[一次面接]
    D -->|不合格| F[お祈りメール]
    E --> G{一次結果}
    G -->|通過| H[二次面接]
    G -->|不合格| F
    H --> I{最終結果}
    I -->|内定| J[内定通知]
    I -->|不合格| F
    J --> K[入社手続き]
    K --> L[オンボーディング]`,
                prompt: {
                    phase1: 'あなたは人事採用の専門家です。採用フローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①募集チャネル（求人サイト/紹介/リファラル）②書類選考の基準 ③面接の段階と各面接官 ④内定承諾率向上施策 ⑤オンボーディングプログラム ⑥試用期間の評価方法',
                    phase2: `あなたは人事採用の業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥応募から面接までのリードタイム
⑦内定辞退率が高い要因

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは人事採用の業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 採用管理システム（ATS）導入
- 書類選考の自動スクリーニング（AI活用）
- オンライン面接・録画面接の導入
- 候補者体験（CX）の向上施策
- オンボーディングのデジタル化

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: 'クレーム対応フロー',
                industry: '汎用（CS）',
                category: 'general',
                diagramType: 'flowchart',
                icon: 'M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z',
                mermaid: `flowchart TD
    A[クレーム受付] --> B[内容記録]
    B --> C[緊急度判定]
    C --> D{緊急度}
    D -->|高| E[責任者即対応]
    D -->|中| F[担当者振分]
    D -->|低| G[通常対応]
    E --> H[原因調査]
    F --> H
    G --> H
    H --> I[対応策決定]
    I --> J[顧客へ回答]
    J --> K[フォロー連絡]
    K --> L[記録・共有]`,
                prompt: {
                    phase1: 'あなたはカスタマーサポートの専門家です。クレーム対応フローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①受付チャネル（電話/メール/SNS）②緊急度の判定基準 ③エスカレーションルール ④対応期限の設定 ⑤顧客満足度の測定方法 ⑥再発防止策の仕組み',
                    phase2: `あなたはカスタマーサポートの業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥初動対応の遅延要因
⑦クレーム情報の共有・蓄積不足

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたはカスタマーサポートの業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 問い合わせ管理システム導入（zendesk等）
- チャットボットによる一次対応自動化
- SLA（対応期限）の明確化と自動アラート
- ナレッジベース構築による対応品質向上
- クレーム分析ダッシュボード

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '営業リード管理',
                industry: '汎用（営業）',
                category: 'general',
                diagramType: 'flowchart',
                icon: 'M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z',
                mermaid: `flowchart TD
    A[リード獲得] --> B[情報登録]
    B --> C[スコアリング]
    C --> D{ホット度}
    D -->|ホット| E[即座に商談]
    D -->|ウォーム| F[ナーチャリング]
    D -->|コールド| G[中長期フォロー]
    F --> H[定期接触]
    H --> I[商談機会]
    E --> I
    I --> J[提案・見積]
    J --> K{成約}
    K -->|成約| L[受注処理]
    K -->|失注| M[失注理由分析]
    L --> N[アフターフォロー]`,
                prompt: {
                    phase1: 'あなたは営業プロセス設計の専門家です。営業リード管理について以下のポイントをヒアリングし、Mermaid図を作成してください：①リード獲得方法（展示会/Web/紹介）②スコアリング基準 ③ナーチャリング手法（メルマガ/セミナー）④商談から提案までの期間 ⑤成約率の目標値 ⑥失注分析の活用方法',
                    phase2: `あなたは営業プロセスの業務改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥リードの取りこぼし・放置問題
⑦商談化率・成約率の低さの要因

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは営業プロセスの業務改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- CRM/SFA導入によるリード一元管理
- マーケティングオートメーション連携
- スコアリング・ナーチャリングの自動化
- 商談管理の可視化（パイプライン管理）
- 失注分析による改善PDCAサイクル

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: '経費精算ワークフロー',
                industry: '汎用（経理）',
                category: 'general',
                diagramType: 'flowchart',
                icon: 'M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z',
                mermaid: `flowchart TD
    A[経費申請] --> B[領収書添付]
    B --> C[上長承認]
    C --> D{承認結果}
    D -->|承認| E[経理確認]
    D -->|差戻| F[修正・再申請]
    F --> C
    E --> G{確認結果}
    G -->|OK| H[支払処理]
    G -->|不備| F
    H --> I[振込実行]
    I --> J[記帳処理]
    J --> K[完了通知]`,
                prompt: {
                    phase1: 'あなたは経理業務の専門家です。経費精算ワークフローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①経費の種類（交通費/交際費/消耗品等）②申請期限の設定 ③承認者の設定ルール ④領収書の電子化方法 ⑤支払サイクル ⑥会計システムとの連携',
                    phase2: `あなたは経理業務の改善コンサルタントです。以下のMermaidフローチャートはクライアントの現在の業務フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このフローについて以下の観点で分析してください：
①ボトルネックになっている箇所
②手動作業で自動化できる箇所
③データが断絶している箇所
④冗長・重複している工程
⑤リスクが潜んでいる箇所
⑥紙の領収書管理の煩雑さ
⑦承認・確認の差戻しによる遅延

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは経理業務の改善コンサルタントです。以下はクライアントの現状フロー（As-Is）と発見された課題です。

## 現状フロー（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のフロー（To-Be）をMermaid記法で作成してください。改善のポイント：
- 経費精算システム導入（楽楽精算/マネーフォワード等）
- 領収書のスマホ撮影・OCR読取
- 交通系ICカード連携による自動申請
- 会計システムとのAPI連携
- 承認フローの電子化

フローチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: 'プロジェクト計画',
                industry: '汎用（PM）',
                category: 'general',
                diagramType: 'gantt',
                icon: 'M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z',
                mermaid: `gantt
    title プロジェクト計画
    dateFormat YYYY-MM-DD
    section 企画
    要件定義       :a1, 2026-03-01, 14d
    仕様策定       :a2, after a1, 7d
    section 設計
    基本設計       :b1, after a2, 10d
    詳細設計       :b2, after b1, 14d
    section 開発
    開発フェーズ1  :c1, after b2, 21d
    開発フェーズ2  :c2, after c1, 21d
    section テスト
    単体テスト     :d1, after c2, 7d
    結合テスト     :d2, after d1, 10d
    section リリース
    本番リリース   :e1, after d2, 3d`,
                prompt: {
                    phase1: 'あなたはプロジェクトマネジメントの専門家です。プロジェクト計画ガントチャートについて以下のポイントをヒアリングし、Mermaid図を作成してください：①プロジェクト期間 ②各フェーズの工数 ③マイルストーン ④並行作業の有無 ⑤リスクバッファ ⑥レビュー・承認タイミング',
                    phase2: `あなたはプロジェクトマネジメントの改善コンサルタントです。以下のMermaidガントチャートはクライアントの現在のプロジェクト計画です。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このプロジェクト計画について以下の観点で分析してください：
①ボトルネックになっている箇所
②並行化できる工程
③バッファが不足している箇所
④依存関係の整理余地
⑤リスクが潜んでいる箇所
⑥クリティカルパスの特定

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたはプロジェクトマネジメントの改善コンサルタントです。以下はクライアントの現状プロジェクト計画（As-Is）と発見された課題です。

## 現状プロジェクト計画（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のプロジェクト計画（To-Be）をMermaid記法で作成してください。改善のポイント：
- クリティカルパスの短縮
- 並行作業の最大化
- 適切なバッファ設定
- マイルストーンレビューの追加
- リスク対応期間の明示

ガントチャートの後に、期待される効果も示してください。`
                }
            },
            {
                name: 'システム構成（部門間連携）',
                industry: '汎用（IT）',
                category: 'general',
                diagramType: 'sequence',
                icon: 'M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z',
                mermaid: `sequenceDiagram
    participant 顧客
    participant フロントエンド
    participant API
    participant DB
    participant 外部サービス
    顧客->>フロントエンド: リクエスト
    フロントエンド->>API: データ要求
    API->>DB: クエリ実行
    DB-->>API: データ返却
    API->>外部サービス: 外部API呼出
    外部サービス-->>API: レスポンス
    API-->>フロントエンド: 処理結果
    フロントエンド-->>顧客: 画面表示`,
                prompt: {
                    phase1: 'あなたはシステムアーキテクトです。システム間連携フローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①システム構成要素 ②各層の役割 ③データフロー ④外部連携先 ⑤エラーハンドリング ⑥セキュリティ要件',
                    phase2: `あなたはシステムアーキテクトです。以下のMermaidシーケンス図はクライアントの現在のシステム構成・連携フローです。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

このシステム構成について以下の観点で分析してください：
①ボトルネックになっている箇所
②冗長な通信・処理
③単一障害点（SPOF）のリスク
④セキュリティ上の脆弱性
⑤スケーラビリティの課題
⑥エラーハンドリングの不足

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたはシステムアーキテクトです。以下はクライアントの現状システム構成（As-Is）と発見された課題です。

## 現状システム構成（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後のシステム構成（To-Be）をMermaid記法で作成してください。改善のポイント：
- キャッシュ層の追加によるパフォーマンス向上
- ロードバランサー導入による可用性向上
- API Gateway導入によるセキュリティ強化
- 非同期処理・メッセージキュー活用
- 監視・ログ基盤の追加

シーケンス図の後に、期待される効果も示してください。`
                }
            },
            {
                name: '顧客体験ジャーニー',
                industry: '汎用（マーケ）',
                category: 'general',
                diagramType: 'journey',
                icon: 'M9 11.24V7.5C9 6.12 10.12 5 11.5 5S14 6.12 14 7.5v3.74c1.21-.81 2-2.18 2-3.74C16 5.01 13.99 3 11.5 3S7 5.01 7 7.5c0 1.56.79 2.93 2 3.74zm9.84 4.63l-4.54-2.26c-.17-.07-.35-.11-.54-.11H13v-6c0-.83-.67-1.5-1.5-1.5S10 6.67 10 7.5v10.74l-3.43-.72c-.08-.01-.15-.03-.24-.03-.31 0-.59.13-.79.33l-.79.8 4.94 4.94c.27.27.65.44 1.06.44h6.79c.75 0 1.33-.55 1.44-1.28l.75-5.27c.01-.07.02-.14.02-.2 0-.62-.38-1.16-.91-1.38z',
                mermaid: `journey
    title 顧客体験ジャーニー
    section 認知
      Web検索: 3: 顧客
      SNS閲覧: 4: 顧客
      広告接触: 3: 顧客
    section 検討
      資料請求: 4: 顧客
      比較検討: 3: 顧客
      口コミ確認: 4: 顧客
    section 購入
      問い合わせ: 5: 顧客
      見積取得: 4: 顧客
      契約: 5: 顧客
    section 利用
      初回利用: 4: 顧客
      継続利用: 5: 顧客
    section 推薦
      満足度評価: 5: 顧客
      口コミ投稿: 4: 顧客`,
                prompt: {
                    phase1: 'あなたはカスタマーエクスペリエンスの専門家です。顧客体験ジャーニーについて以下のポイントをヒアリングし、Mermaid図を作成してください：①ターゲット顧客像 ②各タッチポイント ③顧客の感情変化 ④課題・ペインポイント ⑤改善施策 ⑥KPI設定',
                    phase2: `あなたはカスタマーエクスペリエンスの専門家です。以下のMermaidジャーニーマップはクライアントの現在の顧客体験です。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

この顧客体験について以下の観点で分析してください：
①満足度が低い（スコア3以下）タッチポイント
②顧客が離脱しやすいポイント
③競合との差別化不足の箇所
④感動体験を生み出せるポイント
⑤デジタル化・自動化で改善できる箇所
⑥顧客データの活用余地

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたはカスタマーエクスペリエンスの専門家です。以下はクライアントの現状の顧客体験（As-Is）と発見された課題です。

## 現状の顧客体験（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善後の顧客体験（To-Be）をMermaid記法で作成してください。改善のポイント：
- パーソナライズ施策の導入
- オンボーディング体験の強化
- カスタマーサクセスチームの設置
- コミュニティ・ロイヤルティプログラム
- NPS測定と継続的改善サイクル

ジャーニーマップの後に、期待される効果も示してください。`
                }
            },
            {
                name: '課題の構造化マインドマップ',
                industry: '汎用（分析）',
                category: 'general',
                diagramType: 'mindmap',
                icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z',
                mermaid: `mindmap
  root((業務課題))
    コスト
      人件費高騰
        残業削減
        外注活用
      設備投資
        クラウド化
        レガシー更改
    品質
      不良率
        検査強化
        工程改善
      顧客満足
        CS体制
        アフターフォロー
    スピード
      リードタイム
        ボトルネック特定
        並行処理化
      意思決定
        権限委譲
        データ活用`,
                prompt: {
                    phase1: 'あなたは業務分析の専門家です。業務課題の構造化について以下のポイントをヒアリングし、Mermaid図を作成してください：①主要課題カテゴリ ②各課題の関連性 ③優先度の高い課題 ④根本原因 ⑤具体的な改善アクション ⑥効果測定指標',
                    phase2: `あなたは業務分析の専門家です。以下のMermaidマインドマップはクライアントの現在の業務課題の構造です。

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

この課題構造について以下の観点で分析してください：
①最も影響が大きい課題カテゴリ
②課題同士の因果関係
③根本原因と表面的な症状の区別
④クイックウィンで解決できる課題
⑤中長期で取り組むべき課題
⑥課題解決の優先順位

各課題には具体的な改善の方向性も添えてください。`,
                    phase3: `あなたは業務分析の専門家です。以下はクライアントの現状の課題構造（As-Is）と発見された課題です。

## 現状の課題構造（As-Is）
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

## 発見された課題
{{ISSUES}}

これらを踏まえ、改善アクションプランをMermaid記法（マインドマップ）で作成してください。改善のポイント：
- 課題の優先順位付け（緊急度×影響度）
- クイックウィン施策の明示
- 根本原因へのアプローチ
- 各施策の実行体制・期間
- KPI設定と効果測定方法

マインドマップの後に、期待される効果も示してください。`
                }
            },
            {
                name: '飲食業：デリバリー注文→配達フロー',
                industry: '飲食業',
                category: 'industry',
                diagramType: 'sequence',
                icon: 'M8.1 13.34l2.83-2.83L3.91 3.5a4.008 4.008 0 000 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.47-1.47-4.21-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z',
                mermaid: `sequenceDiagram
    participant C as 顧客
    participant A as 注文アプリ
    participant R as 飲食店
    participant D as 配達員
    C->>A: メニュー閲覧・注文
    A->>R: 注文通知
    R->>R: 注文内容確認
    R-->>A: 受注確認（調理時間通知）
    A-->>C: 受注確認・到着予定時刻
    R->>R: 調理開始
    R->>A: 調理完了通知
    A->>D: 配達依頼・ピックアップ指示
    D->>R: 商品受取
    D->>A: ピックアップ完了
    A-->>C: 配達員出発通知
    D->>C: 商品お届け
    C->>A: 受取確認・評価`,
                prompt: {
                    phase1: 'あなたはフードデリバリー業務の専門家です。以下のポイントについてヒアリングし、Mermaid図を作成してください：①注文受付チャネル（自社アプリ/外部プラットフォーム）②メニュー管理方法 ③配達員のアサイン方法 ④調理時間の見積もり方法 ⑤配達エリアと料金体系 ⑥トラブル対応（遅延・誤配）',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のデリバリー注文フローを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **リードタイム分析**
   - 注文から配達完了までの各工程の所要時間
   - ボトルネックとなっている工程の特定

2. **配達員アサイン**
   - 配達員マッチングの効率性
   - ピーク時の対応能力

3. **調理と配達のタイミング**
   - 調理完了と配達員到着のタイミング最適化
   - 待機時間の発生状況

4. **顧客への通知**
   - 通知タイミングの適切さ
   - リアルタイム性の確保

5. **トラブル対応**
   - 遅延・誤配時のエスカレーションフロー
   - 顧客満足度への影響

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のデリバリー注文フローと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状フロー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのシーケンス図をMermaid形式で作成してください：

1. **AI需要予測による事前調理**
   - ピーク時の注文予測に基づく事前準備

2. **配達ルート最適化**
   - 複数配達の効率的なルーティング

3. **リアルタイム位置追跡**
   - 顧客への正確な到着予定時刻の提供

4. **自動配達員マッチング**
   - 位置情報・稼働状況に基づく最適アサイン

5. **品質フィードバック連携**
   - 顧客評価を店舗の品質改善に活用

改善提案には以下を含めてください：
- TO-BEのMermaidシーケンス図
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（リードタイム短縮、顧客満足度向上など）
- 実装の優先順位と段階的アプローチ
- 必要なシステム投資の概算`
                }
            },
            {
                name: '医療：オンライン診療フロー',
                industry: '医療',
                category: 'industry',
                diagramType: 'sequence',
                icon: 'M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z',
                mermaid: `sequenceDiagram
    participant P as 患者
    participant W as Web予約システム
    participant D as 医師
    participant PH as 薬局
    participant INS as 保険システム
    P->>W: オンライン診療予約
    W->>P: 予約確認・問診票送付
    P->>W: 問診票回答
    W->>D: 診療予定・問診情報共有
    P->>D: ビデオ通話接続
    D->>P: 問診・診察
    D->>D: 診断・処方決定
    D->>W: 電子処方箋発行
    D->>INS: 保険請求データ送信
    W->>PH: 処方箋データ送信
    PH->>P: 薬剤配送 or 来局案内
    W->>P: 次回予約案内・フォローメール`,
                prompt: {
                    phase1: 'あなたは医療DXの専門家です。オンライン診療フローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①予約方法（Web/電話/アプリ）②問診の実施方法 ③ビデオ通話ツール ④処方箋の発行・送付方法 ⑤薬の受取方法（配送/来局）⑥保険請求フロー ⑦フォローアップ体制',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のオンライン診療フローを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **待機時間分析**
   - 予約から診察開始までの待機時間
   - 各工程の所要時間の適切性

2. **問診情報の活用**
   - 事前問診データの診察での活用度
   - 電子カルテとの連携状況

3. **通信トラブル対応**
   - ビデオ通話の安定性
   - トラブル時の代替手段の有無

4. **処方箋の電子化**
   - 電子処方箋の利用率
   - 薬局との連携の効率性

5. **患者データセキュリティ**
   - 個人情報保護の対策レベル
   - アクセス制御の適切性

6. **保険請求の自動化**
   - 保険請求業務の効率性
   - エラー発生率

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のオンライン診療フローと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状フロー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのシーケンス図をMermaid形式で作成してください：

1. **AI問診による事前トリアージ**
   - 症状に応じた適切な診療科への振り分け

2. **電子カルテ自動連携**
   - 問診データの自動取り込み
   - 診療履歴の即座参照

3. **処方箋の完全電子化**
   - 薬局への即時データ送信
   - 患者の薬受取の利便性向上

4. **保険請求の自動化**
   - レセプトデータの自動生成
   - 請求ミスの削減

5. **患者ポータル**
   - 診療履歴・検査結果の一元管理
   - 次回予約リマインド

改善提案には以下を含めてください：
- TO-BEのMermaidシーケンス図
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（待機時間短縮、業務効率化など）
- 医療法規制への対応
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '金融：オンライン決済処理フロー',
                industry: '金融',
                category: 'general',
                diagramType: 'sequence',
                icon: 'M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z',
                mermaid: `sequenceDiagram
    participant U as ユーザー
    participant EC as ECサイト
    participant PG as 決済ゲートウェイ
    participant CA as カード会社
    participant BK as 銀行
    U->>EC: 購入手続き
    EC->>PG: 決済リクエスト（トークン化）
    PG->>PG: 不正検知チェック
    PG->>CA: オーソリゼーション要求
    CA->>BK: 与信照会
    BK-->>CA: 与信結果
    CA-->>PG: 承認/拒否レスポンス
    PG-->>EC: 決済結果通知
    EC-->>U: 注文完了画面
    Note over EC,PG: 売上確定処理（後日）
    EC->>PG: 売上確定要求
    PG->>CA: 売上確定
    CA->>BK: 資金移動指示`,
                prompt: {
                    phase1: 'あなたは決済システムの専門家です。オンライン決済フローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①対応決済手段（クレジットカード/電子マネー/QR等）②決済ゲートウェイの選定 ③不正検知の仕組み ④オーソリと売上確定のタイミング ⑤返金・チャージバック対応 ⑥PCI DSS対応状況',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のオンライン決済フローを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **決済処理時間**
   - レスポンスタイムの適切性
   - ユーザー体験への影響

2. **不正検知の精度**
   - 不正取引の検出率
   - 誤検知（false positive）の発生率

3. **障害時の対応**
   - フォールバック体制の有無
   - 決済手段の冗長性

4. **セキュリティレベル**
   - トークン化の実装状況
   - PCI DSS準拠レベル

5. **決済手数料の最適化**
   - 決済手段ごとのコスト分析
   - 最適な決済ルーティング

6. **返金処理の効率性**
   - 返金処理の自動化レベル
   - 処理完了までの日数

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のオンライン決済フローと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状フロー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのシーケンス図をMermaid形式で作成してください：

1. **3Dセキュア2.0対応**
   - 生体認証などによる安全な本人確認
   - ユーザビリティの向上

2. **AIベース不正検知**
   - 機械学習による高精度な不正判定
   - リアルタイムリスクスコアリング

3. **マルチゲートウェイ冗長化**
   - 障害時の自動フェイルオーバー
   - 可用性の向上

4. **サブスクリプション管理**
   - 定期課金の自動化
   - 決済失敗時のリトライロジック

5. **リアルタイムダッシュボード**
   - 売上・決済状況の可視化
   - 異常検知とアラート

改善提案には以下を含めてください：
- TO-BEのMermaidシーケンス図
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（決済成功率向上、不正削減など）
- セキュリティ強化策
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: 'カスタマーサポート：問い合わせエスカレーションフロー',
                industry: 'カスタマーサポート',
                category: 'general',
                diagramType: 'sequence',
                icon: 'M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z',
                mermaid: `sequenceDiagram
    participant C as 顧客
    participant BOT as チャットボット
    participant L1 as 一次対応（オペレーター）
    participant L2 as 二次対応（専門担当）
    participant MGR as マネージャー
    C->>BOT: 問い合わせ開始
    BOT->>BOT: FAQ自動回答試行
    BOT-->>C: 自動回答提示
    C->>BOT: 解決しない旨を伝達
    BOT->>L1: 有人対応へエスカレーション
    L1->>C: 状況ヒアリング
    L1->>L1: マニュアル確認
    L1-->>C: 一次回答
    C->>L1: 技術的な追加質問
    L1->>L2: 専門担当へエスカレーション
    L2->>C: 技術的な詳細回答
    L2-->>C: 解決策の提示
    Note over L2,MGR: クレーム時のみ
    L2->>MGR: 対応報告・承認依頼
    MGR-->>L2: 対応方針承認
    L2->>C: 最終回答・フォローアップ`,
                prompt: {
                    phase1: 'あなたはカスタマーサポートの専門家です。問い合わせ対応フローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①問い合わせチャネル（電話/メール/チャット/SNS）②一次対応の範囲 ③エスカレーション基準 ④専門部門の構成 ⑤SLA（対応時間目標）⑥フォローアップ体制',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の問い合わせ対応フローを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **初回解決率（FCR）**
   - ボットでの自動解決率
   - 一次対応での解決率
   - エスカレーションが必要となる要因

2. **エスカレーション分析**
   - エスカレーション頻度
   - 各レベルでの対応時間
   - エスカレーション基準の明確さ

3. **チャットボットの有効性**
   - 自動回答の精度
   - ユーザー満足度
   - 有人対応への移行タイミング

4. **対応時間のばらつき**
   - SLA達成率
   - 時間帯・曜日による変動
   - ボトルネックの特定

5. **ナレッジ共有**
   - FAQ・マニュアルの整備状況
   - 担当者間の情報共有
   - ベストプラクティスの蓄積

6. **顧客満足度要因**
   - 満足度に影響する主要因
   - 不満の発生ポイント

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の問い合わせ対応フローと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状フロー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのシーケンス図をMermaid形式で作成してください：

1. **AIチャットボットの高度化**
   - RAG（Retrieval-Augmented Generation）による高精度回答
   - 自然言語理解の向上

2. **ナレッジベース自動更新**
   - 対応履歴からのFAQ自動生成
   - 継続的な改善サイクル

3. **感情分析による優先度判定**
   - 顧客の感情状態を自動検知
   - 緊急度に応じた優先対応

4. **オムニチャネル統合**
   - 全チャネルの対応履歴一元管理
   - シームレスな引継ぎ

5. **対応品質の自動スコアリング**
   - AIによる対応品質評価
   - 改善ポイントのフィードバック

改善提案には以下を含めてください：
- TO-BEのMermaidシーケンス図
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（FCR向上、対応時間短縮など）
- 実装の優先順位と段階的アプローチ
- ROI試算`
                }
            },
            {
                name: '不動産：オンライン内見→契約フロー',
                industry: '不動産',
                category: 'industry',
                diagramType: 'sequence',
                icon: 'M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z',
                mermaid: `sequenceDiagram
    participant C as 顧客
    participant PT as 物件ポータル
    participant AG as 不動産会社
    participant OW as オーナー
    participant BK as 保証会社/銀行
    C->>PT: 物件検索・問い合わせ
    PT->>AG: 問い合わせ通知
    AG->>C: 物件詳細・オンライン内見案内
    C->>AG: オンライン内見予約
    AG->>C: VR内見 or ビデオ通話内見
    C->>AG: 申込み意思表示
    AG->>OW: 入居申込み報告
    OW-->>AG: 申込み承諾
    AG->>BK: 入居審査依頼
    BK->>BK: 審査実施
    BK-->>AG: 審査結果通知
    AG-->>C: 審査結果連絡
    AG->>C: 契約書類送付（電子契約）
    C->>AG: 電子署名・初期費用支払
    AG->>OW: 契約完了報告
    AG->>C: 鍵渡し・入居案内`,
                prompt: {
                    phase1: 'あなたは不動産DXの専門家です。物件内見から契約までのフローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①集客チャネル（ポータル/自社サイト/SNS）②内見方法（現地/VR/ビデオ）③申込み・審査プロセス ④契約方式（対面/電子契約）⑤オーナーとの連絡フロー ⑥入居後フォロー',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の不動産内見・契約フローを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **リードタイム分析**
   - 問い合わせから内見までの日数
   - 内見から申込みまでの期間
   - 審査・契約完了までの所要日数

2. **オンライン内見の成約率**
   - VR内見 vs 現地内見の成約率比較
   - オンライン内見の満足度
   - 顧客離脱ポイント

3. **審査プロセス**
   - 審査の所要日数
   - 必要書類の収集方法
   - 審査落ちの主要因

4. **書類のデジタル化**
   - 紙の書類が残っている箇所
   - 電子契約の利用率
   - IT重説の活用状況

5. **オーナー連絡の効率性**
   - オーナーとの連絡手段
   - 承認待ち時間
   - 情報共有の方法

6. **顧客離脱要因**
   - 離脱率の高い工程
   - 競合への流出理由

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の不動産内見・契約フローと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状フロー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのシーケンス図をMermaid形式で作成してください：

1. **AI物件レコメンド**
   - 顧客の希望条件に基づく最適物件提案
   - 行動履歴からの嗜好分析

2. **VR内見の標準化**
   - 全物件のVRコンテンツ整備
   - 360度映像・間取り図の連動

3. **審査のオンライン完結**
   - 必要書類のアップロード機能
   - AIによる書類チェック

4. **IT重説の活用**
   - オンラインでの重要事項説明
   - 移動時間・コストの削減

5. **電子契約の完全導入**
   - 全契約プロセスのペーパーレス化
   - 電子署名による即日契約

6. **CRM顧客フォロー**
   - 自動リマインド・ナーチャリング
   - 入居後の満足度フォロー

改善提案には以下を含めてください：
- TO-BEのMermaidシーケンス図
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（成約率向上、リードタイム短縮など）
- 実装の優先順位と段階的アプローチ
- 宅建業法等の法規制への対応`
                }
            },
            {
                name: 'SaaS：API連携・Webhook通知フロー',
                industry: 'IT/SaaS',
                category: 'general',
                diagramType: 'sequence',
                icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z',
                mermaid: `sequenceDiagram
    participant CL as クライアントアプリ
    participant AUTH as 認証サーバー
    participant API as APIサーバー
    participant WH as Webhookエンドポイント
    participant Q as メッセージキュー
    participant WK as ワーカー
    CL->>AUTH: 認証リクエスト（API Key）
    AUTH-->>CL: アクセストークン発行
    CL->>API: APIリクエスト（Bearer Token）
    API->>API: リクエスト検証・レート制限チェック
    API->>Q: 非同期処理をキューに追加
    API-->>CL: 202 Accepted（処理受付）
    Q->>WK: ジョブ取得・処理実行
    WK->>WK: データ処理
    WK->>WH: Webhook通知（処理結果）
    WH-->>WK: 200 OK
    Note over WK,WH: 失敗時はリトライ（最大3回）
    WK->>API: 処理結果保存
    CL->>API: 結果取得（ポーリング or Webhook受信）
    API-->>CL: 処理結果レスポンス`,
                prompt: {
                    phase1: 'あなたはAPI設計の専門家です。API連携・Webhook通知フローについて以下のポイントをヒアリングし、Mermaid図を作成してください：①認証方式（OAuth2/API Key/JWT）②APIの主要エンドポイント ③同期/非同期処理の使い分け ④Webhook通知のイベント種別 ⑤レート制限とリトライ戦略 ⑥エラーハンドリング方針',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のAPI連携・Webhook通知フローを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **認証フローのセキュリティ**
   - 認証方式の適切性
   - トークンの有効期限管理
   - リフレッシュトークンの実装

2. **レート制限**
   - レート制限値の適切性
   - クライアントへの通知方法
   - 超過時の振る舞い

3. **非同期処理の設計**
   - キューの選定（Redis/RabbitMQ等）
   - ジョブの優先度管理
   - タイムアウト設定

4. **Webhookの信頼性**
   - リトライロジックの適切性
   - 冪等性の担保
   - 署名検証の実装

5. **APIバージョニング**
   - バージョン管理戦略
   - 後方互換性の維持
   - 非推奨API（Deprecated）の扱い

6. **データ整合性**
   - エラー時のロールバック
   - 部分的な失敗への対応
   - トランザクション管理

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のAPI連携・Webhook通知フローと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状フロー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのシーケンス図をMermaid形式で作成してください：

1. **OAuth 2.0 + PKCE導入**
   - より安全な認証フロー
   - モバイルアプリ対応

2. **APIゲートウェイ統合管理**
   - レート制限・認証の一元化
   - ログ・モニタリングの統合

3. **Dead Letter Queue**
   - 失敗ジョブの隔離と分析
   - 手動リトライの仕組み

4. **Webhook署名検証**
   - HMAC署名による送信元検証
   - リプレイアタック対策

5. **OpenAPI仕様の自動生成**
   - コードからのドキュメント自動生成
   - クライアントSDKの自動生成

6. **APIモニタリングダッシュボード**
   - リアルタイムメトリクス可視化
   - 異常検知とアラート

改善提案には以下を含めてください：
- TO-BEのMermaidシーケンス図
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（信頼性向上、開発効率化など）
- セキュリティ強化策
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: 'Webサイトリニューアル計画',
                industry: 'IT/Web制作',
                category: 'general',
                diagramType: 'gantt',
                icon: 'M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z',
                mermaid: `gantt
    title Webサイトリニューアル計画
    dateFormat YYYY-MM-DD
    section 企画
        要件定義           :a1, 2024-04-01, 14d
        競合調査・分析      :a2, after a1, 7d
    section デザイン
        ワイヤーフレーム    :b1, after a2, 10d
        UIデザイン         :b2, after b1, 14d
        デザインレビュー    :b3, after b2, 3d
    section 開発
        フロントエンド実装  :c1, after b3, 21d
        バックエンド実装    :c2, after b3, 21d
        CMS構築           :c3, after c1, 7d
    section テスト・公開
        テスト・修正       :d1, after c3, 10d
        公開              :milestone, d2, after d1, 0d`,
                prompt: {
                    phase1: 'あなたはWeb制作のプロジェクトマネージャーです。Webサイトリニューアルの計画について以下をヒアリングし、ガントチャートを作成してください：①リニューアルの目的と範囲 ②現行サイトの構成 ③デザイン要件 ④CMS要件 ⑤スケジュール制約 ⑥関係者と役割分担',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のWebサイトリニューアル計画を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **全体スケジュールの妥当性**
   - 各フェーズの所要日数の適切性
   - 予備日の確保状況

2. **並行作業の最適化**
   - フロントエンドとバックエンドの並行開発
   - デザインと開発の重複期間

3. **クリティカルパスの特定**
   - プロジェクト全体の最長経路
   - 遅延リスクの高いタスク

4. **バッファの確保状況**
   - 不確実性への対応余地
   - リスク対策の十分さ

5. **レビュー・承認のボトルネック**
   - デザインレビューの時間配分
   - クライアント承認の待ち時間

6. **リソース競合のリスク**
   - 担当者の作業負荷
   - 外部パートナーの稼働調整

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のWebサイトリニューアル計画と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状計画:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのガントチャートをMermaid形式で作成してください：

1. **アジャイル手法の導入**
   - スプリント単位での開発
   - 定期的なデモとフィードバック

2. **プロトタイプ段階でのユーザーテスト**
   - 早期の方向性検証
   - デザイン手戻りの削減

3. **CI/CD導入による自動デプロイ**
   - テスト環境への自動反映
   - デプロイ時間の短縮

4. **段階的リリース計画**
   - MVP定義と優先順位付け
   - フェーズ分割リリース

改善提案には以下を含めてください：
- TO-BEのMermaidガントチャート
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（リードタイム短縮、品質向上など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '新規事業立ち上げスケジュール',
                industry: '経営',
                category: 'general',
                diagramType: 'gantt',
                icon: 'M12 2l-5.5 9h11L12 2zm0 3.84L13.93 9h-3.87L12 5.84zM17.5 13c-2.49 0-4.5 2.01-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.01 4.5-4.5-2.01-4.5-4.5-4.5zm0 7a2.5 2.5 0 010-5 2.5 2.5 0 010 5zM3 21.5h8v-8H3v8zm2-6h4v4H5v-4z',
                mermaid: `gantt
    title 新規事業立ち上げスケジュール
    dateFormat YYYY-MM-DD
    section 調査・企画
        市場調査          :a1, 2024-04-01, 21d
        事業計画策定       :a2, after a1, 14d
        資金調達          :a3, after a2, 30d
    section 準備
        チーム採用         :b1, after a2, 30d
        オフィス確保       :b2, after a3, 14d
        システム構築       :b3, after a3, 21d
    section 開発
        MVP開発           :c1, after b3, 42d
        ベータテスト       :c2, after c1, 21d
    section ローンチ
        マーケティング準備  :d1, after c1, 21d
        正式ローンチ       :milestone, d2, after c2, 0d`,
                prompt: {
                    phase1: 'あなたは新規事業のアドバイザーです。新規事業立ち上げの計画について以下をヒアリングし、ガントチャートを作成してください：①事業コンセプト ②ターゲット市場 ③必要な資金規模 ④チーム体制 ⑤MVP要件 ⑥目標ローンチ時期',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の新規事業立ち上げスケジュールを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **市場調査から開発までのリードタイム**
   - 仮説検証のスピード
   - 方向転換の余地

2. **資金調達と他タスクの依存関係**
   - 資金確保前に進められる活動
   - キャッシュフロー管理

3. **チーム採用の並行作業可能性**
   - 採用活動の早期開始
   - コアメンバーの確保時期

4. **MVP定義の妥当性**
   - 必要最小限の機能
   - 検証すべき仮説の明確さ

5. **ベータテスト期間の十分さ**
   - フィードバック収集と改善
   - ピボットの可能性

6. **マーケティング準備のタイミング**
   - ローンチ前の認知度向上
   - 初期顧客の獲得戦略

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の新規事業立ち上げスケジュールと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状計画:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのガントチャートをMermaid形式で作成してください：

1. **リーンスタートアップ手法**
   - Build-Measure-Learnサイクル
   - 継続的な仮説検証

2. **仮説検証サイクル短縮**
   - ランディングページテスト
   - プロトタイプによる早期検証

3. **段階的資金調達**
   - シードラウンドの活用
   - マイルストーンベースの調達

4. **アウトソーシング活用**
   - 非コア業務の外部委託
   - 開発リソースの柔軟な確保

5. **早期顧客検証**
   - ベータ版の早期リリース
   - アーリーアダプターとの協働

改善提案には以下を含めてください：
- TO-BEのMermaidガントチャート
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（リスク削減、スピード向上など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '店舗オープン準備スケジュール',
                industry: '飲食・小売',
                category: 'industry',
                diagramType: 'gantt',
                icon: 'M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z',
                mermaid: `gantt
    title 店舗オープン準備スケジュール
    dateFormat YYYY-MM-DD
    section 物件・設計
        物件探し・契約     :a1, 2024-04-01, 30d
        内装設計          :a2, after a1, 14d
        内装工事          :a3, after a2, 30d
    section 許認可・仕入れ
        営業許可申請       :b1, after a1, 14d
        仕入れ先選定       :b2, after a2, 21d
        備品・食材発注     :b3, after b2, 14d
    section 人材・宣伝
        スタッフ採用       :c1, after a2, 30d
        スタッフ研修       :c2, after c1, 14d
        プレオープン       :c3, after c2, 3d
    section オープン
        グランドオープン    :milestone, d1, after c3, 0d`,
                prompt: {
                    phase1: 'あなたは店舗開業コンサルタントです。店舗オープンの準備計画について以下をヒアリングし、ガントチャートを作成してください：①業態（飲食/小売/サービス）②物件条件 ③内装の方向性 ④必要な許認可 ⑤スタッフ人数 ⑥目標オープン日',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の店舗オープン準備スケジュールを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **物件契約からオープンまでの期間**
   - 全体スケジュールの妥当性
   - 業態別の標準期間との比較

2. **許認可取得のリードタイム**
   - 保健所検査のタイミング
   - 申請から承認までの所要日数

3. **内装工事と他作業の並行性**
   - 工事中に進められる準備
   - リソースの有効活用

4. **スタッフ研修の十分さ**
   - オペレーション習得の時間
   - プレオープンでの実践練習

5. **仕入れ先の確保時期**
   - 開店に間に合う発注タイミング
   - 初期在庫の最適化

6. **プレオープンの活用度**
   - オペレーション検証
   - 近隣住民への認知拡大

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の店舗オープン準備スケジュールと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状計画:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのガントチャートをMermaid形式で作成してください：

1. **物件選定チェックリスト導入**
   - 立地条件の定量評価
   - 契約前のリスク洗い出し

2. **許認可の並行申請**
   - 必要書類の早期準備
   - 行政との事前相談

3. **SNS事前プロモーション**
   - オープン前の情報発信
   - 期待感の醸成

4. **プレオープンイベント活用**
   - 招待制の試食会・内覧会
   - SNS口コミの獲得

5. **オープン後の振り返り計画**
   - 初週・初月の課題抽出
   - オペレーション改善サイクル

改善提案には以下を含めてください：
- TO-BEのMermaidガントチャート
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（スムーズなオープン、初動売上向上など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '採用計画スケジュール',
                industry: '人事',
                category: 'general',
                diagramType: 'gantt',
                icon: 'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z',
                mermaid: `gantt
    title 年間採用計画スケジュール
    dateFormat YYYY-MM-DD
    section 新卒採用
        採用計画策定       :a1, 2024-01-08, 14d
        会社説明会         :a2, 2024-03-01, 45d
        面接・選考         :a3, 2024-04-01, 60d
        内定・フォロー     :a4, 2024-06-01, 120d
    section 中途採用
        求人要件定義       :b1, 2024-01-08, 7d
        求人公開・スカウト  :b2, after b1, 150d
        書類選考・面接     :b3, after b1, 170d
    section 入社準備
        研修プログラム設計  :c1, 2024-08-01, 30d
        入社オリエンテーション :c2, 2024-10-01, 5d`,
                prompt: {
                    phase1: 'あなたは人事コンサルタントです。年間採用計画について以下をヒアリングし、ガントチャートを作成してください：①採用ポジションと人数 ②新卒/中途の比率 ③採用チャネル ④選考プロセス ⑤入社時期 ⑥研修体制',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の年間採用計画を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **採用チャネルの最適化**
   - 各チャネルの効果測定
   - コストパフォーマンスの評価

2. **選考プロセスの所要日数**
   - 書類選考から内定までのリードタイム
   - 優秀人材の逃避リスク

3. **面接官のリソース配分**
   - 面接官の負荷
   - スケジュール調整の効率性

4. **内定辞退リスクへの対策**
   - 内定後のフォロー施策
   - エンゲージメント維持

5. **中途採用のスピード感**
   - 求人公開から入社までの期間
   - 即戦力確保のタイミング

6. **入社前後のフォロー体制**
   - オンボーディングプログラム
   - 早期離職防止策

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の年間採用計画と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状計画:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのガントチャートをMermaid形式で作成してください：

1. **ATS導入による選考管理自動化**
   - 応募者情報の一元管理
   - 選考ステータスの可視化

2. **構造化面接導入**
   - 評価基準の統一
   - 面接品質の向上

3. **リファラル採用強化**
   - 社員紹介インセンティブ
   - 採用コスト削減

4. **入社前オンボーディング**
   - 内定者フォローアップ
   - 入社前の期待値調整

5. **採用データ分析基盤**
   - ファネル分析による改善
   - 採用ROIの可視化

改善提案には以下を含めてください：
- TO-BEのMermaidガントチャート
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（採用効率化、定着率向上など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: 'マーケティングキャンペーン計画',
                industry: 'マーケ',
                category: 'general',
                diagramType: 'gantt',
                icon: 'M18 11v2h4v-2h-4zm-2 6.61c.96.71 2.21 1.65 3.2 2.39.4-.53.8-1.07 1.2-1.6-.99-.74-2.24-1.68-3.2-2.4-.4.54-.8 1.08-1.2 1.61zM20.4 5.6c-.4-.53-.8-1.07-1.2-1.6-.99.74-2.24 1.68-3.2 2.4.4.53.8 1.07 1.2 1.6.96-.72 2.21-1.65 3.2-2.4zM4 9c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h1v4h2v-4h1l5 3V6L8 9H4zm11.5 3c0-1.33-.58-2.53-1.5-3.35v6.69c.92-.81 1.5-2.01 1.5-3.34z',
                mermaid: `gantt
    title マーケティングキャンペーン計画
    dateFormat YYYY-MM-DD
    section 企画
        キャンペーン企画    :a1, 2024-04-01, 14d
        ターゲット分析      :a2, 2024-04-01, 10d
        予算策定           :a3, after a1, 7d
    section 制作
        クリエイティブ制作  :b1, after a3, 21d
        LP制作            :b2, after a3, 14d
        広告入稿準備       :b3, after b1, 7d
    section 実施
        SNS広告配信        :c1, after b3, 30d
        リスティング広告    :c2, after b3, 30d
        メール配信         :c3, after b2, 30d
    section 分析
        中間レポート       :d1, 2024-06-15, 3d
        最終レポート       :d2, after c1, 7d`,
                prompt: {
                    phase1: 'あなたはマーケティングのプロフェッショナルです。キャンペーン計画について以下をヒアリングし、ガントチャートを作成してください：①キャンペーンの目的 ②ターゲット ③使用チャネル ④予算規模 ⑤KPI ⑥実施期間',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のマーケティングキャンペーン計画を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **企画から実施までのリードタイム**
   - 準備期間の妥当性
   - 市場タイミングとの適合

2. **クリエイティブ制作のボトルネック**
   - 制作リソースの十分さ
   - レビュー・修正の時間配分

3. **複数チャネルの連携タイミング**
   - 統合マーケティングの実現
   - メッセージの一貫性

4. **中間分析のフィードバック反映**
   - データ収集と改善のサイクル
   - 柔軟な予算再配分

5. **予算配分の妥当性**
   - チャネル別ROI予測
   - テスト予算の確保

6. **PDCAサイクルの回し方**
   - 分析頻度と深度
   - 次回キャンペーンへの学び

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のマーケティングキャンペーン計画と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状計画:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのガントチャートをMermaid形式で作成してください：

1. **A/Bテスト計画の組み込み**
   - クリエイティブの複数パターン
   - データドリブンな最適化

2. **リアルタイムダッシュボード導入**
   - 主要KPIの常時監視
   - 迅速な意思決定

3. **クリエイティブ自動最適化**
   - 機械学習による配信最適化
   - パーソナライズド広告

4. **アトリビューション分析**
   - タッチポイント貢献度の可視化
   - 最適なカスタマージャーニー設計

5. **予算の動的再配分**
   - パフォーマンスに応じた予算移動
   - ROI最大化

改善提案には以下を含めてください：
- TO-BEのMermaidガントチャート
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（ROAS向上、効率化など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: 'EC購入体験ジャーニー',
                industry: '汎用（EC）',
                category: 'general',
                diagramType: 'journey',
                icon: 'M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z',
                mermaid: `journey
    title EC購入体験ジャーニー
    section 認知・検索
        SNS広告を見る: 3: 顧客
        検索エンジンで探す: 3: 顧客
        ECサイトにアクセス: 4: 顧客
    section 検討
        商品一覧を閲覧: 4: 顧客
        商品詳細を確認: 4: 顧客
        レビューを読む: 3: 顧客
        他社と比較: 2: 顧客
    section 購入
        カートに追加: 4: 顧客
        会員登録: 2: 顧客
        配送先・支払い入力: 3: 顧客
        注文確定: 5: 顧客
    section 受取
        配送状況を確認: 3: 顧客
        商品を受け取る: 5: 顧客
    section アフター
        レビューを書く: 3: 顧客
        リピート購入検討: 4: 顧客`,
                prompt: {
                    phase1: 'あなたはCXデザインの専門家です。EC購入体験のジャーニーマップについて以下をヒアリングし、Mermaid図を作成してください：①主な集客チャネル ②商品カテゴリ ③ターゲット顧客像 ④購入までの平均タッチポイント数 ⑤離脱が多いポイント ⑥アフターフォロー施策',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のEC購入体験ジャーニーを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **各タッチポイントの満足度の低いポイント**
   - スコア2以下のステップ
   - 顧客のペインポイント

2. **離脱率が高いステップ**
   - ファネル分析による特定
   - 離脱要因の仮説

3. **会員登録のハードル**
   - 必須項目の妥当性
   - ソーシャルログインの有無

4. **比較検討時の自社の弱み**
   - 競合との差別化不足
   - 情報提供の不十分さ

5. **配送体験の品質**
   - 配送スピード
   - 追跡情報の充実度

6. **リピート率向上の阻害要因**
   - アフターフォローの欠如
   - ロイヤリティ施策の不足

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のEC購入体験ジャーニーと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状ジャーニー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのジャーニーマップをMermaid形式で作成してください：

1. **パーソナライズドレコメンド**
   - 閲覧履歴に基づく商品提案
   - AIによる関連商品表示

2. **ゲスト購入オプション**
   - 会員登録なしでの購入
   - 購入後の簡易登録促進

3. **配送状況リアルタイム通知**
   - LINE/SMSでの配送通知
   - 再配達の簡易手続き

4. **ロイヤリティプログラム**
   - ポイント制度の充実
   - 会員ランク制度

5. **UGCレビュー活用**
   - レビュー投稿インセンティブ
   - 写真・動画レビューの促進

改善提案には以下を含めてください：
- TO-BEのMermaidジャーニーマップ（満足度スコアの改善を反映）
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（CVR向上、LTV増加など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '患者体験ジャーニー',
                industry: '医療',
                category: 'industry',
                diagramType: 'journey',
                icon: 'M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z',
                mermaid: `journey
    title 患者体験ジャーニー
    section 症状発生
        体調不良に気づく: 2: 患者
        症状をネットで検索: 2: 患者
        病院を探す: 3: 患者
    section 予約・来院
        Web予約する: 4: 患者
        来院・受付: 3: 患者
        待合室で待つ: 2: 患者
    section 診察
        問診を受ける: 3: 患者
        検査を受ける: 3: 患者
        診断結果を聞く: 4: 患者
        処方箋を受け取る: 4: 患者
    section 会計・薬局
        会計を待つ: 2: 患者
        支払い: 3: 患者
        薬局で薬を受取: 3: 患者
    section フォロー
        薬を服用する: 3: 患者
        経過観察・再診: 4: 患者`,
                prompt: {
                    phase1: 'あなたは医療CXの専門家です。患者体験のジャーニーマップについて以下をヒアリングし、Mermaid図を作成してください：①診療科目 ②主な患者層 ③予約方法 ④平均待ち時間 ⑤診察の流れ ⑥フォローアップ体制',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の患者体験ジャーニーを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **待ち時間による満足度低下**
   - 待合室での待機時間
   - 会計待ちのストレス

2. **予約システムの使いやすさ**
   - Web予約の操作性
   - 予約枠の柔軟性

3. **医師とのコミュニケーション品質**
   - 問診・診察の丁寧さ
   - 説明のわかりやすさ

4. **会計の待ち時間**
   - 会計処理の効率性
   - 支払い方法の多様性

5. **薬局との連携効率**
   - 処方箋情報の事前送信
   - 薬の受け取りまでの時間

6. **再診率と離脱要因**
   - フォローアップの有無
   - 継続受診の動機付け

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の患者体験ジャーニーと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状ジャーニー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのジャーニーマップをMermaid形式で作成してください：

1. **オンライン予約+順番通知**
   - リアルタイム待ち状況表示
   - SMS/アプリでの呼び出し通知

2. **AI問診によるトリアージ**
   - 事前問診の効率化
   - 診察時間の短縮

3. **電子カルテ連携**
   - 診察室での待ち時間削減
   - 診療情報の一元管理

4. **キャッシュレス決済**
   - 自動精算機の導入
   - クレジット・電子マネー対応

5. **患者ポータルでの診療記録閲覧**
   - 検査結果のオンライン確認
   - 処方履歴の管理

改善提案には以下を含めてください：
- TO-BEのMermaidジャーニーマップ（満足度スコアの改善を反映）
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（待ち時間削減、患者満足度向上など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '従業員オンボーディング体験',
                industry: '汎用（人事）',
                category: 'general',
                diagramType: 'journey',
                icon: 'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z',
                mermaid: `journey
    title 従業員オンボーディング体験
    section 入社前
        内定通知を受取: 5: 新入社員
        入社書類を提出: 3: 新入社員
        入社案内メール: 4: 新入社員
    section 入社初日
        オフィスに到着: 4: 新入社員
        歓迎・自己紹介: 4: 新入社員
        PC・アカウント設定: 2: 新入社員
        社内ツール説明: 3: 新入社員
    section 研修期間
        業務研修: 3: 新入社員
        メンターと1on1: 4: 新入社員
        初タスクに挑戦: 3: 新入社員
    section 独り立ち
        独力でタスク完了: 5: 新入社員
        3ヶ月面談: 4: 新入社員
        チームに貢献: 5: 新入社員`,
                prompt: {
                    phase1: 'あなたは人材育成の専門家です。従業員オンボーディング体験について以下をヒアリングし、ジャーニーマップを作成してください：①組織規模 ②主な職種 ③入社前の準備事項 ④初日の流れ ⑤研修プログラム ⑥メンター制度の有無',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の従業員オンボーディング体験を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **入社前のコミュニケーション不足**
   - 内定後のタッチポイント
   - 入社準備情報の提供

2. **初日のPC設定で躓くポイント**
   - IT環境のセットアップ
   - アカウント発行の遅延

3. **研修内容と実務のギャップ**
   - OJTの計画性
   - 実務に即した研修設計

4. **メンターの負荷**
   - メンター業務の時間確保
   - サポート体制の標準化

5. **独り立ちまでの期間**
   - 業務習得のスピード
   - 段階的な権限委譲

6. **早期離職リスクのサイン**
   - エンゲージメントの低下
   - フィードバック機会の不足

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の従業員オンボーディング体験と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状ジャーニー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのジャーニーマップをMermaid形式で作成してください：

1. **入社前ポータル導入**
   - 入社準備情報の一元提供
   - 社内文化・メンバー紹介

2. **PC自動キッティング**
   - 事前セットアップ済みPC支給
   - 初日からの業務集中

3. **バディ制度+メンター制度の併用**
   - 日常的なサポート（バディ）
   - キャリア相談（メンター）

4. **段階的権限委譲**
   - 30日/60日/90日での目標設定
   - スキルマトリクスでの進捗管理

5. **パルスサーベイによる定期フォロー**
   - 週次の簡易アンケート
   - 早期の課題検知と対応

改善提案には以下を含めてください：
- TO-BEのMermaidジャーニーマップ（満足度スコアの改善を反映）
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（早期戦力化、定着率向上など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: 'SaaS導入体験ジャーニー',
                industry: '汎用（SaaS）',
                category: 'general',
                diagramType: 'journey',
                icon: 'M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z',
                mermaid: `journey
    title SaaS導入体験ジャーニー
    section 認知
        課題を認識する: 2: 担当者
        解決策を検索: 3: 担当者
        サービスサイト閲覧: 3: 担当者
    section 検討
        無料トライアル登録: 4: 担当者
        基本機能を試す: 4: 担当者
        社内で共有・提案: 3: 担当者
        上長に稟議: 2: 担当者
    section 導入
        プラン選択・契約: 4: 担当者
        初期設定: 3: 担当者
        データ移行: 2: 担当者
        チームへの展開: 3: 担当者
    section 活用
        日常業務で利用: 4: 担当者
        サポートに問合せ: 3: 担当者
    section 継続
        契約更新検討: 3: 担当者
        上位プラン検討: 4: 担当者`,
                prompt: {
                    phase1: 'あなたはSaaSのカスタマーサクセス専門家です。SaaS導入体験のジャーニーマップについて以下をヒアリングし、Mermaid図を作成してください：①SaaSの種類（CRM/ERP/MA等）②導入企業の規模 ③決裁プロセス ④データ移行の有無 ⑤サポート体制 ⑥解約理由の傾向',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のSaaS導入体験ジャーニーを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **トライアルから有料転換のハードル**
   - 価値実感までの時間
   - 導入障壁の高さ

2. **稟議プロセスの長さ**
   - 意思決定者の特定
   - ROI提示の効果

3. **初期設定・データ移行の苦痛**
   - セットアップの複雑さ
   - 既存データの移行難易度

4. **利用定着率**
   - アクティブユーザー率
   - 機能活用度

5. **サポート満足度**
   - 問い合わせ対応スピード
   - 自己解決支援の充実度

6. **解約リスクの早期兆候**
   - ログイン頻度の低下
   - サポート問い合わせの増加

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のSaaS導入体験ジャーニーと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状ジャーニー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのジャーニーマップをMermaid形式で作成してください：

1. **インタラクティブデモ導入**
   - サンドボックス環境での即時体験
   - ユースケース別のガイドツアー

2. **ROI試算ツール提供**
   - 導入効果の定量化支援
   - 稟議資料の自動生成

3. **導入支援プログラム強化**
   - CSMによるオンボーディング
   - データ移行代行サービス

4. **ヘルススコアモニタリング**
   - 利用状況の可視化
   - リスク顧客の早期検知

5. **プロアクティブなカスタマーサクセス**
   - 定期的なチェックイン
   - ベストプラクティス共有

改善提案には以下を含めてください：
- TO-BEのMermaidジャーニーマップ（満足度スコアの改善を反映）
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（有料転換率向上、チャーン率低下など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '住宅購入体験ジャーニー',
                industry: '不動産',
                category: 'industry',
                diagramType: 'journey',
                icon: 'M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z',
                mermaid: `journey
    title 住宅購入体験ジャーニー
    section 情報収集
        購入を検討開始: 3: 購入者
        ポータルサイトで検索: 3: 購入者
        資金計画を立てる: 2: 購入者
    section 物件探し
        不動産会社に相談: 3: 購入者
        物件見学: 4: 購入者
        理想の物件を発見: 5: 購入者
    section 契約
        住宅ローン事前審査: 2: 購入者
        重要事項説明: 3: 購入者
        売買契約締結: 4: 購入者
        住宅ローン本審査: 2: 購入者
    section 引渡し
        残金決済: 3: 購入者
        鍵の引渡し: 5: 購入者
    section 入居後
        引っ越し: 3: 購入者
        新生活スタート: 5: 購入者`,
                prompt: {
                    phase1: 'あなたは不動産CXの専門家です。住宅購入体験のジャーニーマップについて以下をヒアリングし、Mermaid図を作成してください：①物件タイプ（新築/中古/マンション/戸建）②ターゲット層 ③集客チャネル ④平均検討期間 ⑤ローン連携先 ⑥アフターサービス',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の住宅購入体験ジャーニーを分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **資金計画段階での不安要因**
   - ローン審査の不透明さ
   - 総費用の把握しにくさ

2. **物件見学の効率性**
   - 見学のスケジューリング
   - オンライン内見の活用

3. **ローン審査の待ち時間ストレス**
   - 事前審査から本審査までの期間
   - 審査状況の可視化

4. **重要事項説明の理解度**
   - 専門用語の多さ
   - 説明時間の長さ

5. **契約から引渡しまでの不安**
   - 進捗状況の共有不足
   - 準備事項の案内

6. **入居後のフォロー不足**
   - アフターサービスの認知
   - トラブル時の対応窓口

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の住宅購入体験ジャーニーと、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状ジャーニー:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのジャーニーマップをMermaid形式で作成してください：

1. **VR内見の標準化**
   - 360度パノラマ映像
   - 遠隔地からの物件確認

2. **ローンシミュレーター連携**
   - 月々の返済額試算
   - 金融機関との即時連携

3. **電子契約・IT重説対応**
   - オンライン完結の契約
   - 移動時間・コスト削減

4. **入居後サポートプログラム**
   - 定期メンテナンス案内
   - 住まいの相談窓口

5. **オーナーコミュニティ構築**
   - 同マンション住民の交流
   - 生活情報の共有

改善提案には以下を含めてください：
- TO-BEのMermaidジャーニーマップ（満足度スコアの改善を反映）
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（成約率向上、顧客満足度向上など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: 'マーケティング戦略マインドマップ',
                industry: '汎用（マーケ）',
                category: 'general',
                diagramType: 'mindmap',
                icon: 'M18 11v2h4v-2h-4zm-2 6.61c.96.71 2.21 1.65 3.2 2.39.4-.53.8-1.07 1.2-1.6-.99-.74-2.24-1.68-3.2-2.4-.4.54-.8 1.08-1.2 1.61zM20.4 5.6c-.4-.53-.8-1.07-1.2-1.6-.99.74-2.24 1.68-3.2 2.4.4.53.8 1.07 1.2 1.6.96-.72 2.21-1.65 3.2-2.4zM4 9c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h1v4h2v-4h1l5 3V6L8 9H4zm11.5 3c0-1.33-.58-2.53-1.5-3.35v6.69c.92-.81 1.5-2.01 1.5-3.34z',
                mermaid: `mindmap
  root((マーケティング戦略))
    ターゲット
      ペルソナ定義
        年齢・性別
        課題・ニーズ
      セグメンテーション
        地域別
        行動別
    チャネル
      オンライン
        SNS広告
        リスティング
        SEO
      オフライン
        チラシ
        イベント
    コンテンツ
      ブログ記事
      動画
      メルマガ
    KPI
      認知度
      CV率
      LTV`,
                prompt: {
                    phase1: 'あなたはマーケティング戦略の専門家です。マーケティング戦略の全体像について以下をヒアリングし、マインドマップを作成してください：①事業の特徴 ②ターゲット顧客 ③現在の集客チャネル ④競合状況 ⑤予算規模 ⑥KPI設定',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のマーケティング戦略を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **ターゲット定義の具体性**
   - ペルソナの解像度
   - セグメンテーションの妥当性

2. **チャネル選択の適切さ**
   - ターゲットとチャネルの整合性
   - チャネルミックスの最適化

3. **コンテンツとターゲットの整合性**
   - ペルソナのニーズとの合致
   - カスタマージャーニーとの連動

4. **KPIの測定可能性**
   - 計測基盤の整備状況
   - データドリブンな改善サイクル

5. **オンライン/オフラインのバランス**
   - チャネル間の連携
   - 予算配分の妥当性

6. **競合との差別化ポイント**
   - ユニークバリュー
   - ポジショニングの明確さ

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のマーケティング戦略と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状マインドマップ:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのマインドマップをMermaid形式で作成してください：

1. **データドリブンなペルソナ更新**
   - 顧客データ分析による精緻化
   - 行動データに基づくセグメント

2. **チャネル横断の統合マーケティング**
   - オムニチャネル戦略
   - 一貫したメッセージング

3. **コンテンツのパーソナライズ化**
   - セグメント別のコンテンツ最適化
   - ダイナミックコンテンツ配信

4. **マーケティングオートメーション導入**
   - リードナーチャリングの自動化
   - スコアリングモデル構築

5. **ROAS最適化**
   - アトリビューション分析
   - 予算の動的再配分

改善提案には以下を含めてください：
- TO-BEのMermaidマインドマップ
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（効率化、ROI向上など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '新商品企画マインドマップ',
                industry: '汎用（商品開発）',
                category: 'general',
                diagramType: 'mindmap',
                icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z',
                mermaid: `mindmap
  root((新商品企画))
    市場分析
      トレンド調査
        消費者ニーズ
        競合動向
      ターゲット市場
        市場規模
        成長率
    商品設計
      コンセプト
        差別化ポイント
        価格帯
      仕様
        機能要件
        デザイン
    販売戦略
      チャネル
        直販
        代理店
      プロモーション
        PR
        広告
    スケジュール
      開発フェーズ
      テスト販売
      本格展開`,
                prompt: {
                    phase1: 'あなたは商品企画の専門家です。新商品企画の全体像について以下をヒアリングし、マインドマップを作成してください：①商品カテゴリ ②ターゲット顧客 ③競合製品 ④差別化ポイント ⑤価格戦略 ⑥販売チャネル',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の新商品企画を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **市場ニーズとのフィット**
   - ペインポイントの解決度
   - 市場調査の十分さ

2. **差別化の持続性**
   - 模倣されにくい強み
   - 競争優位の源泉

3. **価格帯の妥当性**
   - ターゲットの購買力
   - 競合との価格比較

4. **販売チャネルの網羅性**
   - ターゲット顧客へのリーチ
   - チャネル戦略の整合性

5. **開発スケジュールの現実性**
   - リソース確保の見通し
   - リスクバッファの確保

6. **テスト販売の計画**
   - 仮説検証の設計
   - フィードバック収集方法

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の新商品企画と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状マインドマップ:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのマインドマップをMermaid形式で作成してください：

1. **ユーザーインタビュー重視の企画プロセス**
   - 定性調査の深堀り
   - ジョブ理論の適用

2. **プロトタイプ検証の早期化**
   - MVP開発とテスト
   - 反復的な改善サイクル

3. **D2Cチャネル活用**
   - 直接顧客接点の構築
   - データ収集と活用

4. **サブスクリプションモデル検討**
   - 継続収益の確保
   - 顧客LTVの最大化

5. **データ分析による需要予測**
   - 過剰在庫・欠品の防止
   - 最適生産計画

改善提案には以下を含めてください：
- TO-BEのMermaidマインドマップ
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（市場適合度向上、リスク削減など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: 'DX推進計画マインドマップ',
                industry: '汎用（DX）',
                category: 'general',
                diagramType: 'mindmap',
                icon: 'M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5C13 2.12 11.88 1 10.5 1S8 2.12 8 3.5V5H4c-1.1 0-1.99.9-1.99 2v3.8H3.5c1.49 0 2.7 1.21 2.7 2.7s-1.21 2.7-2.7 2.7H2V20c0 1.1.9 2 2 2h3.8v-1.5c0-1.49 1.21-2.7 2.7-2.7 1.49 0 2.7 1.21 2.7 2.7V22H17c1.1 0 2-.9 2-2v-4h1.5c1.38 0 2.5-1.12 2.5-2.5S21.88 11 20.5 11z',
                mermaid: `mindmap
  root((DX推進計画))
    現状分析
      業務プロセス
        紙の業務
        手作業の多い工程
      ITインフラ
        レガシーシステム
        セキュリティ課題
    優先施策
      短期
        ペーパーレス化
        クラウド移行
      中期
        業務自動化
        データ基盤構築
      長期
        AI活用
        新規事業創出
    推進体制
      DX推進室
      外部パートナー
      社内教育
    KPI
      業務効率化率
      コスト削減額
      従業員満足度`,
                prompt: {
                    phase1: 'あなたはDXコンサルタントです。DX推進計画の全体像について以下をヒアリングし、マインドマップを作成してください：①現在のIT環境 ②デジタル化の現状 ③主要な業務課題 ④DXの目標 ⑤予算・体制 ⑥優先度の高い領域',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）のDX推進計画を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **現状のデジタル成熟度**
   - 業務プロセスのデジタル化レベル
   - データ活用度

2. **短期施策の実現可能性**
   - リソース確保の見通し
   - 経営層のコミットメント

3. **中長期目標との整合性**
   - 短期施策と長期ビジョンの連続性
   - ロードマップの具体性

4. **推進体制の十分さ**
   - DX人材の質と量
   - 外部パートナー活用戦略

5. **KPIの測定方法**
   - 定量評価の仕組み
   - ベースライン測定

6. **社内の変革抵抗要因**
   - 文化的な障壁
   - チェンジマネジメント計画

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）のDX推進計画と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状マインドマップ:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのマインドマップをMermaid形式で作成してください：

1. **デジタル成熟度アセスメント導入**
   - 現状の客観的評価
   - ギャップ分析

2. **PoC重視のアプローチ**
   - 小規模実証実験
   - 学びの高速サイクル

3. **チェンジマネジメント計画**
   - ステークホルダー管理
   - 抵抗勢力への対応

4. **外部人材・パートナー活用戦略**
   - DX人材の確保
   - 知見の内製化

5. **定期的な進捗レビュー体制**
   - 月次/四半期レビュー
   - 軌道修正の仕組み

改善提案には以下を含めてください：
- TO-BEのMermaidマインドマップ
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（生産性向上、競争力強化など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '組織改善マインドマップ',
                industry: '汎用（組織）',
                category: 'general',
                diagramType: 'mindmap',
                icon: 'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z',
                mermaid: `mindmap
  root((組織改善))
    人材
      採用
        採用ブランディング
        選考プロセス改善
      育成
        研修制度
        メンター制度
      評価
        目標管理
        360度評価
    働き方
      リモートワーク
        インフラ整備
        コミュニケーション
      福利厚生
        健康経営
        ワークライフバランス
    組織構造
      フラット化
      部門間連携
      情報共有
    文化
      ミッション浸透
      心理的安全性
      イノベーション促進`,
                prompt: {
                    phase1: 'あなたは組織開発の専門家です。組織改善の全体像について以下をヒアリングし、マインドマップを作成してください：①組織規模・構造 ②現在の課題 ③社員エンゲージメント ④離職率 ⑤評価制度 ⑥目指す組織像',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の組織改善計画を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **最も影響が大きい課題**
   - 優先的に取り組むべき領域
   - 波及効果の高い施策

2. **採用・育成・評価の連動性**
   - 人材マネジメントの一貫性
   - キャリアパスの明確さ

3. **リモートワーク環境の成熟度**
   - ツール・制度の整備状況
   - 生産性への影響

4. **組織文化と制度の整合性**
   - 理念と実態のギャップ
   - 制度の実効性

5. **社員の声の吸い上げ体制**
   - サーベイの実施頻度
   - フィードバック反映の仕組み

6. **改善施策の優先順位**
   - クイックウィンの特定
   - 中長期投資の見極め

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の組織改善計画と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状マインドマップ:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのマインドマップをMermaid形式で作成してください：

1. **エンゲージメントサーベイ定期実施**
   - パルスサーベイの導入
   - アクションプランの策定

2. **1on1制度の標準化**
   - マネージャートレーニング
   - 対話の質向上

3. **スキルマトリクス導入**
   - 保有スキルの可視化
   - 育成計画の個別化

4. **ジョブ型人事制度への移行**
   - 職務定義の明確化
   - 専門性の評価

5. **社内コミュニケーション基盤強化**
   - 情報共有ツールの統一
   - ナレッジマネジメント

改善提案には以下を含めてください：
- TO-BEのMermaidマインドマップ
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（エンゲージメント向上、離職率低下など）
- 実装の優先順位と段階的アプローチ`
                }
            },
            {
                name: '事業計画マインドマップ',
                industry: '汎用（経営）',
                category: 'general',
                diagramType: 'mindmap',
                icon: 'M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z',
                mermaid: `mindmap
  root((事業計画))
    ビジョン
      3年後の姿
      5年後の姿
      ミッション
    事業モデル
      収益源
        主力事業
        新規事業
      コスト構造
        固定費
        変動費
    戦略
      差別化
        独自技術
        顧客体験
      成長
        既存市場深耕
        新市場開拓
    リソース
      資金計画
        売上計画
        投資計画
      人材計画
        採用
        育成
    リスク管理
      市場リスク
      競合リスク
      運営リスク`,
                prompt: {
                    phase1: 'あなたは経営コンサルタントです。事業計画の全体像について以下をヒアリングし、マインドマップを作成してください：①事業概要 ②ビジョン・ミッション ③収益モデル ④競争優位性 ⑤資金計画 ⑥リスク要因',
                    phase2: `以下のMermaidコードで表現された現状（AS-IS）の事業計画を分析してください：

\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

以下の観点で詳細に分析し、課題を洗い出してください：

1. **ビジョンと戦略の整合性**
   - 目指す姿と施策の連動
   - 長期視点の明確さ

2. **収益源の多様性**
   - 単一事業への依存度
   - 新規事業の育成計画

3. **コスト構造の最適性**
   - 固定費比率の妥当性
   - スケーラビリティ

4. **成長戦略の実現可能性**
   - 市場機会の大きさ
   - 競争優位の持続性

5. **リソース計画の妥当性**
   - 資金調達の見通し
   - 人材確保の実現性

6. **リスク管理の網羅性**
   - 主要リスクの洗い出し
   - 対策の具体性

各課題について、影響度（高/中/低）と緊急度（高/中/低）を評価し、優先順位をつけてください。`,
                    phase3: `以下の現状（AS-IS）の事業計画と、抽出された課題を踏まえて、TO-BEの改善提案を行ってください：

**現状マインドマップ:**
\`\`\`mermaid
{{ASIS_CODE}}
\`\`\`

**抽出された課題:**
{{ISSUES}}

以下の改善ポイントを考慮し、TO-BEのマインドマップをMermaid形式で作成してください：

1. **OKRフレームワーク導入**
   - ビジョンからの落とし込み
   - 全社目標の透明化

2. **シナリオプランニング策定**
   - 複数シナリオでの事業計画
   - 不確実性への対応

3. **ユニットエコノミクス分析強化**
   - 顧客単位の収益性把握
   - 持続可能な成長モデル

4. **戦略的パートナーシップ検討**
   - アライアンス戦略
   - M&Aオプション

5. **定期的な戦略レビュー体制**
   - 四半期ごとの見直し
   - 環境変化への迅速対応

改善提案には以下を含めてください：
- TO-BEのMermaidマインドマップ
- 主要な改善ポイントの説明（Before/After比較）
- 期待される効果（成長加速、リスク低減など）
- 実装の優先順位と段階的アプローチ`
                }
            }
        ];

        const appState = {
            currentPhasePrompts: null,
            activePhase: 1,
            debounceTimer: null,
            renderCount: 0,
            currentTheme: 'default',
            compareTheme: 'default',
            asisDebounce: null,
            tobeDebounce: null
        };

        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });

        // HTML escape utility function
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // --- 定数定義 ---
        const CATEGORY_LABELS = {
            problem: '問題点',
            improvement: '改善案',
            question: '確認事項',
            memo: 'メモ'
        };

        const CATEGORY_COLORS = {
            problem: '#ef4444',
            improvement: '#3b82f6',
            question: '#d97706',
            memo: '#6b7280'
        };

        const CATEGORY_BADGE_STYLES = {
            problem: { label: '問題点', color: 'bg-red-50 text-red-600 border-red-200' },
            improvement: { label: '改善案', color: 'bg-blue-50 text-blue-600 border-blue-200' },
            question: { label: '確認事項', color: 'bg-amber-50 text-amber-600 border-amber-200' },
            memo: { label: 'メモ', color: 'bg-green-50 text-green-600 border-green-200' }
        };

        const CATEGORY_ORDER = ['problem', 'improvement', 'question', 'memo'];

        const DEBOUNCE_MS = 300;
        const TOAST_DURATION_MS = 2500;
        const TOAST_FADE_MS = 300;
        const FILENAME_SANITIZE_REGEX = /[<>:"\/\\|?*]/g;

        // --- ユーティリティ関数 ---
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 left-1/2 bg-warm-gray-800 text-white text-sm px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300 toast-enter';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), TOAST_FADE_MS);
            }, TOAST_DURATION_MS);
        }

        function showAlert(message, type = 'info') {
            const colors = {
                error: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-800', icon: 'text-red-500', btn: 'bg-red-600 hover:bg-red-700' },
                warning: { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-800', icon: 'text-amber-500', btn: 'bg-amber-600 hover:bg-amber-700' },
                info: { bg: 'bg-navy-50', border: 'border-navy-200', text: 'text-navy-800', icon: 'text-navy-500', btn: 'bg-navy-600 hover:bg-navy-700' },
                success: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-800', icon: 'text-green-500', btn: 'bg-green-600 hover:bg-green-700' }
            };
            const c = colors[type] || colors.info;
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-[200] flex items-center justify-center bg-black/30 backdrop-blur-sm';
            overlay.innerHTML = `
                <div class="${c.bg} ${c.border} border rounded-lg shadow-xl max-w-sm mx-4 p-6 modal-enter">
                    <p class="${c.text} text-sm leading-relaxed mb-5">${escapeHTML(message)}</p>
                    <div class="text-right">
                        <button class="alert-ok-btn ${c.btn} text-white text-sm px-6 py-2 rounded tracking-wider transition-all">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            const okBtn = overlay.querySelector('.alert-ok-btn');
            okBtn.focus();
            okBtn.addEventListener('click', () => overlay.remove());
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        }

        function showConfirm(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-[200] flex items-center justify-center bg-black/30 backdrop-blur-sm';
            overlay.innerHTML = `
                <div class="bg-white border border-warm-gray-200 rounded-lg shadow-xl max-w-sm mx-4 p-6 modal-enter">
                    <p class="text-warm-gray-800 text-sm leading-relaxed mb-5">${escapeHTML(message)}</p>
                    <div class="flex justify-end gap-3">
                        <button class="confirm-cancel-btn btn btn-ghost rounded">キャンセル</button>
                        <button class="confirm-ok-btn btn btn-primary rounded">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.querySelector('.confirm-cancel-btn').addEventListener('click', () => overlay.remove());
            overlay.querySelector('.confirm-ok-btn').addEventListener('click', () => { overlay.remove(); onConfirm(); });
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        }

        function sanitizeFilename(name) {
            return name.replace(FILENAME_SANITIZE_REGEX, '_');
        }

        function getProjectName(fallback = 'diagram') {
            return document.getElementById('project-name').value.trim() || fallback;
        }

        function svgToImagePromise(svgElement) {
            return new Promise((resolve, reject) => {
                try {
                    const clone = svgElement.cloneNode(true);
                    clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                    clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');

                    // viewBox/getBBoxから明示的サイズを設定
                    let width, height;
                    const viewBox = clone.getAttribute('viewBox');
                    if (viewBox) {
                        const parts = viewBox.split(/[\s,]+/);
                        width = parseFloat(parts[2]);
                        height = parseFloat(parts[3]);
                    }
                    if (!width || !height) {
                        try {
                            const bbox = svgElement.getBBox();
                            width = bbox.width || svgElement.clientWidth || 800;
                            height = bbox.height || svgElement.clientHeight || 600;
                        } catch (_) {
                            width = svgElement.clientWidth || 800;
                            height = svgElement.clientHeight || 600;
                        }
                    }
                    clone.setAttribute('width', width);
                    clone.setAttribute('height', height);

                    // foreignObject → SVG text変換（img内ではforeignObject描画不可のため）
                    const foreignObjects = clone.querySelectorAll('foreignObject');
                    foreignObjects.forEach(fo => {
                        const text = fo.textContent.trim();
                        if (!text) { fo.remove(); return; }

                        const x = parseFloat(fo.getAttribute('x') || 0);
                        const y = parseFloat(fo.getAttribute('y') || 0);
                        const w = parseFloat(fo.getAttribute('width') || 100);
                        const h = parseFloat(fo.getAttribute('height') || 30);

                        const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        textEl.setAttribute('x', String(x + w / 2));
                        textEl.setAttribute('y', String(y + h / 2));
                        textEl.setAttribute('text-anchor', 'middle');
                        textEl.setAttribute('dominant-baseline', 'central');
                        textEl.setAttribute('font-size', '14');
                        textEl.setAttribute('font-family', '"Noto Sans JP", sans-serif');
                        textEl.setAttribute('fill', '#333');

                        const lines = text.split('\n').filter(l => l.trim());
                        if (lines.length <= 1) {
                            textEl.textContent = text;
                        } else {
                            const lineHeight = 18;
                            const startY = y + h / 2 - (lines.length - 1) * lineHeight / 2;
                            lines.forEach((line, i) => {
                                const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                                tspan.setAttribute('x', String(x + w / 2));
                                tspan.setAttribute('y', String(startY + i * lineHeight));
                                tspan.textContent = line.trim();
                                textEl.appendChild(tspan);
                            });
                        }
                        fo.parentNode.replaceChild(textEl, fo);
                    });

                    const svgData = new XMLSerializer().serializeToString(clone);
                    const svgBase64 = btoa(unescape(encodeURIComponent(svgData)));
                    const dataUrl = `data:image/svg+xml;base64,${svgBase64}`;

                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error('SVG画像の読み込みに失敗しました'));
                    img.src = dataUrl;
                } catch (err) {
                    reject(err);
                }
            });
        }

        // アノテーション管理クラス
        class AnnotationManager {
            constructor() {
                this.annotations = {
                    single: [],
                    asis: [],
                    tobe: []
                };
                this.annotationMode = false;
                this.compareAnnotationMode = false;
                this.currentTarget = null;
                this.selectedCategory = 'problem';
                this.currentNodeText = '';
                this.popup = document.getElementById('annotation-popup');
                this.init();
            }

            init() {
                // 通常モードのトグル
                const toggle = document.getElementById('annotation-toggle');
                if (toggle) {
                    toggle.addEventListener('change', (e) => {
                        this.annotationMode = e.target.checked;
                        this.toggleAnnotationMode('single', this.annotationMode);
                    });
                }

                // 比較モードのトグル
                const compareToggle = document.getElementById('compare-annotation-toggle');
                if (compareToggle) {
                    compareToggle.addEventListener('change', (e) => {
                        this.compareAnnotationMode = e.target.checked;
                        this.toggleAnnotationMode('asis', this.compareAnnotationMode);
                        this.toggleAnnotationMode('tobe', this.compareAnnotationMode);
                    });
                }

                // カテゴリボタン
                document.querySelectorAll('.annotation-category-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.annotation-category-btn').forEach(b => {
                            b.classList.remove('selected');
                            b.style.transform = '';
                            b.style.fontWeight = '';
                        });
                        btn.classList.add('selected');
                        btn.style.transform = 'scale(1.05)';
                        btn.style.fontWeight = '600';
                        this.selectedCategory = btn.dataset.category;
                    });
                });

                // デフォルトで問題点を選択
                const problemBtn = document.querySelector('.annotation-category-btn[data-category="problem"]');
                if (problemBtn) {
                    problemBtn.classList.add('selected');
                    problemBtn.style.transform = 'scale(1.05)';
                    problemBtn.style.fontWeight = '600';
                }

                // 追加ボタン
                document.getElementById('annotation-add').addEventListener('click', () => {
                    const comment = document.getElementById('annotation-comment').value.trim();
                    if (!comment) {
                        showAlert('コメントを入力してください', 'warning');
                        return;
                    }
                    this.addAnnotation(this.currentNodeText, this.selectedCategory, comment, this.currentTarget);
                    this.hidePopup();
                });

                // キャンセルボタン
                document.getElementById('annotation-cancel').addEventListener('click', () => {
                    this.hidePopup();
                });

                // ポップアップ外をクリックで閉じる
                this.popup.addEventListener('click', (e) => {
                    if (e.target === this.popup) {
                        this.hidePopup();
                    }
                });

                // 課題に転送ボタン（通常モード）
                const exportBtn = document.getElementById('export-annotations-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => this.exportToIssues());
                }

                // 課題に転送ボタン（比較モード）
                const exportCompareBtn = document.getElementById('export-compare-annotations-btn');
                if (exportCompareBtn) {
                    exportCompareBtn.addEventListener('click', () => this.exportToIssues());
                }

                // AIプロンプト生成ボタン
                const aiPromptBtn = document.getElementById('generate-ai-prompt-btn');
                if (aiPromptBtn) {
                    aiPromptBtn.addEventListener('click', () => this.generateAIPrompt());
                }
                const compareAiPromptBtn = document.getElementById('compare-generate-ai-prompt-btn');
                if (compareAiPromptBtn) {
                    compareAiPromptBtn.addEventListener('click', () => this.generateAIPrompt());
                }

                // Markdownコピーボタン
                const mdBtn = document.getElementById('copy-annotations-md-btn');
                if (mdBtn) {
                    mdBtn.addEventListener('click', () => this.exportToMarkdown());
                }
                const compareMdBtn = document.getElementById('compare-copy-annotations-md-btn');
                if (compareMdBtn) {
                    compareMdBtn.addEventListener('click', () => this.exportToMarkdown());
                }

                // Annotation guide banner
                const guideKey = 'annotation-guide-dismissed';
                const guideBanner = document.getElementById('annotation-guide-banner');
                if (guideBanner) {
                    if (localStorage.getItem(guideKey)) {
                        guideBanner.style.display = 'none';
                    }
                    const closeBtn = document.getElementById('close-annotation-guide');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => {
                            guideBanner.style.display = 'none';
                            localStorage.setItem(guideKey, '1');
                        });
                    }
                }

                const asisGuideBanner = document.getElementById('asis-annotation-guide-banner');
                if (asisGuideBanner) {
                    if (localStorage.getItem(guideKey)) {
                        asisGuideBanner.style.display = 'none';
                    }
                    const closeBtn = document.getElementById('close-asis-annotation-guide');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => {
                            asisGuideBanner.style.display = 'none';
                            localStorage.setItem(guideKey, '1');
                        });
                    }
                }

                const tobeGuideBanner = document.getElementById('tobe-annotation-guide-banner');
                if (tobeGuideBanner) {
                    if (localStorage.getItem(guideKey)) {
                        tobeGuideBanner.style.display = 'none';
                    }
                    const closeBtn = document.getElementById('close-tobe-annotation-guide');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => {
                            tobeGuideBanner.style.display = 'none';
                            localStorage.setItem(guideKey, '1');
                        });
                    }
                }
            }

            toggleAnnotationMode(target, enabled) {
                const previewEl = this.getTargetElement(target, 'preview');
                if (!previewEl) return;

                if (enabled) {
                    previewEl.classList.add('annotation-mode');
                    this.attachNodeListeners(previewEl, target);
                } else {
                    previewEl.classList.remove('annotation-mode');
                    this.detachNodeListeners(previewEl);
                }

                // パネルの表示/非表示
                const panelEl = this.getTargetElement(target, 'panel');
                if (panelEl) {
                    if (enabled) {
                        panelEl.classList.remove('hidden');
                    } else {
                        panelEl.classList.add('hidden');
                    }
                }
            }

            attachNodeListeners(previewEl, target) {
                const svg = previewEl.querySelector('svg');
                if (!svg) return;

                const nodes = svg.querySelectorAll('g.node, g[class*="node"]');
                nodes.forEach(node => {
                    node.style.cursor = 'crosshair';
                    node.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const nodeText = this.getNodeText(node);
                        this.showPopup(e, nodeText, target);
                    });
                });
            }

            detachNodeListeners(previewEl) {
                const nodes = Array.from(previewEl.querySelectorAll('g.node, g[class*="node"]'));
                nodes.forEach(node => {
                    node.style.cursor = '';
                });
            }

            getNodeText(nodeEl) {
                const foreignObject = nodeEl.querySelector('foreignObject span, foreignObject div');
                if (foreignObject) {
                    return foreignObject.textContent.trim();
                }
                const textEl = nodeEl.querySelector('text');
                if (textEl) {
                    return textEl.textContent.trim();
                }
                return 'Unknown';
            }

            showPopup(event, nodeText, target) {
                this.currentNodeText = nodeText;
                this.currentTarget = target;

                document.getElementById('annotation-node-name').textContent = nodeText;
                document.getElementById('annotation-comment').value = '';

                // ポップアップの位置を設定
                const x = event.clientX;
                const y = event.clientY;

                this.popup.style.position = 'fixed';
                this.popup.style.left = `${Math.min(x, window.innerWidth - 340)}px`;
                this.popup.style.top = `${Math.min(y, window.innerHeight - 300)}px`;
                this.popup.classList.remove('hidden');
                this.popup.style.display = 'block';

                document.getElementById('annotation-comment').focus();
            }

            hidePopup() {
                this.popup.classList.add('hidden');
                this.popup.style.display = 'none';
            }

            addAnnotation(nodeText, category, comment, target) {
                const annotation = {
                    id: Date.now(),
                    nodeText,
                    category,
                    comment
                };
                this.annotations[target].push(annotation);
                this.renderAnnotationList(target);
                this.applyAnnotationStyles(target);
            }

            deleteAnnotation(id, target) {
                this.annotations[target] = this.annotations[target].filter(a => a.id !== id);
                this.renderAnnotationList(target);
                this.applyAnnotationStyles(target);
            }

            applyAnnotationStyles(target) {
                const previewEl = this.getTargetElement(target, 'preview');
                if (!previewEl) return;

                const svg = previewEl.querySelector('svg');
                if (!svg) return;

                // まずすべてのアノテーションスタイルをクリア
                svg.querySelectorAll('g.node, g[class*="node"]').forEach(node => {
                    node.classList.remove('annotated-problem', 'annotated-improvement', 'annotated-question', 'annotated-memo');
                });

                // アノテーションがあるノードにスタイルを適用
                this.annotations[target].forEach(ann => {
                    const node = this.findNodeByText(previewEl, ann.nodeText);
                    if (node) {
                        node.classList.add(`annotated-${ann.category}`);
                    }
                });
            }

            findNodeByText(previewEl, text) {
                const svg = previewEl.querySelector('svg');
                if (!svg) return null;

                const nodes = svg.querySelectorAll('g.node, g[class*="node"]');
                for (const node of nodes) {
                    const nodeText = this.getNodeText(node);
                    if (nodeText === text) return node;
                }
                return null;
            }

            renderAnnotationList(target) {
                const listEl = this.getTargetElement(target, 'list');
                if (!listEl) return;

                const anns = this.annotations[target];

                if (anns.length === 0) {
                    listEl.innerHTML = '<p class="text-warm-gray-400 text-xs">アノテーションはまだありません</p>';
                    return;
                }

                listEl.innerHTML = anns.map(ann => `
                    <div class="flex items-start gap-3 p-3 bg-white border border-warm-gray-200 rounded-lg text-sm">
                        <span class="shrink-0 category-badge ${ann.category}">${CATEGORY_LABELS[ann.category]}</span>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-warm-gray-800 text-xs mb-0.5">${escapeHTML(ann.nodeText)}</p>
                            <p class="text-warm-gray-600 text-xs">${escapeHTML(ann.comment)}</p>
                        </div>
                        <button class="delete-annotation-btn shrink-0 text-warm-gray-400 hover:text-red-500 transition-colors" data-id="${ann.id}" data-target="${target}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                `).join('');

                // 削除ボタンのイベント
                listEl.querySelectorAll('.delete-annotation-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.deleteAnnotation(parseInt(btn.dataset.id), btn.dataset.target);
                    });
                });

                // サマリーバッジを更新
                this.renderSummary(target);
            }

            exportToIssues() {
                // As-Isのアノテーションを優先、なければsingleのものを使用
                const sourceAnns = this.getSourceAnnotations();

                if (sourceAnns.length === 0) {
                    showAlert('転送するアノテーションがありません', 'warning');
                    return;
                }

                const issuesText = sourceAnns
                    .map(ann => `- 【${CATEGORY_LABELS[ann.category]}】${ann.nodeText}: ${ann.comment}`)
                    .join('\n');

                const issuesInput = document.getElementById('issues-input');
                if (issuesInput) {
                    issuesInput.value = issuesText;
                    if (typeof updatePhase3Text === 'function') {
                        updatePhase3Text();
                    }
                    showToast('アノテーションを課題入力に転送しました');
                } else {
                    showAlert('課題入力欄が見つかりません', 'error');
                }
            }

            generateAIPrompt() {
                const sourceAnns = this.getSourceAnnotations();
                if (sourceAnns.length === 0) {
                    showAlert('アノテーションがありません。まず図にアノテーションを追加してください。', 'warning');
                    return;
                }

                const mermaidCode = document.getElementById('asis-editor')?.value || document.getElementById('editor').value || '';

                // カテゴリ別にグループ化
                const grouped = this.groupByCategory(sourceAnns);

                let annotationSection = '';
                for (const [cat, anns] of Object.entries(grouped)) {
                    annotationSection += `\n### ${CATEGORY_LABELS[cat]}\n`;
                    anns.forEach(ann => {
                        annotationSection += `- **${ann.nodeText}**: ${ann.comment}\n`;
                    });
                }

                const prompt = `あなたは業務改善コンサルタントです。以下の業務フローとコンサルタントが発見した課題・メモを分析し、具体的な改善提案を行ってください。

## 現状の業務フロー
\`\`\`mermaid
${mermaidCode}
\`\`\`

## コンサルタントの分析メモ
${annotationSection}

## 依頼事項
上記の分析メモを踏まえ、以下を提示してください：

1. **課題の優先順位付け**（影響度×緊急度で整理）
2. **改善後フロー（To-Be）**をMermaid記法で作成
3. **各改善ポイントの具体的なアクション**（担当・期間・コストの目安）
4. **期待される効果**（定量的に示せるものは数値で）`;

                navigator.clipboard.writeText(prompt).then(() => {
                    showToast('AIプロンプトをコピーしました — Claudeに貼り付けてください');
                }).catch(() => {
                    showAlert('クリップボードへのコピーに失敗しました', 'error');
                });
            }

            exportToMarkdown() {
                const sourceAnns = this.getSourceAnnotations();
                if (sourceAnns.length === 0) {
                    showAlert('コピーするアノテーションがありません', 'warning');
                    return;
                }

                const grouped = this.groupByCategory(sourceAnns);

                let md = '## 業務フロー分析レポート\n\n';
                md += `分析日: ${new Date().toLocaleDateString('ja-JP')}\n\n`;

                CATEGORY_ORDER.forEach(cat => {
                    if (grouped[cat] && grouped[cat].length > 0) {
                        md += `### ${CATEGORY_LABELS[cat]}（${grouped[cat].length}件）\n\n`;
                        grouped[cat].forEach(ann => {
                            md += `- **${ann.nodeText}**: ${ann.comment}\n`;
                        });
                        md += '\n';
                    }
                });

                navigator.clipboard.writeText(md).then(() => {
                    showToast('Markdownをクリップボードにコピーしました');
                }).catch(() => {
                    showAlert('クリップボードへのコピーに失敗しました', 'error');
                });
            }

            renderSummary(target) {
                const summaryEl = this.getTargetElement(target, 'summary');

                if (!summaryEl) return;

                const anns = this.annotations[target];
                if (anns.length === 0) {
                    summaryEl.innerHTML = '';
                    return;
                }

                const counts = {};
                anns.forEach(a => {
                    counts[a.category] = (counts[a.category] || 0) + 1;
                });

                summaryEl.innerHTML = Object.entries(counts)
                    .map(([cat, count]) => {
                        const cfg = CATEGORY_BADGE_STYLES[cat];
                        return `<span class="text-xs px-2 py-0.5 rounded-full border ${cfg.color}">${cfg.label} ${count}</span>`;
                    }).join('');
            }

            getTargetElement(target, type) {
                const TARGET_ELEMENT_MAP = {
                    single: { preview: 'preview-area', list: 'annotation-list', panel: 'annotation-panel', summary: 'annotation-summary' },
                    asis: { preview: 'asis-preview', list: 'asis-annotation-list', panel: 'asis-annotation-panel', summary: 'compare-annotation-summary' },
                    tobe: { preview: 'tobe-preview', list: 'tobe-annotation-list', panel: 'tobe-annotation-panel', summary: 'tobe-annotation-summary' }
                };
                const id = TARGET_ELEMENT_MAP[target]?.[type];
                return id ? document.getElementById(id) : null;
            }

            getSourceAnnotations() {
                return this.annotations.asis.length > 0 ? this.annotations.asis : this.annotations.single;
            }

            groupByCategory(annotations) {
                const grouped = {};
                CATEGORY_ORDER.forEach(cat => { grouped[cat] = []; });
                annotations.forEach(ann => {
                    if (grouped[ann.category]) grouped[ann.category].push(ann);
                });
                return grouped;
            }

            getAnnotationsForSave() {
                return this.annotations;
            }

            loadAnnotations(data) {
                if (data) {
                    this.annotations = {
                        single: data.single || [],
                        asis: data.asis || [],
                        tobe: data.tobe || []
                    };
                    ['single', 'asis', 'tobe'].forEach(target => {
                        this.renderAnnotationList(target);
                        this.applyAnnotationStyles(target);
                    });
                }
            }
        }

        // アノテーションマネージャーのインスタンス作成
        const annotationManager = new AnnotationManager();

        const editor = document.getElementById('editor');
        const previewArea = document.getElementById('preview-area');
        const templateSelect = document.getElementById('template-select');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const themeSelect = document.getElementById('theme-select');

        // 比較モード用
        const singleMode = document.getElementById('single-mode');
        const compareMode = document.getElementById('compare-mode');
        const modeSingle = document.getElementById('mode-single');
        const modeCompare = document.getElementById('mode-compare');
        const asisEditor = document.getElementById('asis-editor');
        const tobeEditor = document.getElementById('tobe-editor');
        const asisPreview = document.getElementById('asis-preview');
        const tobePreview = document.getElementById('tobe-preview');
        const asisTemplateSelect = document.getElementById('asis-template-select');
        const compareThemeSelect = document.getElementById('compare-theme-select');

        const industryGroup = document.createElement('optgroup');
        industryGroup.label = '業種別';
        const generalGroup = document.createElement('optgroup');
        generalGroup.label = '汎用業務';

        // As-Is用のテンプレートドロップダウン
        const asisIndustryGroup = document.createElement('optgroup');
        asisIndustryGroup.label = '業種別';
        const asisGeneralGroup = document.createElement('optgroup');
        asisGeneralGroup.label = '汎用業務';

        // テンプレートを図の種類でグループ化
        const diagramTypeConfig = [
            { type: 'flowchart', label: 'フローチャート', icon: 'M9 3v2H5v4h4v2H3v4h6v2H5v4h4v2h2v-2h4v2h2v-2h4v-4h-4v-2h6V9h-6V7h4V3h-4v2h-4V3H9zm4 4h4v4h-4V7zM9 7h2v2H9V7zm0 4h2v2H9v-2zm0 4h2v2H9v-2zm4 0h4v4h-4v-4z' },
            { type: 'sequence', label: 'シーケンス図', icon: 'M4 6h2v12H4V6zm14 0h2v12h-2V6zm-7 0h2v1h-2V6zm0 3h2v1h-2V9zm0 3h2v1h-2v-1zm0 3h2v1h-2v-1zm0 3h2v1h-2v-1z' },
            { type: 'gantt', label: 'ガントチャート', icon: 'M2 5h20v2H2V5zm0 4h14v2H2V9zm0 4h10v2H2v-2zm0 4h16v2H2v-2z' },
            { type: 'journey', label: 'ジャーニーマップ', icon: 'M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7' },
            { type: 'mindmap', label: 'マインドマップ', icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z' }
        ];

        const templateAccordion = document.getElementById('template-accordion');

        templates.forEach((template, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = template.name;

            const asisOption = document.createElement('option');
            asisOption.value = index;
            asisOption.textContent = template.name;

            if (template.category === 'industry') {
                industryGroup.appendChild(option);
                asisIndustryGroup.appendChild(asisOption);
            } else {
                generalGroup.appendChild(option);
                asisGeneralGroup.appendChild(asisOption);
            }
        });

        // アコーディオンセクション生成
        diagramTypeConfig.forEach(config => {
            const groupTemplates = templates
                .map((t, i) => ({ ...t, originalIndex: i }))
                .filter(t => t.diagramType === config.type);

            if (groupTemplates.length === 0) return;

            const section = document.createElement('div');
            section.className = 'accordion-section';

            // ヘッダー
            const header = document.createElement('div');
            header.className = 'accordion-header';
            header.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-navy-50 flex items-center justify-center shrink-0">
                        <svg class="w-4 h-4 text-navy-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="${config.icon}"/>
                        </svg>
                    </div>
                    <span class="text-sm font-medium text-warm-gray-800">${config.label}</span>
                    <span class="text-xs bg-rose-50 text-rose-600 px-2 py-0.5 rounded-full">${groupTemplates.length}</span>
                </div>
                <svg class="w-5 h-5 accordion-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            `;

            // コンテンツ
            const content = document.createElement('div');
            content.className = 'accordion-content';

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';

            groupTemplates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'template-card bg-white p-5 elevation-0 rounded-lg';
                // Add data attributes for search
                card.dataset.templateName = template.name.toLowerCase();
                card.dataset.templateIndustry = (template.industry || '').toLowerCase();
                card.dataset.templateType = (template.diagramType || '').toLowerCase();
                card.innerHTML = `
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-navy-50 flex items-center justify-center shrink-0">
                            <svg class="w-5 h-5 text-navy-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="${template.icon}"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-warm-gray-800">${template.name}</h4>
                            <span class="text-xs text-warm-gray-400">${template.industry}</span>
                        </div>
                    </div>
                    <p class="text-xs text-warm-gray-500">クリックして適用</p>
                `;
                card.addEventListener('click', () => loadTemplate(template.originalIndex));
                grid.appendChild(card);
            });

            content.appendChild(grid);

            // ヘッダークリックで開閉
            header.addEventListener('click', () => {
                const isOpen = content.classList.contains('open');
                // 他のセクションを閉じる（排他的開閉）
                document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('open'));
                document.querySelectorAll('.accordion-header').forEach(h => h.classList.remove('active'));
                if (!isOpen) {
                    content.classList.add('open');
                    header.classList.add('active');
                }
            });

            section.appendChild(header);
            section.appendChild(content);
            templateAccordion.appendChild(section);
        });

        templateSelect.appendChild(industryGroup);
        templateSelect.appendChild(generalGroup);

        asisTemplateSelect.appendChild(asisIndustryGroup);
        asisTemplateSelect.appendChild(asisGeneralGroup);

        // Template search functionality
        document.getElementById('template-search').addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            const accordion = document.getElementById('template-accordion');
            const sections = accordion.querySelectorAll('.accordion-section');
            let totalVisible = 0;

            sections.forEach(section => {
                const cards = section.querySelectorAll('[data-template-name]');
                let sectionVisible = 0;

                cards.forEach(card => {
                    const name = card.dataset.templateName || '';
                    const industry = card.dataset.templateIndustry || '';
                    const type = card.dataset.templateType || '';
                    const match = !query || name.includes(query) || industry.includes(query) || type.includes(query);
                    card.style.display = match ? '' : 'none';
                    if (match) sectionVisible++;
                });

                // Show/hide entire section
                section.style.display = sectionVisible > 0 ? '' : 'none';

                // Auto-expand sections with matches when searching
                const content = section.querySelector('.accordion-content');
                if (query && sectionVisible > 0 && content) {
                    content.classList.add('open');
                } else if (!query && content) {
                    content.classList.remove('open');
                }

                totalVisible += sectionVisible;
            });

            document.getElementById('template-search-empty').classList.toggle('hidden', totalVisible > 0 || !query);
        });

        function loadTemplate(index) {
            const template = templates[index];
            editor.value = template.mermaid;
            updatePreview();
            showModal(template.name, template.prompt);
            templateSelect.value = index;
        }

        // ========== エディタ関連イベント ==========
        function initEditorEvents() {
            templateSelect.addEventListener('change', (e) => {
                if (e.target.value !== '') {
                    loadTemplate(parseInt(e.target.value));
                }
            });

            editor.addEventListener('input', () => {
                clearTimeout(appState.debounceTimer);
                appState.debounceTimer = setTimeout(updatePreview, DEBOUNCE_MS);
            });
        }

        async function updatePreview() {
            const code = editor.value.trim();
            if (!code) {
                previewArea.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-warm-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 5h4v4H4zM16 5h4v4h-4zM10 15h4v4h-4zM6 9v2a2 2 0 002 2h2M18 9v2a2 2 0 01-2 2h-2M12 13v2"/>
                        </svg>
                        <p class="text-warm-gray-300 text-sm">左のエディタにMermaid記法を入力すると</p>
                        <p class="text-warm-gray-300 text-sm">ここにフロー図が表示されます</p>
                    </div>
                `;
                return;
            }

            try {
                previewArea.innerHTML = PREVIEW_LOADING_HTML;
                const { svg } = await mermaid.render('mermaid-svg-' + appState.renderCount++, code);
                previewArea.innerHTML = svg;

                // アノテーション機能を適用
                if (annotationManager.annotationMode) {
                    annotationManager.attachNodeListeners(previewArea, 'single');
                }
                annotationManager.applyAnnotationStyles('single');
            } catch (error) {
                previewArea.innerHTML = '<p class="text-red-500 text-sm">記法エラー: 正しいMermaid記法を入力してください</p>';
            }
        }

        function initEditorButtonEvents() {
            document.getElementById('copy-code-btn').addEventListener('click', () => {
                const code = editor.value;
                if (!code.trim()) {
                    showAlert('コピーするコードがありません', 'warning');
                    return;
                }
                navigator.clipboard.writeText(code).then(() => {
                    const btn = document.getElementById('copy-code-btn');
                    const originalText = btn.textContent;
                    btn.textContent = 'コピーしました!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(() => {
                    showAlert('クリップボードへのコピーに失敗しました', 'error');
                });
            });

            document.getElementById('clear-btn').addEventListener('click', () => {
                showConfirm('エディタとプレビューをクリアしますか？', () => {
                    editor.value = '';
                    previewArea.innerHTML = PREVIEW_EMPTY_HTML;
                    templateSelect.value = '';
                    appState.currentPhasePrompts = null;
                });
            });

            document.getElementById('download-png-btn').addEventListener('click', () => {
                const svg = previewArea.querySelector('svg');
                if (!svg) {
                    showAlert('ダウンロードする図がありません', 'warning');
                    return;
                }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const svgData = new XMLSerializer().serializeToString(svg);
                const img = new Image();

                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                img.onload = () => {
                    canvas.width = img.width * 2;
                    canvas.height = img.height * 2;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob((blob) => {
                        const safeName = sanitizeFilename(getProjectName());
                        const link = document.createElement('a');
                        link.download = `${safeName}.png`;
                        link.href = URL.createObjectURL(blob);
                        link.click();
                        URL.revokeObjectURL(url);
                    });
                };

                img.src = url;
            });

            document.getElementById('download-svg-btn').addEventListener('click', () => {
                const svg = previewArea.querySelector('svg');
                if (!svg) {
                    showAlert('ダウンロードする図がありません', 'warning');
                    return;
                }

                const safeName = sanitizeFilename(getProjectName());
                const svgData = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `${safeName}.svg`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            });

            themeSelect.addEventListener('change', (e) => {
                appState.currentTheme = e.target.value;
                mermaid.initialize({
                    startOnLoad: false,
                    theme: appState.currentTheme,
                    securityLevel: 'loose'
                });
                updatePreview();
            });
        }

        function showModal(title, prompt) {
            modalTitle.textContent = `${title} - プロンプトビルダー`;
            appState.currentPhasePrompts = prompt;
            appState.activePhase = 1;

            // Phase1の内容を表示
            document.getElementById('phase1-text').textContent = prompt.phase1;

            // Phase2の内容を生成（As-Isコード埋め込み）
            updatePhase2Text();

            // Phase3の内容を生成
            document.getElementById('issues-input').value = '';
            updatePhase3Text();

            // Phase1タブをアクティブに
            switchPhase(1);

            modal.classList.add('modal-open');
            const modalContent = modal.querySelector(':scope > div');
            if (modalContent) {
                modalContent.classList.remove('modal-enter');
                void modalContent.offsetWidth;
                modalContent.classList.add('modal-enter');
            }
        }

        function switchPhase(phase) {
            appState.activePhase = phase;
            document.querySelectorAll('.phase-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.phase == phase);
            });
            document.querySelectorAll('.phase-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`phase${phase}-content`).classList.remove('hidden');

            // Phase2/3は切替時に最新のAs-Is内容を反映
            if (phase === 2) updatePhase2Text();
            if (phase === 3) updatePhase3Text();
        }

        function updatePhase2Text() {
            if (!appState.currentPhasePrompts) return;
            const asisCode = document.getElementById('asis-editor')?.value || document.getElementById('editor').value || '';
            let text = appState.currentPhasePrompts.phase2.replace('{{ASIS_CODE}}', asisCode || '（As-Isエディタにコードを入力してください）');

            // アノテーションがあれば追加コンテキストとして付加
            const anns = annotationManager.annotations.asis.length > 0 ? annotationManager.annotations.asis : annotationManager.annotations.single;
            if (anns.length > 0) {
                const annotationContext = '\n\n【参考】コンサルタントが現場で発見したメモ：\n' +
                    anns.map(a => `- 【${CATEGORY_LABELS[a.category]}】${a.nodeText}: ${a.comment}`).join('\n') +
                    '\n\n上記の現場メモも考慮に入れて分析してください。';
                text += annotationContext;
            }

            document.getElementById('phase2-text').textContent = text;
        }

        function updatePhase3Text() {
            if (!appState.currentPhasePrompts) return;
            const asisCode = document.getElementById('asis-editor')?.value || document.getElementById('editor').value || '';
            const issues = document.getElementById('issues-input').value.trim() || '（上の入力欄に課題を箇条書きで入力してください）';
            const text = appState.currentPhasePrompts.phase3
                .replace('{{ASIS_CODE}}', asisCode || '（As-Isエディタにコードを入力してください）')
                .replace('{{ISSUES}}', issues);
            document.getElementById('phase3-text').textContent = text;
        }

        // ========== モーダル関連イベント ==========
        function initModalEvents() {
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modal.classList.remove('modal-open');
            });

            // フェーズタブのイベント
            document.querySelectorAll('.phase-tab').forEach(tab => {
                tab.addEventListener('click', () => switchPhase(parseInt(tab.dataset.phase)));
            });

            // 課題入力のリアルタイム反映
            document.getElementById('issues-input').addEventListener('input', updatePhase3Text);

            document.getElementById('copy-prompt-btn').addEventListener('click', () => {
                if (!appState.currentPhasePrompts) {
                    showAlert('コピーするプロンプトがありません', 'warning');
                    return;
                }

                let text;
                if (appState.activePhase === 1) text = document.getElementById('phase1-text').textContent;
                else if (appState.activePhase === 2) text = document.getElementById('phase2-text').textContent;
                else text = document.getElementById('phase3-text').textContent;

                navigator.clipboard.writeText(text).then(() => {
                    const btn = document.getElementById('copy-prompt-btn');
                    const originalText = btn.textContent;
                    btn.textContent = 'コピーしました!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(() => {
                    showAlert('クリップボードへのコピーに失敗しました', 'error');
                });
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('modal-open');
                }
            });
        }

        // === 比較モード関連の関数 ===

        // ========== 比較モード関連イベント ==========
        function initCompareModeEvents() {
            // モード切替
            modeSingle.addEventListener('click', () => {
                singleMode.classList.remove('hidden');
                compareMode.classList.add('hidden');
                modeSingle.classList.add('active');
                modeCompare.classList.remove('active');
            });

            modeCompare.addEventListener('click', () => {
                singleMode.classList.add('hidden');
                compareMode.classList.remove('hidden');
                modeCompare.classList.add('active');
                modeSingle.classList.remove('active');
            });
        }

        // 比較モードのプレビュー更新関数
        async function renderComparePreview(editorEl, previewEl) {
            const code = editorEl.value.trim();
            if (!code) {
                const isAsis = editorEl === asisEditor;
                const titleText = isAsis ? 'As-Is（現状）のフロー図が' : 'To-Be（改善後）のフロー図が';
                previewEl.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-warm-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 5h4v4H4zM16 5h4v4h-4zM10 15h4v4h-4zM6 9v2a2 2 0 002 2h2M18 9v2a2 2 0 01-2 2h-2M12 13v2"/>
                        </svg>
                        <p class="text-warm-gray-300 text-sm">${titleText}ここに表示されます</p>
                    </div>
                `;
                return;
            }
            try {
                previewEl.innerHTML = PREVIEW_LOADING_HTML;
                // 比較モードのテーマを使用
                mermaid.initialize({
                    startOnLoad: false,
                    theme: appState.compareTheme,
                    securityLevel: 'loose'
                });
                const { svg } = await mermaid.render('mermaid-svg-' + appState.renderCount++, code);
                previewEl.innerHTML = svg;

                // アノテーション機能を適用
                const target = previewEl === asisPreview ? 'asis' : 'tobe';
                if (annotationManager.compareAnnotationMode) {
                    annotationManager.attachNodeListeners(previewEl, target);
                }
                annotationManager.applyAnnotationStyles(target);
            } catch (error) {
                previewEl.innerHTML = '<p class="text-red-500 text-sm">記法エラー: 正しいMermaid記法を入力してください</p>';
            }
        }

        function initCompareEditorEvents() {
            // As-Isエディタの入力イベント
            asisEditor.addEventListener('input', () => {
                clearTimeout(appState.asisDebounce);
                appState.asisDebounce = setTimeout(() => renderComparePreview(asisEditor, asisPreview), DEBOUNCE_MS);
            });

            // To-Beエディタの入力イベント
            tobeEditor.addEventListener('input', () => {
                clearTimeout(appState.tobeDebounce);
                appState.tobeDebounce = setTimeout(() => renderComparePreview(tobeEditor, tobePreview), DEBOUNCE_MS);
            });

            // As-Isからコピーボタン
            document.getElementById('copy-asis-to-tobe').addEventListener('click', () => {
                tobeEditor.value = asisEditor.value;
                renderComparePreview(tobeEditor, tobePreview);
            });

            // As-Isテンプレート選択
            asisTemplateSelect.addEventListener('change', (e) => {
                if (e.target.value !== '') {
                    const index = parseInt(e.target.value);
                    const template = templates[index];
                    asisEditor.value = template.mermaid;
                    renderComparePreview(asisEditor, asisPreview);
                    showModal(template.name, template.prompt);
                }
            });
        }

        // ヘルパー関数: コードコピー
        function setupCopyBtn(btnId, editorEl) {
            document.getElementById(btnId).addEventListener('click', () => {
                const code = editorEl.value;
                if (!code.trim()) {
                    showAlert('コピーするコードがありません', 'warning');
                    return;
                }
                navigator.clipboard.writeText(code).then(() => {
                    const btn = document.getElementById(btnId);
                    const originalText = btn.textContent;
                    btn.textContent = 'コピーしました!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(() => {
                    showAlert('クリップボードへのコピーに失敗しました', 'error');
                });
            });
        }

        // ヘルパー関数: クリア
        function setupClearBtn(btnId, editorEl, previewEl, placeholderText) {
            document.getElementById(btnId).addEventListener('click', () => {
                showConfirm('エディタとプレビューをクリアしますか？', () => {
                    editorEl.value = '';
                    // Use simple placeholder for compare mode previews
                    previewEl.innerHTML = `<p class="text-warm-gray-400 text-sm">${placeholderText}</p>`;
                });
            });
        }

        // ヘルパー関数: PNGダウンロード
        function setupPngDownload(btnId, previewEl, filename) {
            document.getElementById(btnId).addEventListener('click', () => {
                const svg = previewEl.querySelector('svg');
                if (!svg) {
                    showAlert('ダウンロードする図がありません', 'warning');
                    return;
                }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const svgData = new XMLSerializer().serializeToString(svg);
                const img = new Image();

                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                img.onload = () => {
                    canvas.width = img.width * 2;
                    canvas.height = img.height * 2;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob((blob) => {
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = URL.createObjectURL(blob);
                        link.click();
                        URL.revokeObjectURL(url);
                    });
                };

                img.src = url;
            });
        }

        // ヘルパー関数: SVGダウンロード
        function setupSvgDownload(btnId, previewEl, filename) {
            document.getElementById(btnId).addEventListener('click', () => {
                const svg = previewEl.querySelector('svg');
                if (!svg) {
                    showAlert('ダウンロードする図がありません', 'warning');
                    return;
                }

                const svgData = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = filename;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            });
        }

        function initCompareButtonEvents() {
            // As-Is用ボタンのセットアップ
            setupCopyBtn('asis-copy-btn', asisEditor);
            setupClearBtn('asis-clear-btn', asisEditor, asisPreview, 'As-Is図がここに表示されます');
            setupPngDownload('asis-png-btn', asisPreview, 'mermaid-asis.png');
            setupSvgDownload('asis-svg-btn', asisPreview, 'mermaid-asis.svg');

            // To-Be用ボタンのセットアップ
            setupCopyBtn('tobe-copy-btn', tobeEditor);
            setupClearBtn('tobe-clear-btn', tobeEditor, tobePreview, 'To-Be図がここに表示されます');
            setupPngDownload('tobe-png-btn', tobePreview, 'mermaid-tobe.png');
            setupSvgDownload('tobe-svg-btn', tobePreview, 'mermaid-tobe.svg');

            // 比較モードのテーマ切替
            compareThemeSelect.addEventListener('change', async (e) => {
                appState.compareTheme = e.target.value;
                mermaid.initialize({
                    startOnLoad: false,
                    theme: compareTheme,
                    securityLevel: 'loose'
                });
                // 両方のプレビューを再レンダリング
                await renderComparePreview(asisEditor, asisPreview);
                await renderComparePreview(tobeEditor, tobePreview);
            });
        }

        // ========== ナビゲーション関連イベント ==========
        function initNavigationEvents() {
            const menuToggle = document.getElementById('menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            menuToggle.addEventListener('click', () => {
                mobileMenu.classList.toggle('menu-open');
            });
            const mobileLinks = mobileMenu.querySelectorAll('a');
            mobileLinks.forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.remove('menu-open');
                });
            });
        }

        // === LocalStorage保存機能 ===

        // ========== プロジェクト関連イベント ==========
        function initProjectEvents() {
            // 保存ボタン
            document.getElementById('save-btn').addEventListener('click', () => {
                const name = document.getElementById('project-name').value.trim();
                if (!name) {
                    showAlert('プロジェクト名を入力してください', 'warning');
                    return;
                }

                const project = {
                    name: name,
                    savedAt: new Date().toISOString(),
                    singleEditor: editor.value,
                    asisEditor: asisEditor.value,
                    tobeEditor: tobeEditor.value,
                    annotations: annotationManager.getAnnotationsForSave()
                };

                let projects = JSON.parse(localStorage.getItem('mermaid-projects') || '[]');
                const existingIndex = projects.findIndex(p => p.name === name);

                const saveProject = () => {
                    if (existingIndex >= 0) {
                        projects[existingIndex] = project;
                    } else {
                        projects.push(project);
                    }
                    localStorage.setItem('mermaid-projects', JSON.stringify(projects));
                    renderProjectList();

                    const btn = document.getElementById('save-btn');
                    const originalText = btn.textContent;
                    btn.textContent = '保存しました!';
                    setTimeout(() => btn.textContent = originalText, 2000);
                };

                if (existingIndex >= 0) {
                    showConfirm(`「${name}」を上書きしますか？`, saveProject);
                } else {
                    saveProject();
                }
            });
        }

        // プロジェクト一覧を描画
        function renderProjectList() {
            const projects = JSON.parse(localStorage.getItem('mermaid-projects') || '[]');
            const savedProjectsSection = document.getElementById('saved-projects');
            const projectList = document.getElementById('project-list');

            if (projects.length === 0) {
                savedProjectsSection.classList.add('hidden');
                return;
            }

            savedProjectsSection.classList.remove('hidden');

            // ヘッダーの件数更新
            document.getElementById('project-count').textContent = `（${projects.length}件）`;

            projectList.innerHTML = '';

            projects.forEach((project, index) => {
                const date = new Date(project.savedAt);
                const formattedDate = date.toLocaleString('ja-JP');

                const hasAsis = !!(project.asisEditor && project.asisEditor.trim());
                const hasTobe = !!(project.tobeEditor && project.tobeEditor.trim());
                const annotationCount = project.annotations
                    ? (project.annotations.single?.length || 0) + (project.annotations.asis?.length || 0) + (project.annotations.tobe?.length || 0)
                    : 0;

                // ミニプレビュー（最初の3行程度）
                const previewCode = (project.asisEditor || project.singleEditor || '').split('\n').slice(0, 3).join('\n');

                const card = document.createElement('div');
                card.className = 'bg-white p-5 elevation-0 rounded-lg project-card';
                card.dataset.projectId = index;
                card.innerHTML = `
                    <h4 class="font-medium text-warm-gray-800 text-sm mb-1">${project.name}</h4>
                    <p class="text-xs text-warm-gray-400 mb-3">${formattedDate}</p>

                    <!-- ステータスバッジ -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="text-xs px-2 py-0.5 rounded-full ${hasAsis ? 'bg-rose-50 text-rose-600 border border-rose-200' : 'bg-warm-gray-50 text-warm-gray-400 border border-warm-gray-200'}">
                            As-Is ${hasAsis ? '✓' : '—'}
                        </span>
                        <span class="text-xs px-2 py-0.5 rounded-full ${hasTobe ? 'bg-navy-50 text-navy-600 border border-navy-200' : 'bg-warm-gray-50 text-warm-gray-400 border border-warm-gray-200'}">
                            To-Be ${hasTobe ? '✓' : '—'}
                        </span>
                        ${annotationCount > 0 ? `
                        <span class="text-xs px-2 py-0.5 rounded-full bg-amber-50 text-amber-600 border border-amber-200">
                            注釈 ${annotationCount}
                        </span>` : ''}
                    </div>

                    <!-- ミニプレビュー -->
                    ${previewCode ? `<pre class="text-xs text-warm-gray-300 bg-warm-gray-50 p-2 rounded mb-3 overflow-hidden max-h-12 leading-tight font-mono">${previewCode}</pre>` : ''}

                    <!-- アクションボタン -->
                    <div class="flex flex-wrap gap-2">
                        <button data-action="load" class="btn btn-sm btn-ghost">読み込み</button>
                        <button data-action="duplicate" class="btn btn-sm btn-ghost">複製</button>
                        <button data-action="export" class="btn btn-sm btn-navy">JSON</button>
                        <button data-action="delete" class="btn btn-sm btn-danger">削除</button>
                    </div>
                `;

                projectList.appendChild(card);
            });
        }

        function initProjectListEvents() {
            // Event delegation for project list
            document.getElementById('project-list').addEventListener('click', (e) => {
                const btn = e.target.closest('[data-action]');
                if (!btn) return;
                const projectId = btn.closest('[data-project-id]')?.dataset.projectId;
                if (!projectId) return;

                const action = btn.dataset.action;
                if (action === 'load') loadProject(parseInt(projectId));
                if (action === 'duplicate') duplicateProject(parseInt(projectId));
                if (action === 'export') exportProjectJSON(parseInt(projectId));
                if (action === 'delete') deleteProject(parseInt(projectId));
            });
        }

        // プロジェクト読み込み
        function loadProject(index) {
            const projects = JSON.parse(localStorage.getItem('mermaid-projects') || '[]');
            if (index < 0 || index >= projects.length) return;

            const project = projects[index];

            // エディタに値を復元
            editor.value = project.singleEditor || '';
            asisEditor.value = project.asisEditor || '';
            tobeEditor.value = project.tobeEditor || '';

            // プロジェクト名も復元
            document.getElementById('project-name').value = project.name;

            // アノテーションを復元
            if (project.annotations) {
                annotationManager.loadAnnotations(project.annotations);
            }

            // プレビュー更新
            updatePreview();
            renderComparePreview(asisEditor, asisPreview);
            renderComparePreview(tobeEditor, tobePreview);
        }

        // プロジェクト削除
        function deleteProject(index) {
            const projects = JSON.parse(localStorage.getItem('mermaid-projects') || '[]');
            if (index < 0 || index >= projects.length) return;

            const project = projects[index];
            showConfirm(`「${project.name}」を削除しますか？`, () => {
                projects.splice(index, 1);
                localStorage.setItem('mermaid-projects', JSON.stringify(projects));
                renderProjectList();
            });
        }

        // プロジェクト複製
        function duplicateProject(index) {
            const projects = JSON.parse(localStorage.getItem('mermaid-projects') || '[]');
            if (index < 0 || index >= projects.length) return;

            const original = projects[index];
            const copy = JSON.parse(JSON.stringify(original));
            copy.name = `${original.name} のコピー`;
            copy.savedAt = new Date().toISOString();

            projects.push(copy);
            localStorage.setItem('mermaid-projects', JSON.stringify(projects));
            renderProjectList();
        }

        // プロジェクトをJSONエクスポート
        function exportProjectJSON(index) {
            const projects = JSON.parse(localStorage.getItem('mermaid-projects') || '[]');
            const project = projects[index];
            if (!project) return;

            const data = JSON.stringify(project, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `${project.name || 'project'}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        // JSONファイルからプロジェクトをインポート
        function importProjectJSON(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const project = JSON.parse(e.target.result);
                    // Validate project structure
                    if (!project || typeof project !== 'object') {
                        showAlert('無効なプロジェクトファイルです', 'error');
                        return;
                    }
                    if (!project.name || typeof project.name !== 'string') {
                        showAlert('プロジェクト名が見つかりません', 'error');
                        return;
                    }
                    // Set defaults for missing properties
                    project.singleEditor = project.singleEditor || '';
                    project.asisEditor = project.asisEditor || '';
                    project.tobeEditor = project.tobeEditor || '';
                    project.annotations = project.annotations || { single: [], asis: [], tobe: [] };
                    if (!Array.isArray(project.annotations.single)) project.annotations.single = [];
                    if (!Array.isArray(project.annotations.asis)) project.annotations.asis = [];
                    if (!Array.isArray(project.annotations.tobe)) project.annotations.tobe = [];

                    let projects = JSON.parse(localStorage.getItem('mermaid-projects') || '[]');

                    // 同名プロジェクトがある場合は名前を変更
                    const existingNames = projects.map(p => p.name);
                    if (existingNames.includes(project.name)) {
                        project.name = `${project.name} (インポート)`;
                    }

                    project.savedAt = new Date().toISOString();
                    projects.push(project);
                    localStorage.setItem('mermaid-projects', JSON.stringify(projects));
                    renderProjectList();
                    showToast(`「${project.name}」をインポートしました`);
                } catch (err) {
                    showAlert('JSONファイルの読み込みに失敗しました', 'error');
                }
            };
            reader.readAsText(file);
        }

        // URL共有の生成
        function generateShareURL() {
            const data = {
                e: document.getElementById('editor').value,
                a: document.getElementById('asis-editor').value,
                t: document.getElementById('tobe-editor').value,
                n: document.getElementById('project-name').value.trim()
            };

            // LZ-Stringで圧縮してbase64エンコード
            if (typeof LZString !== 'undefined') {
                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
                const url = `${window.location.origin}${window.location.pathname}#s=${compressed}`;

                if (url.length > 8000) {
                    showAlert('データが大きすぎます（URL長: ' + url.length + '文字）。JSON形式でエクスポートしてください。', 'warning');
                    return null;
                }

                return url;
            } else {
                // LZ-Stringが読み込まれていない場合のフォールバック
                const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
                if (encoded.length > 2000) {
                    showAlert('データが大きすぎます。JSON形式でエクスポートしてください。', 'warning');
                    return null;
                }
                const url = `${window.location.origin}${window.location.pathname}#share=${encoded}`;
                return url;
            }
        }

        // ページロード時にURL復元
        function restoreFromURL() {
            const hash = window.location.hash;

            // 新形式 (#s=...) - LZ-String圧縮
            if (hash.startsWith('#s=')) {
                try {
                    const compressed = hash.substring(3);
                    if (typeof LZString !== 'undefined') {
                        const data = JSON.parse(LZString.decompressFromEncodedURIComponent(compressed));
                        if (data.e) document.getElementById('editor').value = data.e;
                        if (data.a) document.getElementById('asis-editor').value = data.a;
                        if (data.t) document.getElementById('tobe-editor').value = data.t;
                        if (data.n) document.getElementById('project-name').value = data.n;

                        updatePreview();
                        renderComparePreview(asisEditor, asisPreview);
                        renderComparePreview(tobeEditor, tobePreview);

                        if (data.a || data.t) {
                            singleMode.classList.add('hidden');
                            compareMode.classList.remove('hidden');
                            modeCompare.classList.add('active');
                            modeSingle.classList.remove('active');
                        }
                    }
                } catch (err) {
                    console.warn('URL共有データの復元に失敗:', err);
                }
            }
            // 旧形式 (#share=...) の後方互換性
            else if (hash.startsWith('#share=')) {
                try {
                    const encoded = hash.substring(7);
                    const data = JSON.parse(decodeURIComponent(atob(encoded)));
                    if (data.e) document.getElementById('editor').value = data.e;
                    if (data.a) document.getElementById('asis-editor').value = data.a;
                    if (data.t) document.getElementById('tobe-editor').value = data.t;

                    updatePreview();
                    renderComparePreview(asisEditor, asisPreview);
                    renderComparePreview(tobeEditor, tobePreview);

                    if (data.a || data.t) {
                        singleMode.classList.add('hidden');
                        compareMode.classList.remove('hidden');
                        modeCompare.classList.add('active');
                        modeSingle.classList.remove('active');
                    }
                } catch (err) {
                    console.warn('URL共有データの復元に失敗:', err);
                }
            }
        }

        // === 共有モーダル ===
        const shareModal = document.getElementById('share-modal');

        // ========== 共有関連イベント ==========
        function initShareEvents() {
            document.getElementById('close-share-modal').addEventListener('click', closeShareModal);
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) closeShareModal();
            });

            document.getElementById('copy-share-url').addEventListener('click', () => {
                const urlInput = document.getElementById('share-url-display');
                urlInput.select();
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    const btn = document.getElementById('copy-share-url');
                    const originalText = btn.textContent;
                    btn.textContent = 'コピー済み!';
                    setTimeout(() => btn.textContent = originalText, 2000);
                }).catch(() => {
                    showAlert('クリップボードへのコピーに失敗しました', 'error');
                });
            });

            document.getElementById('download-qr').addEventListener('click', () => {
                const qrCanvas = document.querySelector('#share-qr-code canvas');
                if (!qrCanvas) {
                    showAlert('QRコードが生成されていません', 'warning');
                    return;
                }
                const link = document.createElement('a');
                link.download = 'mermaid-share-qr.png';
                link.href = qrCanvas.toDataURL('image/png');
                link.click();
            });

            document.getElementById('share-json-export').addEventListener('click', () => {
                const projectName = getProjectName('project');
                const data = {
                    name: projectName,
                    savedAt: new Date().toISOString(),
                    singleEditor: document.getElementById('editor').value,
                    asisEditor: document.getElementById('asis-editor').value,
                    tobeEditor: document.getElementById('tobe-editor').value,
                    annotations: annotationManager ? annotationManager.getAnnotationsForSave() : null
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `${projectName}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            });

            // JSONインポートボタンのイベントリスナー
            document.getElementById('import-json-btn').addEventListener('click', () => {
                document.getElementById('import-json-input').click();
            });

            document.getElementById('import-json-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importProjectJSON(file);
                    e.target.value = ''; // リセット
                }
            });

            // URL共有ボタンのイベントリスナー
            document.getElementById('share-url-btn').addEventListener('click', () => {
                openShareModal();
            });
        }

        function openShareModal() {
            const url = generateShareURL();
            if (!url) return;

            // URL表示
            document.getElementById('share-url-display').value = url;
            document.getElementById('share-url-size').textContent = `URL長: ${url.length}文字`;

            // QRコード生成
            const qrContainer = document.getElementById('share-qr-code');
            qrContainer.innerHTML = '';

            if (url.length <= 4000 && typeof QRCode !== 'undefined') {
                new QRCode(qrContainer, {
                    text: url,
                    width: 180,
                    height: 180,
                    colorDark: '#292524',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.L
                });
            } else if (typeof QRCode === 'undefined') {
                qrContainer.innerHTML = '<p class="text-xs text-warm-gray-400 py-8">QRコードライブラリの読み込みに<br>失敗しました</p>';
            } else {
                qrContainer.innerHTML = '<p class="text-xs text-warm-gray-400 py-8">URLが長すぎるためQRコードを<br>生成できません。<br>JSON共有をご利用ください。</p>';
            }

            shareModal.classList.remove('hidden');
            const shareContent = shareModal.querySelector(':scope > div > div');
            if (shareContent) {
                shareContent.classList.remove('modal-enter');
                void shareContent.offsetWidth;
                shareContent.classList.add('modal-enter');
            }
            document.body.style.overflow = 'hidden';
        }

        function closeShareModal() {
            shareModal.classList.add('hidden');
            document.body.style.overflow = '';
        }


        // ========== イベントリスナー初期化 ==========
        initEditorEvents();
        initEditorButtonEvents();
        initModalEvents();
        initCompareModeEvents();
        initCompareEditorEvents();
        initCompareButtonEvents();
        initNavigationEvents();
        initProjectEvents();
        initProjectListEvents();
        initShareEvents();
        initReportEvents();

        // ページ読み込み時にプロジェクト一覧を表示
        renderProjectList();

        // ページ読み込み時にURL復元
        restoreFromURL();

        // === PDF レポート生成 ===
        function createPDFCanvas(width = 2970, height = 2100) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            return { canvas, ctx };
        }

        // PDF デザインヘルパー
        function pdfAccentBar(ctx, cw) {
            ctx.fillStyle = '#47658a';
            ctx.fillRect(0, 0, cw, 14);
        }

        function pdfFooter(ctx, cw, ch) {
            ctx.fillStyle = '#f5f5f4';
            ctx.fillRect(0, ch - 90, cw, 90);
            ctx.strokeStyle = '#e7e5e4';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, ch - 90); ctx.lineTo(cw, ch - 90); ctx.stroke();
            ctx.fillStyle = '#a8a29e';
            ctx.font = '26px "Noto Sans JP", sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('AYCC - AI YASUDA CREATIVE & CONSULTING', cw / 2, ch - 35);
        }

        function pdfDivider(ctx, x1, x2, y, color = '#d6d3d1') {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y); ctx.stroke();
        }

        function pdfRoundRect(ctx, x, y, w, h, r) {
            ctx.beginPath(); ctx.roundRect(x, y, w, h, r); ctx.fill();
        }

        function renderPDFCoverPage(pdf, projectName, pageWidth, pageHeight) {
            const { canvas, ctx } = createPDFCanvas();
            const cw = 2970, ch = 2100;

            // アクセントバー
            pdfAccentBar(ctx, cw);

            // 下部背景セクション
            ctx.fillStyle = '#fafaf9';
            ctx.fillRect(0, ch * 0.62, cw, ch * 0.38);
            pdfDivider(ctx, 0, cw, ch * 0.62, '#e7e5e4');

            // サブタイトル
            ctx.fillStyle = '#78716c';
            ctx.font = '36px "Noto Sans JP", sans-serif';
            ctx.textAlign = 'center';
            ctx.letterSpacing = '8px';
            ctx.fillText('BUSINESS FLOW IMPROVEMENT REPORT', cw / 2, 560);
            ctx.letterSpacing = '0px';

            // メインタイトル
            ctx.fillStyle = '#292524';
            ctx.font = 'bold 120px "Noto Serif JP", serif';
            ctx.fillText('業務フロー改善レポート', cw / 2, 780);

            // 装飾ディバイダー
            ctx.fillStyle = '#47658a';
            ctx.fillRect(cw / 2 - 180, 840, 360, 4);

            // プロジェクト名
            ctx.fillStyle = '#57534e';
            ctx.font = '60px "Noto Sans JP", sans-serif';
            ctx.fillText(projectName, cw / 2, 970);

            // 日付・社名（下部セクション）
            const today = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
            ctx.fillStyle = '#78716c';
            ctx.font = '40px "Noto Sans JP", sans-serif';
            ctx.fillText(today, cw / 2, ch * 0.62 + 140);

            // フッター
            pdfFooter(ctx, cw, ch);

            pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pageWidth, pageHeight);
        }

        async function renderPDFDiagramPage(pdf, svg, title, titleColor, pageWidth, pageHeight) {
            let img;
            try {
                img = await svgToImagePromise(svg);
                if (!img || img.width <= 0 || img.height <= 0) throw new Error('empty');
            } catch (error) {
                console.error('SVG rendering error:', error);
                pdf.addPage();
                const { canvas, ctx } = createPDFCanvas();
                ctx.fillStyle = '#a8a29e';
                ctx.font = '40px "Noto Sans JP", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('（図の描画に失敗しました）', 1485, 1050);
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pageWidth, pageHeight);
                return;
            }

            // アスペクト比で向きを自動選択
            const imgAspect = img.width / img.height;
            const usePortrait = imgAspect < 0.9;
            const pw = usePortrait ? 210 : 297;
            const ph = usePortrait ? 297 : 210;
            const cw = usePortrait ? 2100 : 2970;
            const ch = usePortrait ? 2970 : 2100;
            const titleH = 300;
            const margin = 100;
            const usableW = cw - margin * 2;
            const usableH = ch - titleH - margin;

            // 幅に合わせたスケールで高さを計算
            const scaleW = usableW / img.width;
            const fittedH = img.height * scaleW;

            const footerH = 104;
            const usableHNet = usableH - footerH;

            if (fittedH <= usableHNet) {
                // 1ページに収まる
                pdf.addPage('a4', usePortrait ? 'portrait' : 'landscape');
                const { canvas, ctx } = createPDFCanvas(cw, ch);
                pdfAccentBar(ctx, cw);
                ctx.fillStyle = titleColor;
                ctx.font = 'bold 70px "Noto Serif JP", serif';
                ctx.textAlign = 'center';
                ctx.fillText(title, cw / 2, 180);
                pdfDivider(ctx, cw / 2 - 200, cw / 2 + 200, 220, titleColor);
                const x = (cw - img.width * scaleW) / 2;
                const y = titleH + (usableHNet - fittedH) / 2;
                ctx.drawImage(img, x, y, img.width * scaleW, fittedH);
                pdfFooter(ctx, cw, ch);
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pw, ph);
            } else {
                // 複数ページに分割
                const firstSliceH = (ch - titleH - margin - footerH) / scaleW;
                const laterSliceH = (ch - margin * 2 - footerH) / scaleW;
                const totalPages = 1 + Math.max(0, Math.ceil((img.height - firstSliceH) / laterSliceH));

                let srcY = 0;
                for (let p = 0; p < totalPages; p++) {
                    pdf.addPage('a4', usePortrait ? 'portrait' : 'landscape');
                    const { canvas, ctx } = createPDFCanvas(cw, ch);
                    pdfAccentBar(ctx, cw);
                    let contentY;

                    if (p === 0) {
                        ctx.fillStyle = titleColor;
                        ctx.font = 'bold 70px "Noto Serif JP", serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(title, cw / 2, 180);
                        pdfDivider(ctx, cw / 2 - 200, cw / 2 + 200, 220, titleColor);
                        contentY = titleH;
                    } else {
                        ctx.fillStyle = '#78716c';
                        ctx.font = '30px "Noto Sans JP", sans-serif';
                        ctx.textAlign = 'right';
                        ctx.fillText(`${title}（${p + 1}/${totalPages}）`, cw - margin, 50);
                        contentY = 80;
                    }

                    const maxSrcH = p === 0 ? firstSliceH : laterSliceH;
                    const srcH = Math.min(maxSrcH, img.height - srcY);
                    const drawH = srcH * scaleW;
                    const x = (cw - img.width * scaleW) / 2;
                    ctx.drawImage(img, 0, srcY, img.width, srcH, x, contentY, img.width * scaleW, drawH);
                    srcY += srcH;

                    pdfFooter(ctx, cw, ch);
                    pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pw, ph);
                }
            }
        }

        function renderPDFIssuesPages(pdf, annotations, pageWidth, pageHeight) {
            const cw = 2970, ch = 2100;
            const maxRows = 10;
            const totalPages = Math.ceil(annotations.length / maxRows);

            for (let page = 0; page < totalPages; page++) {
                pdf.addPage();
                const { canvas, ctx } = createPDFCanvas();

                pdfAccentBar(ctx, cw);

                // タイトル
                ctx.fillStyle = '#292524';
                ctx.font = 'bold 70px "Noto Serif JP", serif';
                ctx.textAlign = 'center';
                const pageLabel = totalPages > 1 ? `発見された課題（${page + 1}/${totalPages}）` : '発見された課題';
                ctx.fillText(pageLabel, cw / 2, 170);
                pdfDivider(ctx, 200, 2770, 210, '#47658a');

                let y = 310;
                const rowHeight = 135;

                // テーブルヘッダー背景
                ctx.fillStyle = '#f5f5f4';
                ctx.fillRect(150, y - 45, 2670, 65);
                ctx.font = 'bold 36px "Noto Sans JP", sans-serif';
                ctx.fillStyle = '#78716c';
                ctx.textAlign = 'left';
                ctx.fillText('カテゴリ', 220, y);
                ctx.fillText('対象ノード', 680, y);
                ctx.fillText('コメント', 1280, y);
                y += 50;
                pdfDivider(ctx, 150, 2820, y, '#d6d3d1');
                y += 35;

                const pageAnnotations = annotations.slice(page * maxRows, (page + 1) * maxRows);
                pageAnnotations.forEach((ann, i) => {
                    // 交互行背景
                    if (i % 2 === 1) {
                        ctx.fillStyle = '#fafaf9';
                        ctx.fillRect(150, y - 40, 2670, rowHeight);
                    }

                    // カテゴリバッジ
                    const catColor = CATEGORY_COLORS[ann.category];
                    ctx.save();
                    ctx.globalAlpha = 0.15;
                    ctx.fillStyle = catColor;
                    pdfRoundRect(ctx, 190, y - 28, 380, 50, 8);
                    ctx.restore();
                    ctx.fillStyle = catColor;
                    ctx.font = 'bold 34px "Noto Sans JP", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(CATEGORY_LABELS[ann.category], 380, y + 5);

                    // 対象ノード
                    ctx.fillStyle = '#292524';
                    ctx.font = '34px "Noto Sans JP", sans-serif';
                    ctx.textAlign = 'left';
                    const nodeText = ann.nodeText.length > 22 ? ann.nodeText.substring(0, 22) + '…' : ann.nodeText;
                    ctx.fillText(nodeText, 680, y + 5);

                    // コメント
                    ctx.fillStyle = '#57534e';
                    const comment = ann.comment.length > 42 ? ann.comment.substring(0, 42) + '…' : ann.comment;
                    ctx.fillText(comment, 1280, y + 5);

                    // 行区切り線
                    pdfDivider(ctx, 190, 2770, y + rowHeight - 45, '#e7e5e4');
                    y += rowHeight;
                });

                pdfFooter(ctx, cw, ch);
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pageWidth, pageHeight);
            }
        }

        function renderPDFSummaryPage(pdf, annotations, pageWidth, pageHeight) {
            const cw = 2970, ch = 2100;
            pdf.addPage();
            const { canvas, ctx } = createPDFCanvas();

            pdfAccentBar(ctx, cw);

            // タイトル
            ctx.fillStyle = '#292524';
            ctx.font = 'bold 70px "Noto Serif JP", serif';
            ctx.textAlign = 'center';
            ctx.fillText('まとめ', cw / 2, 170);
            pdfDivider(ctx, cw / 2 - 120, cw / 2 + 120, 210, '#47658a');

            const problems = annotations.filter(a => a.category === 'problem');
            const improvements = annotations.filter(a => a.category === 'improvement');
            const questions = annotations.filter(a => a.category === 'question');
            const memos = annotations.filter(a => a.category === 'memo');

            // 統計カウンター
            const stats = [
                { label: '問題点', count: problems.length, color: '#ef4444' },
                { label: '改善提案', count: improvements.length, color: '#3b82f6' },
                { label: '質問', count: questions.length, color: '#d97706' },
                { label: 'メモ', count: memos.length, color: '#6b7280' }
            ];
            const statW = 500, statH = 100, statGap = 60;
            const statTotalW = stats.length * statW + (stats.length - 1) * statGap;
            let sx = (cw - statTotalW) / 2;
            const sy = 290;

            stats.forEach(s => {
                // カード背景
                ctx.fillStyle = '#fafaf9';
                pdfRoundRect(ctx, sx, sy, statW, statH, 12);
                ctx.strokeStyle = '#e7e5e4';
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.roundRect(sx, sy, statW, statH, 12); ctx.stroke();
                // 色付きインジケーター
                ctx.fillStyle = s.color;
                pdfRoundRect(ctx, sx + 20, sy + 30, 8, 40, 4);
                // カウント
                ctx.fillStyle = '#292524';
                ctx.font = 'bold 48px "Noto Sans JP", sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(String(s.count), sx + 50, sy + 68);
                // ラベル
                ctx.fillStyle = '#78716c';
                ctx.font = '30px "Noto Sans JP", sans-serif';
                ctx.fillText(s.label, sx + 120, sy + 65);
                sx += statW + statGap;
            });

            let y = 500;
            ctx.textAlign = 'left';

            if (problems.length > 0) {
                // セクション背景カード
                const cardH = 90 + Math.min(problems.length, 5) * 80;
                ctx.fillStyle = '#fef2f2';
                pdfRoundRect(ctx, 200, y - 20, cw - 400, cardH, 16);

                ctx.fillStyle = '#be185d';
                ctx.font = 'bold 50px "Noto Serif JP", serif';
                ctx.fillText('主要な課題', 280, y + 40);
                y += 100;

                ctx.font = '40px "Noto Sans JP", sans-serif';
                problems.slice(0, 5).forEach(p => {
                    ctx.fillStyle = '#ef4444';
                    ctx.fillText('●', 320, y);
                    ctx.fillStyle = '#44403c';
                    const text = `${p.nodeText}: ${p.comment}`;
                    const displayText = text.length > 55 ? text.substring(0, 55) + '…' : text;
                    ctx.fillText(displayText, 410, y);
                    y += 80;
                });
                y += 50;
            }

            if (improvements.length > 0) {
                const cardH = 90 + Math.min(improvements.length, 5) * 80;
                ctx.fillStyle = '#eff6ff';
                pdfRoundRect(ctx, 200, y - 20, cw - 400, cardH, 16);

                ctx.fillStyle = '#3a5270';
                ctx.font = 'bold 50px "Noto Serif JP", serif';
                ctx.fillText('改善提案', 280, y + 40);
                y += 100;

                ctx.font = '40px "Noto Sans JP", sans-serif';
                improvements.slice(0, 5).forEach(i => {
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillText('●', 320, y);
                    ctx.fillStyle = '#44403c';
                    const text = `${i.nodeText}: ${i.comment}`;
                    const displayText = text.length > 55 ? text.substring(0, 55) + '…' : text;
                    ctx.fillText(displayText, 410, y);
                    y += 80;
                });
            }

            pdfFooter(ctx, cw, ch);
            pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pageWidth, pageHeight);
        }

        function getReportData() {
            const singleSvg = document.getElementById('preview-area').querySelector('svg');
            const asisSvg = document.getElementById('asis-preview').querySelector('svg');
            const tobeSvg = document.getElementById('tobe-preview').querySelector('svg');
            const isCompareMode = !document.getElementById('compare-mode').classList.contains('hidden');
            const mainSvg = isCompareMode ? asisSvg : singleSvg;
            const mainTitle = isCompareMode ? 'As-Is（現状フロー）' : '業務フロー';
            const annotations = isCompareMode
                ? (annotationManager?.annotations?.asis || [])
                : (annotationManager?.annotations?.single || []);
            return { singleSvg, asisSvg, tobeSvg, isCompareMode, mainSvg, mainTitle, annotations };
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                throw new Error('jsPDFライブラリの読み込みに失敗しました');
            }

            // フォント読み込みを待機してからCanvas描画
            await document.fonts.ready;

            const projectName = getProjectName('無題のプロジェクト');
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pageWidth = 297;
            const pageHeight = 210;

            const { tobeSvg, isCompareMode, mainSvg, mainTitle, annotations } = getReportData();
            if (!mainSvg) {
                throw new Error('レポートに含める図がありません。先に図を作成してください。');
            }

            renderPDFCoverPage(pdf, projectName, pageWidth, pageHeight);
            const mainColor = isCompareMode ? '#be185d' : '#292524';

            if (mainSvg) await renderPDFDiagramPage(pdf, mainSvg, mainTitle, mainColor, pageWidth, pageHeight);
            if (annotations.length > 0) renderPDFIssuesPages(pdf, annotations, pageWidth, pageHeight);

            if (isCompareMode && tobeSvg) await renderPDFDiagramPage(pdf, tobeSvg, 'To-Be（改善後フロー）', '#3a5270', pageWidth, pageHeight);

            if (annotations.length > 0) renderPDFSummaryPage(pdf, annotations, pageWidth, pageHeight);

            const safeName = sanitizeFilename(projectName);
            pdf.save(`report-${safeName}.pdf`);
        }

        // === プレゼンテーションモード ===
        const ISSUES_PER_SLIDE = 8;

        class PresentationMode {
            constructor() {
                this.currentSlide = 0;
                this.slides = [];
                this.overlay = document.getElementById('presentation-overlay');
                this.slideEl = document.getElementById('pres-slide');
                this.dotsEl = document.getElementById('pres-dots');
                this.isOpen = false;
                this.isAnimating = false;
                this.touchStartX = 0;
                this.init();
            }

            init() {
                document.getElementById('pres-close').addEventListener('click', () => this.close());
                document.getElementById('pres-prev').addEventListener('click', () => this.prev());
                document.getElementById('pres-next').addEventListener('click', () => this.next());

                document.addEventListener('keydown', (e) => {
                    if (!this.isOpen) return;
                    if (e.key === 'Escape') this.close();
                    if (e.key === 'ArrowRight' || e.key === ' ') {
                        e.preventDefault();
                        this.next();
                    }
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        this.prev();
                    }
                });

                // タッチスワイプ対応
                this.overlay.addEventListener('touchstart', (e) => {
                    this.touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });
                this.overlay.addEventListener('touchend', (e) => {
                    const diff = e.changedTouches[0].screenX - this.touchStartX;
                    if (Math.abs(diff) > 50) {
                        if (diff < 0) this.next();
                        else this.prev();
                    }
                }, { passive: true });
            }

            open() {
                this.buildSlides();
                if (this.slides.length <= 1) {
                    showAlert('レポートに含める図がありません。先に図を作成してください。', 'warning');
                    return;
                }
                const projectName = getProjectName('無題のプロジェクト');
                document.getElementById('pres-title').textContent = projectName;
                this.currentSlide = 0;
                this.isOpen = true;
                this.overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                this._buildDots();
                this.render();
            }

            close() {
                this.isOpen = false;
                this.overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            buildSlides() {
                const projectName = getProjectName('無題のプロジェクト');
                const today = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
                const { tobeSvg, isCompareMode, mainSvg, mainTitle, annotations } = getReportData();
                const mainTitleColor = isCompareMode ? 'text-rose-700' : 'text-warm-gray-800';

                this.slides = [];
                this.slides.push(this._buildTitleSlide(projectName, today));
                if (mainSvg) this.slides.push(this._buildDiagramSlide(mainSvg, mainTitle, mainTitleColor));
                if (annotations.length > 0) this._buildIssuesSlides(annotations).forEach(s => this.slides.push(s));
                if (isCompareMode && tobeSvg) this.slides.push(this._buildDiagramSlide(tobeSvg, 'To-Be（改善後フロー）', 'text-navy-700'));
                if (annotations.length > 0) this.slides.push(this._buildSummarySlide(annotations));
            }

            _buildTitleSlide(projectName, today) {
                return {
                    html: `
                        <div class="text-center py-8 md:py-16">
                            <p class="text-warm-gray-400 text-xs md:text-sm tracking-widest mb-6 md:mb-8">BUSINESS FLOW IMPROVEMENT</p>
                            <h1 class="font-elegant text-2xl md:text-4xl text-warm-gray-800 mb-4">業務フロー改善レポート</h1>
                            <div class="divider mb-6 md:mb-8"></div>
                            <p class="text-lg md:text-xl text-warm-gray-600 mb-8 md:mb-12">${escapeHTML(projectName)}</p>
                            <p class="text-xs md:text-sm text-warm-gray-400">${today}</p>
                            <p class="text-xs md:text-sm text-warm-gray-400 mt-2">AYCC - AI YASUDA CREATIVE & CONSULTING</p>
                        </div>
                    `
                };
            }

            _buildDiagramSlide(svg, title, titleColor) {
                return {
                    html: `
                        <h2 class="font-elegant text-xl md:text-2xl ${titleColor} mb-4 md:mb-6 text-center">${escapeHTML(title)}</h2>
                        <div class="flex justify-center items-center overflow-auto" style="max-height:calc(100% - 4rem)">${svg.outerHTML}</div>
                    `
                };
            }

            _buildIssuesSlides(annotations) {
                const pages = [];
                const totalPages = Math.ceil(annotations.length / ISSUES_PER_SLIDE);

                for (let page = 0; page < totalPages; page++) {
                    const pageAnns = annotations.slice(page * ISSUES_PER_SLIDE, (page + 1) * ISSUES_PER_SLIDE);
                    const pageLabel = totalPages > 1 ? `発見された課題（${page + 1}/${totalPages}）` : '発見された課題';

                    const rows = pageAnns.map(a => `
                        <tr class="border-b border-warm-gray-200">
                            <td class="py-2 md:py-3 px-2 md:px-4"><span style="color:${CATEGORY_COLORS[a.category]}" class="font-medium text-xs md:text-sm">${CATEGORY_LABELS[a.category]}</span></td>
                            <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm text-warm-gray-700">${escapeHTML(a.nodeText)}</td>
                            <td class="py-2 md:py-3 px-2 md:px-4 text-xs md:text-sm text-warm-gray-600">${escapeHTML(a.comment)}</td>
                        </tr>
                    `).join('');

                    pages.push({
                        html: `
                            <h2 class="font-elegant text-xl md:text-2xl text-warm-gray-800 mb-4 md:mb-6 text-center">${pageLabel}</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b-2 border-warm-gray-300">
                                            <th class="py-2 md:py-3 px-2 md:px-4 text-left text-xs md:text-sm text-warm-gray-500 w-20 md:w-24">カテゴリ</th>
                                            <th class="py-2 md:py-3 px-2 md:px-4 text-left text-xs md:text-sm text-warm-gray-500 w-28 md:w-40">対象</th>
                                            <th class="py-2 md:py-3 px-2 md:px-4 text-left text-xs md:text-sm text-warm-gray-500">コメント</th>
                                        </tr>
                                    </thead>
                                    <tbody>${rows}</tbody>
                                </table>
                            </div>
                        `
                    });
                }
                return pages;
            }

            _buildSummarySlide(annotations) {
                const improvements = annotations.filter(a => a.category === 'improvement');
                const problems = annotations.filter(a => a.category === 'problem');

                return {
                    html: `
                        <div class="py-4 md:py-8">
                            <h2 class="font-elegant text-xl md:text-2xl text-warm-gray-800 mb-6 md:mb-8 text-center">まとめ</h2>
                            ${problems.length > 0 ? `
                            <div class="mb-6 md:mb-8">
                                <h3 class="text-base md:text-lg text-rose-700 font-medium mb-3">主要な課題</h3>
                                <ul class="space-y-2">
                                    ${problems.map(p => `<li class="text-xs md:text-sm text-warm-gray-600 flex items-start gap-2"><span class="text-rose-500 mt-0.5">●</span><span>${escapeHTML(p.nodeText)}: ${escapeHTML(p.comment)}</span></li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            ${improvements.length > 0 ? `
                            <div class="mb-6 md:mb-8">
                                <h3 class="text-base md:text-lg text-navy-700 font-medium mb-3">改善提案</h3>
                                <ul class="space-y-2">
                                    ${improvements.map(i => `<li class="text-xs md:text-sm text-warm-gray-600 flex items-start gap-2"><span class="text-navy-500 mt-0.5">●</span><span>${escapeHTML(i.nodeText)}: ${escapeHTML(i.comment)}</span></li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            <div class="text-center mt-8 md:mt-12 pt-6 md:pt-8 border-t border-warm-gray-200">
                                <p class="text-xs md:text-sm text-warm-gray-400">AYCC - AI YASUDA CREATIVE & CONSULTING</p>
                            </div>
                        </div>
                    `
                };
            }

            _buildDots() {
                this.dotsEl.innerHTML = '';
                this.slides.forEach((_, i) => {
                    const dot = document.createElement('button');
                    dot.className = `pres-dot${i === this.currentSlide ? ' active' : ''}`;
                    dot.addEventListener('click', () => this.goTo(i));
                    this.dotsEl.appendChild(dot);
                });
            }

            _updateDots() {
                const dots = this.dotsEl.querySelectorAll('.pres-dot');
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === this.currentSlide);
                });
            }

            goTo(index) {
                if (index === this.currentSlide || this.isAnimating) return;
                this.isAnimating = true;

                // フェードアウト
                this.slideEl.classList.add('pres-slide-fade-out');
                setTimeout(() => {
                    this.currentSlide = index;
                    this._renderContent();
                    // フェードイン
                    requestAnimationFrame(() => {
                        this.slideEl.classList.remove('pres-slide-fade-out');
                        this.isAnimating = false;
                    });
                }, 200);
            }

            render() {
                this._renderContent();
            }

            _renderContent() {
                const slide = this.slides[this.currentSlide];
                this.slideEl.innerHTML = slide.html;
                document.getElementById('pres-page-indicator').textContent = `${this.currentSlide + 1} / ${this.slides.length}`;

                const svgs = this.slideEl.querySelectorAll('svg');
                svgs.forEach(svg => {
                    svg.style.maxWidth = '100%';
                    svg.style.height = 'auto';
                });

                document.getElementById('pres-prev').style.visibility = this.currentSlide === 0 ? 'hidden' : 'visible';
                document.getElementById('pres-next').style.visibility = this.currentSlide === this.slides.length - 1 ? 'hidden' : 'visible';
                this._updateDots();
            }

            next() {
                if (this.currentSlide < this.slides.length - 1) {
                    this.goTo(this.currentSlide + 1);
                }
            }

            prev() {
                if (this.currentSlide > 0) {
                    this.goTo(this.currentSlide - 1);
                }
            }
        }

        const presentationMode = new PresentationMode();

        // ========== レポート関連イベント ==========
        function initReportEvents() {
            // PDF・プレゼンボタンのイベントリスナー
            document.getElementById('pdf-report-btn').addEventListener('click', async () => {
                const btn = document.getElementById('pdf-report-btn');
                const originalText = btn.textContent;
                btn.textContent = '生成中...';
                btn.disabled = true;

                try {
                    await generatePDF();
                    btn.textContent = '完了!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('PDF generation error:', error);
                    showAlert(error.message || 'PDFの生成に失敗しました', 'error');
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            document.getElementById('presentation-btn').addEventListener('click', () => {
                presentationMode.open();
            });
        }

        // スクロールアニメーション
        const fadeElements = document.querySelectorAll('.fade-in-section');
        const fadeObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.1 });

        fadeElements.forEach(el => fadeObserver.observe(el));
    </script>

</body>
</html>
